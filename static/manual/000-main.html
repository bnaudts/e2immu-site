<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="description" content="Annotations and a code analyser in Java to support immutability">
<meta name="author" content="Bart Naudts">
<title>Effective and eventual immutability</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Effective and eventual immutability</h1>
<div class="details">
<span id="author" class="author">Bart Naudts</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_using_e2immu"><em>Using e2immu</em></a></li>
<li><a href="#_using_e2immu_2">1. Using e2immu</a>
<ul class="sectlevel2">
<li><a href="#_basic_use">1.1. Basic use</a></li>
<li><a href="#_full_flow">1.2. Full flow</a></li>
<li><a href="#_the_e2immu_analyser_command_line">1.3. The e2immu analyser command line</a></li>
<li><a href="#_using_the_gradle_plugin">1.4. Using the Gradle plugin</a></li>
</ul>
</li>
<li><a href="#_annotated_apis">2. Annotated APIs</a>
<ul class="sectlevel2">
<li><a href="#_preparing_an_annotatedapi_file">2.1. Preparing an AnnotatedAPI file</a></li>
<li><a href="#_the_file_format">2.2. The file format</a></li>
<li><a href="#_annotation_types">2.3. Annotation types</a></li>
</ul>
</li>
<li><a href="#_visualising_immutability">3. Visualising immutability</a>
<ul class="sectlevel2">
<li><a href="#inheritance-rules">3.1. Inheritance rules of annotations</a></li>
</ul>
</li>
<li><a href="#_reference"><em>Reference</em></a></li>
<li><a href="#_concepts">4. Concepts</a>
<ul class="sectlevel2">
<li><a href="#concept-modified">4.1. Modification</a></li>
<li><a href="#concept-containers">4.2. Containers</a></li>
<li><a href="#concept-linking">4.3. Linking and independence</a></li>
<li><a href="#_immutability">4.4. Immutability</a>
<ul class="sectlevel3">
<li><a href="#concept-e1immutable">4.4.1. Level 1 immutable</a></li>
<li><a href="#concept-implicitly-immutable">4.4.2. Implicitly immutable types</a></li>
<li><a href="#concept-e2immutable">4.4.3. Level 2 immutable</a></li>
<li><a href="#technical-dynamic-type-annotations">4.4.4. Dynamic type annotations</a></li>
</ul>
</li>
<li><a href="#concept-eventual">4.5. Eventual immutability</a></li>
<li><a href="#concept-higher-order-modification">4.6. Higher-order modifications</a></li>
<li><a href="#_miscellaneous">4.7. Miscellaneous</a>
<ul class="sectlevel3">
<li><a href="#concept-constant">4.7.1. Constants</a></li>
<li><a href="#concept-statement-time">4.7.2. Statement time</a></li>
<li><a href="#concept-singleton">4.7.3. Singleton classes</a></li>
<li><a href="#concept-utility-class">4.7.4. Utility classes</a></li>
<li><a href="#concept-extension-class">4.7.5. Extension classes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_overview_of_annotations">5. Overview of annotations</a>
<ul class="sectlevel2">
<li><a href="#_annotation_modes">5.1. Annotation modes</a></li>
<li><a href="#_inheritance_of_annotations">5.2. Inheritance of annotations</a></li>
<li><a href="#_list_of_annotations">5.3. List of annotations</a>
<ul class="sectlevel3">
<li><a href="#allowsInterrupt-annotation">5.3.1. @AllowsInterrupt</a></li>
<li><a href="#beforeMark-annotation">5.3.2. @BeforeMark</a></li>
<li><a href="#constant-annotation">5.3.3. @Constant</a></li>
<li><a href="#container-annotation">5.3.4. @Container</a></li>
<li><a href="#dependent-annotation">5.3.5. @Dependent</a></li>
<li><a href="#dependent1-annotation">5.3.6. @Dependent1</a></li>
<li><a href="#dependent2-annotation">5.3.7. @Dependent2</a></li>
<li><a href="#e1container-annotation">5.3.8. @E1Container</a></li>
<li><a href="#e1immutable-annotation">5.3.9. @E1Immutable</a></li>
<li><a href="#e2container-annotation">5.3.10. @E2Container</a></li>
<li><a href="#e2immutable-annotation">5.3.11. @E2Immutable</a></li>
<li><a href="#extensionClass-annotation">5.3.12. @ExtensionClass</a></li>
<li><a href="#final-annotation">5.3.13. @Final</a></li>
<li><a href="#_finalizer">5.3.14. @Finalizer</a></li>
<li><a href="#_fluent">5.3.15. @Fluent</a></li>
<li><a href="#_identity">5.3.16. @Identity</a></li>
<li><a href="#_ignoremodifications">5.3.17. @IgnoreModifications</a></li>
<li><a href="#_independent">5.3.18. @Independent</a></li>
<li><a href="#_linked">5.3.19. @Linked</a></li>
<li><a href="#_linked1">5.3.20. @Linked1</a></li>
<li><a href="#_mark">5.3.21. @Mark</a></li>
<li><a href="#modified-annotation">5.3.22. @Modified</a></li>
<li><a href="#modified1-annotation">5.3.23. @Modified1</a></li>
<li><a href="#mutableModifiesArguments-annotation">5.3.24. @MutableModifiesArguments</a></li>
<li><a href="#notModified-annotation">5.3.25. @NotModified</a></li>
<li><a href="#notModified1-annotation">5.3.26. @NotModified1</a></li>
<li><a href="#notNull-annotation">5.3.27. @NotNull</a></li>
<li><a href="#notNull1-annotation">5.3.28. @NotNull1</a></li>
<li><a href="#notNull2-annotation">5.3.29. @NotNull2</a></li>
<li><a href="#nullable-annotation">5.3.30. @Nullable</a></li>
<li><a href="#only-annotation">5.3.31. @Only</a></li>
<li><a href="#propagateModification-annotation">5.3.32. @PropagateModification</a></li>
<li><a href="#singleton-annotation">5.3.33. @Singleton</a></li>
<li><a href="#testMark-annotation">5.3.34. @TestMark</a></li>
<li><a href="#utilityClass-annotation">5.3.35. @UtilityClass</a></li>
<li><a href="#variable-annotation">5.3.36. @Variable</a></li>
</ul>
</li>
<li><a href="#annotation-hierarchy">5.4. Relations between annotations</a>
<ul class="sectlevel3">
<li><a href="#_on_types">5.4.1. On types</a></li>
<li><a href="#_on_fields">5.4.2. On fields</a></li>
<li><a href="#_on_constructors">5.4.3. On constructors</a></li>
<li><a href="#_on_methods">5.4.4. On methods</a></li>
<li><a href="#_on_parameters">5.4.5. On parameters</a></li>
<li><a href="#nullability">5.4.6. Nullability</a></li>
<li><a href="#_eventually_and_effectively_immutable">5.4.7. Eventually and effectively immutable</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_technical"><em>Technical</em></a></li>
<li><a href="#_the_analyser">6. The analyser</a>
<ul class="sectlevel2">
<li><a href="#_inspection">6.1. Inspection</a></li>
<li><a href="#_resolution">6.2. Resolution</a></li>
<li><a href="#_analyser_implementation">6.3. Analyser implementation</a>
<ul class="sectlevel3">
<li><a href="#_code_structure">6.3.1. Code structure</a></li>
<li><a href="#_circular_dependencies">6.3.2. Circular dependencies</a></li>
<li><a href="#_nested_classes">6.3.3. Nested classes</a></li>
<li><a href="#_modification_of_a_field">6.3.4. Modification of a field</a></li>
<li><a href="#_modification_of_a_method">6.3.5. Modification of a method</a></li>
<li><a href="#_condition_and_state">6.3.6. Condition and state</a></li>
<li><a href="#_computation_of_mark_only">6.3.7. Computation of @Mark, @Only</a></li>
<li><a href="#_statement_analyser">6.3.8. Statement analyser</a></li>
<li><a href="#_post_and_pre_conditions">6.3.9. Post- and pre-conditions</a></li>
<li><a href="#_nullity_of_fields">6.3.10. Nullity of fields</a></li>
<li><a href="#_loop_variables_overview">6.3.11. Loop variables overview</a></li>
<li><a href="#_general_property_computation">6.3.12. General property computation</a></li>
<li><a href="#_not_null_property">6.3.13. Not-null property</a></li>
<li><a href="#_modification_property">6.3.14. Modification property</a></li>
</ul>
</li>
<li><a href="#_variables">6.4. Variables</a>
<ul class="sectlevel3">
<li><a href="#_variable_fields">6.4.1. Variable fields</a></li>
<li><a href="#_different_variable_states">6.4.2. Different variable states</a></li>
<li><a href="#_data_stored_for_a_variable">6.4.3. Data stored for a variable</a></li>
<li><a href="#_tests_basics_0">6.4.4. Tests: Basics_0</a></li>
<li><a href="#_tests_basics_1">6.4.5. Tests: Basics_1</a></li>
<li><a href="#_tests_modification_0">6.4.6. Tests: Modification_0</a></li>
<li><a href="#_breaking_delays">6.4.7. Breaking delays</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_supporting_tools">7. Supporting tools</a>
<ul class="sectlevel2">
<li><a href="#_gradle_plugin">7.1. Gradle plugin</a></li>
<li><a href="#_key_value_store">7.2. Key-value store</a></li>
<li><a href="#_intellij_idea_plugin">7.3.  IntelliJ IDEA  plugin</a>
<ul class="sectlevel3">
<li><a href="#visual-objectives">7.3.1. Visual objectives</a></li>
<li><a href="#_information_flow">7.3.2. Information flow</a></li>
<li><a href="#_implementation">7.3.3. Implementation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_where_next"><em>Where next?</em></a></li>
<li><a href="#_copyright_and_license">8. Copyright and License</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_using_e2immu"><em>Using e2immu</em></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_using_e2immu_2">1. Using e2immu</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_basic_use">1.1. Basic use</h3>
<div class="paragraph">
<p>Starting your first project, basic use of the  <em>e2immu</em>  analyser looks like</p>
</div>
<div id="basic-use" class="imageblock">
<div class="content">
<img src="/Users/bnaudts/git/e2immu-documentation/src/docs/asciidoc/images/e2immu_basic_use.png" alt="e2immu basic use">
</div>
<div class="title">Figure 1. Basic use of e2immu</div>
</div>
<div class="paragraph">
<p>Having installed  <em>e2immu</em> 's IntelliJ IDEA plugin, and having started a local annotation server, you can edit your project, occasionally run the analyser, and make use of pre-annotated libraries.</p>
</div>
<div class="paragraph">
<p>The analyser produces computed annotations, errors and warnings, which you can of course read from the command line.
It also pushes these errors, warnings, and computed annotations to the annotation server, which is continuously consulted by the highlighter plugin.
So while you&#8217;re working on your project, each time you run the analyser, your editor is updated.
We&#8217;re suggesting that you confirm critical annotations in the source code.
They will get the annotation type <code>VERIFY</code> which is the default for source code read by the analyser, they allow you to 'stabilize' your code with respect to class types like  <code>@Container</code>  or
 <code>@E2Immutable</code> .</p>
</div>
<div class="paragraph">
<p>This set-up will get you pretty far, as long as</p>
</div>
<div class="ulist">
<ul>
<li>
<p>your project consists of a single set of source files</p>
</li>
<li>
<p>all the libraries you are using have been pre-annotated.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_full_flow">1.2. Full flow</h3>
<div class="paragraph">
<p>The  <em>e2immu</em>  analyser is set up to read, in order of decreasing priority,</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the source code of your project</p>
</li>
<li>
<p>annotated API sources, as a replacement for class files with XML annotations</p>
</li>
<li>
<p>class files and associated XML annotation files from jars, for libraries used in your project</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If your project is or becomes a library for other projects to use, the computed annotations have to be made available to the users of the library:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>for fast turn-around development on your own or in small teams, you can use the analyser run on the library.
This is depicted in <a href="#figure-fast-turnaround">Fast turnaround use of e2immu</a>.
to upload computed annotations to the annotation store, and instruct the analyser on the project consuming the library to consult this store.
For this purpose, the annotation store has the ability to store annotations in user-defined <em>projects</em>; the analyser can read from any such <em>projects</em>.</p>
</li>
<li>
<p>the standard procedure is for the computed annotations to be included in the <code>jar</code> file of the project:
the analyser can directly write <code>annotations.xml</code> files in the resources of your project, one for each package.
This action can take place after the compilation phase and before the packaging phase in you build tool.  <em>e2immu</em>  provides a plugin for Gradle for now.
This flow is depicted in <a href="#figure-annotated-xml-via-gradle">Add annotation.xml files to your jar</a>.</p>
</li>
</ol>
</div>
<div id="figure-fast-turnaround" class="imageblock">
<div class="content">
<img src="/Users/bnaudts/git/e2immu-documentation/src/docs/asciidoc/images/e2immu_fast_turnaround.png" alt="e2immu fast turnaround">
</div>
<div class="title">Figure 2. Fast turnaround use of e2immu</div>
</div>
<div id="figure-annotated-xml-via-gradle" class="imageblock">
<div class="content">
<img src="/Users/bnaudts/git/e2immu-documentation/src/docs/asciidoc/images/e2immu_annotated_xml_via_gradle.png" alt="e2immu annotated xml via gradle">
</div>
<div class="title">Figure 3. Add annotation.xml files to your jar</div>
</div>
<div class="paragraph">
<p>If you are annotating external libraries with  <em>e2immu</em>  annotations, there are two options</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>you can use the <em>external annotations</em> feature of IntelliJ IDEA to create annotations files.
These files are best grouped into a new jar file, on per library, which is to be included in the dependencies of your project.</p>
</li>
<li>
<p>you can use annotated API sources, a kind of Java source file which contains all the declarative aspects of the types you&#8217;ll be using.
These files are quick to create, provide a nice overview, and can be used in combination with the underlying JAR so that you only have to copy those declarations that you want to annotate.
Their main advantage is clarity: all types, fields, and methods <em>relevant to you</em> are close together, with their annotations</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Annotated API sources can be generated by the analyser from jars and XML annotations, presenting only those types, methods and fields that your project is using.</p>
</div>
<div class="paragraph">
<p>Updated annotation files can be generated by the analyser from the combination of annotated API sources and existing annotation files.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_e2immu_analyser_command_line">1.3. The e2immu analyser command line</h3>
<div class="paragraph">
<p>The input to the analyser is largely controlled by the following primary locations</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--source=&lt;dir&gt;</code>: the directories where <code>.java</code> sources are to be found.
They can be <code>:</code> or <code>,</code> separated; the argument can also be repeated.
When nothing is specified, the analyser assumes <code>src/main/java</code>.</p>
</li>
<li>
<p><code>--classpath=&lt;cp&gt;</code>: the classpath.
This classpath should include the <code>.class</code> files corresponding to the <code>.java</code> files presented to the analyser.
The format is as parsed by the JDK classpath: colon separated, with wildcards for multipe jar files in the same directory, containing jar files, <code>.class</code> files, or directories.
Multiple <code>--classpath</code> options may be present; all are concatenated.
When nothing is specified, <code>build/classes/java/main:build/resources/main</code> is assumed.</p>
</li>
<li>
<p><code>--jre=&lt;dir&gt;</code>: location of the JRE if a different one from the analyser&#8217;s is to be taken</p>
</li>
<li>
<p><code>--restrict-source=&lt;packages&gt;</code>: restrict the input to the following packages.
The parameter can be comma separated, with wildcards as detailed in the note below.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Maven or Gradle plugin typically takes care of correct values for source input and classpath.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then there are typical options like</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--quiet</code> (short <code>-q</code>): do not write warnings, errors, etc to the standard output.
They are still uploaded when the <code>--upload</code> option is activated.</p>
</li>
<li>
<p><code>--debug=&lt;logtargets&gt;</code>: log targets to activate for debug output</p>
</li>
<li>
<p><code>--ignore-errors</code>: do not end the analyser in an error state when errors have been raised by the analyser.
They are still uploaded when the <code>--upload</code> option is activated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following options are available to control the output to the annotation server:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--upload</code> (short: <code>-u</code>): upload annotations to an annotation server</p>
</li>
<li>
<p><code>--upload-url=&lt;url&gt;</code>, change the default URL which is <code><a href="http://localhost:8281" class="bare">http://localhost:8281</a></code></p>
</li>
<li>
<p><code>--upload-project=&lt;project&gt;</code>, change the default project which is <code>default</code></p>
</li>
<li>
<p><code>--upload-packages=&lt;packages&gt;</code>: a comma-separated list of package names for which annotations are to be uploaded.
The default is to upload all annotations of all types encountered during the parsing process.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following options are available to control the files written:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--write-annotation-xml</code> (short: <code>-w</code>): create annotation files to be included in the resources, and hence the jar of the project.</p>
</li>
<li>
<p><code>--write-annotation-xml-packages=&lt;packages&gt;</code>: a comma-separated list of package names for which annotation.xml files are to be written.
The default is to write them for all the packages of <code>.java</code> files parsed</p>
</li>
<li>
<p><code>--write-annotation-xml-dir=&lt;directory&gt;</code>: alternative location to write the Xml files.
Defaults to the resources directory of the project.</p>
</li>
<li>
<p><code>--write-annotated-api</code> (short: <code>-a</code>)</p>
</li>
<li>
<p><code>--write-annotated-api-packages=&lt;packages&gt;</code>: a comma-separated list of package names for which annotated API files are to be written.
The default is to write them for all the packages of <code>.java</code> files parsed</p>
</li>
<li>
<p><code>--write-annotated-api-dir=&lt;directory&gt;</code>: alternative location to write the annotated API files.
The default is the main directory of the project</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When describing packages, a dot at the end of a package name may be used to indicate the inclusion of all sub-packages.
The wildcard <code>java.</code> includes <code>java.lang</code>, <code>java.io</code>, etc.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_gradle_plugin">1.4. Using the Gradle plugin</h3>
<div class="paragraph">
<p>The easiest way to use the analyser is via the Gradle plugin.</p>
</div>
<div class="listingblock">
<div class="title">Example of <code>build.gradle</code> file</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">plugins {
    id <span class="string"><span class="delimiter">'</span><span class="content">java</span><span class="delimiter">'</span></span>
    id <span class="string"><span class="delimiter">'</span><span class="content">org.e2immu.analyser</span><span class="delimiter">'</span></span>
}

...

repositories {
    ...
}

dependencies {
   ...
}

e2immu {
    skipProject = <span class="predefined-constant">false</span>
    sourcePackages = <span class="string"><span class="delimiter">'</span><span class="content">org.e2immu.</span><span class="delimiter">'</span></span>
    jmods = <span class="string"><span class="delimiter">'</span><span class="content">java.base.jmod,java.se.jmod</span><span class="delimiter">'</span></span>
    jre = <span class="string"><span class="delimiter">'</span><span class="content">/Library/Java/JavaVirtualMachines/openjdk-11.0.2.jdk/Contents/Home/</span><span class="delimiter">'</span></span>
    writeAnnotatedAPIPackages = <span class="string"><span class="delimiter">'</span><span class="content">org.e2immu.</span><span class="delimiter">'</span></span>
    writeAnnotationXMLPackages = <span class="string"><span class="delimiter">'</span><span class="content">org.e2immu.</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The list of properties configurable differs slightly from the one of the command line.
Gradle takes care of source and class path.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_annotated_apis">2. Annotated APIs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_preparing_an_annotatedapi_file">2.1. Preparing an AnnotatedAPI file</h3>
<div class="paragraph">
<p>Need to speed up.</p>
</div>
<div class="paragraph">
<p>The analyser&#8217;s command line interpreter (CLI) provides options for generating a template AnnotatedAPI file from a library.</p>
</div>
<div class="paragraph">
<p>The following example, taken from the <code>e2immu/annotation-store</code> project, contains the Gradle build code to produce a single <code>IoVertxCore.java</code> file:</p>
</div>
<div class="listingblock">
<div class="title">Part of <em>build-api.gradle</em> in <em>e2immu/annotation-store</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">plugins {
    id <span class="string"><span class="delimiter">'</span><span class="content">java</span><span class="delimiter">'</span></span>
}

task runIoVertxAAPI(<span class="key">type</span>: JavaExec) {
    group = <span class="string"><span class="delimiter">&quot;</span><span class="content">Execution</span><span class="delimiter">&quot;</span></span>
    description = <span class="string"><span class="delimiter">&quot;</span><span class="content">Prepare an AnnotatedAPI file for io.vertx.core</span><span class="delimiter">&quot;</span></span>

    classpath = sourceSets.main.runtimeClasspath
    main = <span class="string"><span class="delimiter">'</span><span class="content">org.e2immu.analyser.cli.Main</span><span class="delimiter">'</span></span>

    <span class="predefined-type">Set</span>&lt;<span class="predefined-type">File</span>&gt; reducedClassPath = sourceSets.main.runtimeClasspath.toList()
    reducedClassPath += sourceSets.test.runtimeClasspath
    reducedClassPath.removeIf({ f -&gt; f.path.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">build/classes</span><span class="delimiter">&quot;</span></span>)
        || f.path.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">build/resources</span><span class="delimiter">&quot;</span></span>) })

    args(<span class="string"><span class="delimiter">'</span><span class="content">--classpath=</span><span class="delimiter">'</span></span> + reducedClassPath.join(<span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span>) + <span class="string"><span class="delimiter">&quot;</span><span class="content">:jmods/java.base.jmod</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">'</span><span class="content">-a</span><span class="delimiter">'</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">--write-annotated-api-packages=io.vertx.core</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">--source=none</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">-d=CONFIGURATION,BYTECODE_INSPECTOR</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The task can be run with the command <code>./gradlew -b build-api.gradle runIoVertxAAPI</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_file_format">2.2. The file format</h3>
<div class="paragraph">
<p>AnnotatedAPI files are standard Java files, they will be inspected by a standard Java parser, so all standard syntax rules need to be followed.
They deviate in the following way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The primary types become sub-types of a primary type named after the package.</p>
</li>
<li>
<p>To ensure that there is no clash with preloaded primary types, they have a dollar <code>$</code> suffix.</p>
</li>
<li>
<p>A string constant, <code>PACKAGE_NAME</code>, specifies the package to which 'dollar types' are transferred.</p>
</li>
<li>
<p>All types become classes, all methods return a default value.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Start of the <em>JavaUtil.java</em> annotated API file</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JavaUtil</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PACKAGE_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">java.util</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">static</span> <span class="type">class</span> <span class="class">Enumeration</span><span class="error">$</span> {
        <span class="type">boolean</span> hasMoreElements() { <span class="keyword">return</span> <span class="predefined-constant">false</span>; }
        E nextElement() { <span class="keyword">return</span> <span class="predefined-constant">null</span>; }
        <span class="predefined-type">Iterator</span>&lt;E&gt; asIterator() { <span class="keyword">return</span> <span class="predefined-constant">null</span>; }
    }

    <span class="directive">static</span> <span class="type">class</span> <span class="class">Map</span><span class="error">$</span> {
        <span class="directive">static</span> <span class="type">class</span> <span class="class">Entry</span> {
            K getKey() { <span class="keyword">return</span> <span class="predefined-constant">null</span>; }
            V getValue() { <span class="keyword">return</span> <span class="predefined-constant">null</span>; }
    ...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_annotation_types">2.3. Annotation types</h3>
<div class="paragraph">
<p>All  <em>e2immu</em>  annotations have a parameter of the enum type <code>AnnotationType</code>, which takes 4 different values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">VERIFY</dt>
<dd>
<p>this is the default value inserted when parsing Java code.
This corresponds to the standard use of  <em>e2immu</em>  annotations: normally the analyser will compute them for you, but you may want to assert their presence.</p>
</dd>
<dt class="hdlist1">VERIFY_ABSENT</dt>
<dd>
<p>mostly for debugging: insert in the Java code by hand to make sure the analyser does not end up computing this assertion for you.</p>
</dd>
<dt class="hdlist1">COMPUTED</dt>
<dd>
<p>added to annotations inserted by the analyser</p>
</dd>
<dt class="hdlist1">CONTRACT</dt>
<dd>
<p>added to annotations inserted when parsing annotation XMLs or annotated APIs.
This type indicates that a value has not been computed, but stipulated by the user.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_visualising_immutability">3. Visualising immutability</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="inheritance-rules">3.1. Inheritance rules of annotations</h3>
<div class="paragraph">
<p>As a general rule, we would like to impose that any class that implements an interface, inherits all the annotations of that interface.
For example, if <code>java.util.List</code> is a container, then we want any implementation of that interface to be a container too.</p>
</div>
<div class="paragraph">
<p>Frequently used JDK classes such as <code>java.lang.String</code> are marked <code>final</code> themselves, so that they cannot be subclassed.
But in general, it seems a bad idea to weaken contracts.
On the other hand, we can mark <code>java.lang.Object</code> as  <code>@E2Immutable</code> , while obviously not all its derived classes can be of that type.</p>
</div>
<div class="paragraph">
<p>But the marks for eventually final and immutable classes push us to add some rules.
Consider the <code>Verticle</code> interface and parts of its default implementation <code>AbstractVerticle</code>
(please refer the section on Vertx integration <mark>TODO</mark> for an in-depth treatment):</p>
</div>
<div class="listingblock">
<div class="title">Excerpts and annotations of Verticle.java and AbstractVerticle.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@EventuallyFinal</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">init</span><span class="delimiter">&quot;</span></span>, framework = <span class="predefined-constant">true</span>)
<span class="type">interface</span> <span class="class">Verticle</span> {

    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">init</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> init(<span class="annotation">@NullNotAllowed</span> Vertx vertx, <span class="annotation">@NullNotAllowed</span> <span class="predefined-type">Context</span> context);

    <span class="annotation">@NotAllowed</span>(before = <span class="string"><span class="delimiter">&quot;</span><span class="content">init</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@NotModified</span>
    Vertx getVertx();

    <span class="annotation">@NotAllowed</span>(before = <span class="string"><span class="delimiter">&quot;</span><span class="content">init</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> start(Promise&lt;<span class="predefined-type">Void</span>&gt; startPromise) <span class="directive">throws</span> <span class="exception">Exception</span>;

    <span class="annotation">@NotAllowed</span>(before = <span class="string"><span class="delimiter">&quot;</span><span class="content">init</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> stop(Promise&lt;<span class="predefined-type">Void</span>&gt; startPromise) <span class="directive">throws</span> <span class="exception">Exception</span>;
}

<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">AbstractVerticle</span> <span class="directive">implements</span> Verticle {
    <span class="directive">protected</span> Vertx vertx;
    <span class="directive">protected</span> <span class="predefined-type">Context</span> context;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Vertx getVertx() {
        <span class="keyword">return</span> vertx;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> init(Vertx vertx, <span class="predefined-type">Context</span> context) {
        <span class="local-variable">this</span>.vertx = vertx;
        <span class="local-variable">this</span>.context = context;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our primary motivation here is to make sure that <code>vertx</code> and <code>context</code> are never assigned to in code derived from <code>AbstractVerticle</code>: the code analyser will ensure they become effectively final.
On top of that, we can try to monitor calls the <code>getVertx</code> method before the verticle has been registered, and calls to <code>init</code> from outside the framework.</p>
</div>
<div class="paragraph">
<p>Now, inside a class that derives from <code>AbstractVerticle</code>, a similar situation arises:</p>
</div>
<div class="listingblock">
<div class="title">MyVerticle.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@EventuallyFinal</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span>, framework = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyVerticle</span> <span class="directive">extends</span> AbstractVerticle {
    <span class="directive">private</span> HttpServer server;
    <span class="directive">private</span> JsonObject configuration;

    <span class="annotation">@Override</span>
    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> start(Promise&lt;<span class="predefined-type">Void</span>&gt; startPromise) {
        server = vertx.createHttpServer(); <i class="conum" data-value="1"></i><b>(1)</b>
        ConfigRetriever retriever = ConfigRetriever.create(vertx, options); <i class="conum" data-value="1"></i><b>(1)</b>
        retriever.getConfig(ar -&gt; {
            <span class="keyword">if</span> (ar.failed()) {
                startPromise.fail(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cannot read config</span><span class="delimiter">&quot;</span></span>);
            } <span class="keyword">else</span> {
                configuration = ar.result();
                startPromise.complete(); <i class="conum" data-value="2"></i><b>(2)</b>
            }
        });
    }

    <span class="directive">private</span> <span class="type">void</span> handleRequest(RoutingContext routingContext) {
        textResult(routingContext, <span class="string"><span class="delimiter">&quot;</span><span class="content">a=</span><span class="delimiter">&quot;</span></span> + configuration.a);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>vertx</code> field has been initialised, is effectively final, and is non-null.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Logical exit point of the method: only after having executed this handler, which assigns to <code>configuration</code>, the rest of the program can continue.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The two fields in this subclass will become effectively final, but, crucially, later than the <code>vertx</code> field.
The <code>handleRequest</code> method will be only be called after the <code>start</code> method logically ends.</p>
</div>
<div class="paragraph">
<p>Should we treat the effective finality <code>AbstractVerticle</code> and <code>MyVerticle</code> as independent?
Or do we want to impose <a href="#final-annotation">@Final</a> on any concrete implementation of <code>AbstractVerticle</code>?
My intuition would say <em>yes</em>, we should do that, because of the nature of the class imposed on <code>MyVerticle</code> by the <code>Verticle</code> interface:
it is going to be a class which has a start/stop lifecycle, instantiated by a framework, where code runs in the context of the framework and services started in that framework.
Instances of this class should not be passed on; public methods should not be available for 'outsiders'.
In most situations, the start/stop nature is binary, and while it may have a protracted starting phase, it will not become a start/phase 1/phase 2/stop lifecycle.
But there are too many other examples where this would seem impractical.
Therefore, we&#8217;ll stick to</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Summary of inheritance rules</div>
<div class="paragraph">
<p>As a general rule, a class inherits all annotations from directly implemented interfaces, but not from a possible parent class and its interfaces implemented.
An interface that extends another interface does not inherit the annotations from its ancestor.</p>
</div>
<div class="paragraph">
<p>However, methods inherit the annotations of methods they override.</p>
</div>
<div class="paragraph">
<p>Marks for <a href="#final-annotation">@Final</a> and <a href="#e2immutable-annotation">@E2Immutable</a> annotations are restricted to the methods listed in the type that has the annotation, and the fields linked to them.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reference"><em>Reference</em></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_concepts">4. Concepts</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="concept-modified">4.1. Modification</h3>

</div>
<div class="sect2">
<h3 id="concept-containers">4.2. Containers</h3>

</div>
<div class="sect2">
<h3 id="concept-linking">4.3. Linking and independence</h3>

</div>
<div class="sect2">
<h3 id="_immutability">4.4. Immutability</h3>
<div class="sect3">
<h4 id="concept-e1immutable">4.4.1. Level 1 immutable</h4>
<div class="paragraph">
<p>Terminology used:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Variable field</dt>
<dd>
<p>marked  <code>@Variable</code> </p>
</dd>
<dt class="hdlist1">Effectively final field</dt>
<dd>
<p>marked  <code>@E1Immutable</code>  or  <code>@E1Container</code> .</p>
</dd>
<dt class="hdlist1">Eventually final field</dt>
<dd>
<p>marked  <code>@E1Immutable</code>  or  <code>@E1Container</code> , with <code>after=xxx</code> parameter</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A type is level 1 immutable when all its fields are effectively final.
A type is <a href="#concept-eventual">eventually</a> level 1 immutable when after executing a marked method, the fields become effectively final.
This transition is best understood as the removal of a number of methods, marked either  <code>@Mark</code>  or  <code>@Only</code>  with parameter <code>before</code>, which make the field variable.</p>
</div>
</div>
<div class="sect3">
<h4 id="concept-implicitly-immutable">4.4.2. Implicitly immutable types</h4>
<div class="paragraph">
<p>Terminology:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Implicitly immutable content</dt>
<dd>
<p>all the fields of a type which are of implicitly immutable type.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="concept-e2immutable">4.4.3. Level 2 immutable</h4>
<div class="paragraph">
<p>A type is level 2 immutable when</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>it is level 1 immutable, i.e., all its fields are effectively final</p>
</li>
<li>
<p>all fields are not modified</p>
</li>
<li>
<p>if a field is not of implicitly immutable type, it must be either private, or level 2 immutable</p>
</li>
<li>
<p>all constructors and non-private methods are independent of the fields</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A type is <a href="#concept-eventual">eventually</a> level 2 immutable when after executing a marked method, the fields become effectively final and or not modified.
This transition is best understood as the removal of a number of methods, marked either  <code>@Mark</code>  or  <code>@Only</code>  with parameter <code>before</code>, which make the field variable or modify the fields.</p>
</div>
</div>
<div class="sect3">
<h4 id="technical-dynamic-type-annotations">4.4.4. Dynamic type annotations</h4>

</div>
</div>
<div class="sect2">
<h3 id="concept-eventual">4.5. Eventual immutability</h3>

</div>
<div class="sect2">
<h3 id="concept-higher-order-modification">4.6. Higher-order modifications</h3>

</div>
<div class="sect2">
<h3 id="_miscellaneous">4.7. Miscellaneous</h3>
<div class="sect3">
<h4 id="concept-constant">4.7.1. Constants</h4>
<div class="paragraph">
<p>Java literals are constants.
An instance of a type whose effectively final fields have only been assigned literal values, is a constant instance.
Typical examples of a constant instances are found in parameterized <code>enum</code> fields.</p>
</div>
</div>
<div class="sect3">
<h4 id="concept-statement-time">4.7.2. Statement time</h4>
<div class="paragraph">
<p>Technically important for variable fields (<a href="#concept-e1immutable">Level 1 immutable</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="concept-singleton">4.7.3. Singleton classes</h4>

</div>
<div class="sect3">
<h4 id="concept-utility-class">4.7.4. Utility classes</h4>
<div class="paragraph">
<p>A class which is at the same time eventually level 2 immutable, and cannot be instantiated.</p>
</div>
<div class="paragraph">
<p>The level 2 immutability ensures that the (static) fields are sufficiently immutable.
The fact that it cannot be instantiated is verified by</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the fact that all constructors should be private;</p>
</li>
<li>
<p>there should be at least one private constructor;</p>
</li>
<li>
<p>no method or field can use the constructors to instantiate objects of this type.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="concept-extension-class">4.7.5. Extension classes</h4>
<div class="paragraph">
<p>An extension class is an eventually final type whose static methods all share the same type of first parameter.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview_of_annotations">5. Overview of annotations</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_annotation_modes">5.1. Annotation modes</h3>
<div class="paragraph">
<p>Depending on where you find yourself in the continuum between object-oriented programming and functional programming, or, put differently, almost never following the container and level 2 immutable rules, or mostly adhering to them, you may wish to be either notified for following the rules, or warned by the analyser for breaking the rules.
It is in this spirit that we envisage working in</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Green mode</dt>
<dd>
<p>we assume that containers and level 2 immutable objects are sparse, and want to highlight when you follow the rules.</p>
</dd>
<dt class="hdlist1">Red mode</dt>
<dd>
<p>when the majority of your types are level 2 immutable, and non-containers are rare, it may be more interesting to be warned when a type is <em>not</em> following the rules.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Because annotations often occur in an opposing pair, the choice of a mode can help to reduce information overload.
For example, in red mode, <a href="#mutableModifiesArguments-annotation">@MutableModifiesArguments</a> will be prominently displayed, and
<a href="#e2container-annotation">@E2Container</a> will be "invisible".
Similarly, <a href="#modified-annotation">@Modified</a> is highlighted and <a href="#notModified-annotation">@NotModified</a> will be plain.</p>
</div>
<div class="paragraph">
<p>In green mode, we want <a href="#container-annotation">@Container</a> and <a href="#e2container-annotation">@E2Container</a> to be visible, while "normal" types are unmarked in black.
The <a href="#notModified-annotation">@NotModified</a> will be highlighted, while <a href="#modified-annotation">@Modified</a> remains plain.</p>
</div>
</div>
<div class="sect2">
<h3 id="_inheritance_of_annotations">5.2. Inheritance of annotations</h3>
<div class="paragraph">
<p>In general, the analyser allows a method to do better than the method it overrides.
It will raise an error when the overriding method is  <code>@Modified</code> , where the original is  <code>@NotModified</code>.
<mark>TODO</mark></p>
</div>
</div>
<div class="sect2">
<h3 id="_list_of_annotations">5.3. List of annotations</h3>
<div class="paragraph">
<p>For each of the annotations, we answer a couple of standard questions:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Basic</dt>
<dd>
<p>is this an annotation you definitely should understand?</p>
</dd>
<dt class="hdlist1">Immu</dt>
<dd>
<p>is this annotation part of the immutability concept of the analyzer?</p>
</dd>
<dt class="hdlist1">Contract</dt>
<dd>
<p>will you manually insert this annotation often in interfaces?</p>
</dd>
<dt class="hdlist1">Type</dt>
<dd>
<p>does the annotation occur on types?</p>
</dd>
<dt class="hdlist1">Field</dt>
<dd>
<p>does the annotation occur on (static) fields?</p>
</dd>
<dt class="hdlist1">Method</dt>
<dd>
<p>does the annotation occur on methods and constructors?</p>
</dd>
<dt class="hdlist1">Parameter</dt>
<dd>
<p>does the annotation occur on parameters?</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This classification hopefully helps to see the wood for the trees in the long list.</p>
</div>
<div class="sect3">
<h4 id="allowsInterrupt-annotation">5.3.1. @AllowsInterrupt</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Contract-only annotation indicating that this method or constructor increases the statement time (<a href="#concept-statement-time">Statement time</a>), or allows the execution to be interrupted.</p>
</div>
<div class="paragraph">
<p>Default value is true.
Methods can be annotated with <code>@AllowsInterrupt(false)</code> to explicitly mark that they do not interrupt.</p>
</div>
<div class="paragraph">
<p>External methods not annotated will not interrupt.</p>
</div>
</div>
<div class="sect3">
<h4 id="beforeMark-annotation">5.3.2. @BeforeMark</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>Annotation computed when an eventually immutable type is guaranteed to be in its <em>before</em> state, i.e., none of the marked methods have been called yet.
As a dynamic type annotation (<a href="#technical-dynamic-type-annotations">Dynamic type annotations</a>), it is the opposite of  <code>@E1Immutable</code> ,
 <code>@E2Immutable</code> , or its container variants  <code>@E1Container</code> ,  <code>@E2Container</code> .
They guarantee that an eventually immutable object is in its <em>after</em> state, i.e., a marked method has been called and the object has become immutable.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>not immediately relevant</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="constant-annotation">5.3.3. @Constant</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>The analyser emits this annotation when a field has a constant final value, or a method returns a constant value.
Its primary purpose is to help debug the analyser.
More details in <a href="#concept-constant">Constants</a>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>This annotation has no opposite.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>In this simple example, an <code>enum</code> constant is returned by the <code>highest</code> method:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>
<span class="directive">public</span> <span class="type">enum</span> Enum_3 {
    ONE(<span class="integer">1</span>), TWO(<span class="integer">2</span>), THREE(<span class="integer">3</span>);

    <span class="directive">public</span> <span class="directive">final</span> <span class="type">int</span> cnt;

    Enum_3(<span class="type">int</span> cnt) {
        <span class="local-variable">this</span>.cnt = cnt;
    }

    <span class="annotation">@Constant</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">THREE</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="directive">static</span> Enum_3 highest() {
        <span class="keyword">return</span> THREE;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="container-annotation">5.3.4. @Container</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>The analyser computes this essential annotation for types which do not modify the parameters of their methods.
See <a href="#concept-containers">Containers</a> for an in-depth discussion.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>Use this annotation in green mode.
The opposite is  <code>@MutableModifiesArguments</code>  if the type has  <code>@Variable</code>  fields, or  <code>@E1Immutable</code>  if all the type&#8217;s fields are effectively final.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>The following examples present containers: <a href="#constant-annotation">@Constant</a>, <a href="#dependent-annotation">@Dependent</a>, <a href="#e1container-annotation">@E1Container</a>.
Non-containers are in <a href="#e1immutable-annotation">@E1Immutable</a> and <a href="#mutableModifiesArguments-annotation">@MutableModifiesArguments</a>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="dependent-annotation">5.3.5. @Dependent</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>Annotation used to indicate that the type&#8217;s fields <a href="#concept-linking">link</a> to the method&#8217;s parameter or return value, or the constructor&#8217;s parameters.
This annotation is only present for fields that are not of <a href="#concept-implicitly-immutable">implicitly immutable type</a>.
Additionally, on methods, the analyser only computes the annotation when the method is  <code>@NotModified</code>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>Use this annotation in the red mode.
Its opposite is  <code>@Independent</code> .</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>The assignment of a mutable set to a field typically causes a dependency:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Dependent</span>&lt;<span class="predefined-type">String</span>&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; set;

    <span class="directive">public</span> Dependent(<span class="annotation">@Dependent</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; set) {
        <span class="local-variable">this</span>.set = set;
    }

    <span class="annotation">@Dependent</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; getSet() {
        <span class="keyword">return</span> set;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A similar example is in <a href="#e1immutable-annotation">@E1Immutable</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="dependent1-annotation">5.3.6. @Dependent1</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>As one of the <a href="#concept-higher-order-modification">Higher-order modifications</a> annotations,  <code>@Dependent1</code> 
on a parameter, of <a href="#concept-implicitly-immutable">implicitly immutable type</a>, indicates that this parameter is assigned to one of the fields, or assigned into the object graph of one of the fields.
When computed on a method, the return value of the method, again of implicitly immutable type, is known to be part of the object graph of the fields.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>This annotation has no opposite.
It implies  <code>@Independent</code>  because it appears on implicitly immutable types only.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>This annotation has been contracted in many collection-framework methods, such as</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Collections</span>.add(<span class="annotation">@Dependent1</span> E e);

<span class="annotation">@Dependent1</span>
E <span class="predefined-type">List</span>.get(<span class="type">int</span> index);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The most direct example explaining the definition is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Dependent1_0</span>&lt;T&gt; {
    <span class="annotation">@Linked1</span>(to = {<span class="string"><span class="delimiter">&quot;</span><span class="content">Dependent1_0:t</span><span class="delimiter">&quot;</span></span>})
    <span class="directive">private</span> <span class="directive">final</span> T t;

    <span class="directive">public</span> Dependent1_0(<span class="annotation">@Dependent1</span> T t) {
        <span class="local-variable">this</span>.t = t;
    }

    <span class="annotation">@Dependent1</span>
    <span class="directive">public</span> T getT() {
        <span class="keyword">return</span> t;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependent2-annotation">5.3.7. @Dependent2</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation is one of the <a href="#concept-higher-order-modification">Higher-order modifications</a> annotations.
It is only computed for <a href="#concept-linking">independent</a> parameters or methods.
When computed on a parameter, it indicates that part of the <a href="#concept-implicitly-immutable">implicitly immutable content</a>
of the argument will be assigned to the fields of the method&#8217;s type.
When computed on a method, it signifies that part of the implicitly immutable content of the return value is assigned to the fields of the method&#8217;s type.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This annotation is central to iteration over the implicitly immutable content of a type.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Mode</dt>
<dd>
<p>This annotation has no opposite.
By definition, implies  <code>@Independent</code> .</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>This annotation has been contracted in many collection-framework methods, such as</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> <span class="predefined-type">Collections</span>.addAll(<span class="annotation">@Dependent2</span> <span class="predefined-type">Collection</span>&lt;? <span class="directive">extends</span> E&gt; coll);

<span class="annotation">@Dependent2</span>
Stream&lt;E&gt; <span class="predefined-type">Collections</span>.stream();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="e1container-annotation">5.3.8. @E1Container</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation is a short-hand for the combination of  <code>@E1Immutable</code>  and  <code>@Container</code> , as described in <a href="#concept-e1immutable">Level 1 immutable</a> and <a href="#concept-containers">Containers</a>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>This annotation sits in between  <code>@MutableModifiesArguments</code> ,  <code>@Container</code>  and  <code>@E2Container</code> .</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>In the following example of an eventually level 1 immutable type, the field <code>j</code> remains variable until the user of the class calls <code>setPositiveJ</code>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Example of an eventually @E1Container type</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E1Container</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">j</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">EventuallyE1Immutable_2_M</span> {

    <span class="annotation">@Modified</span>
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Integer</span>&gt; integers = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;();

    <span class="annotation">@Final</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">j</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="type">int</span> j;

    <span class="annotation">@Modified</span>
    <span class="annotation">@Only</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">j</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">boolean</span> addIfGreater(<span class="type">int</span> i) {
        <span class="keyword">if</span> (<span class="local-variable">this</span>.j &lt;= <span class="integer">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Not yet set</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span> (i &gt;= <span class="local-variable">this</span>.j) {
            integers.add(i);
            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Integer</span>&gt; getIntegers() {
        <span class="keyword">return</span> integers;
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="type">int</span> getJ() {
        <span class="keyword">return</span> j;
    }

    <span class="annotation">@Modified</span>
    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">j</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> setPositiveJ(<span class="type">int</span> j) {
        <span class="keyword">if</span> (j &lt;= <span class="integer">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        <span class="keyword">if</span> (<span class="local-variable">this</span>.j &gt; <span class="integer">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Already set</span><span class="delimiter">&quot;</span></span>);

        <span class="local-variable">this</span>.j = j;
    }

    <span class="annotation">@Modified</span>
    <span class="annotation">@Only</span>(before = <span class="string"><span class="delimiter">&quot;</span><span class="content">j</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> setNegativeJ(<span class="type">int</span> j) {
        <span class="keyword">if</span> (j &gt; <span class="integer">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        <span class="keyword">if</span> (<span class="local-variable">this</span>.j &gt; <span class="integer">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Already set</span><span class="delimiter">&quot;</span></span>);
        <span class="local-variable">this</span>.j = j;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="e1immutable-annotation">5.3.9. @E1Immutable</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation indicates that a type is <a href="#concept-e1immutable">level 1 immutable</a>, effectively or eventually, meaning all fields are effectively or eventually final.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>This annotation sits in between  <code>@MutableModifiesArguments</code>  and  <code>@E2Immutable</code> .</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>The <code>add</code> method modifies its parameter <code>input</code>; at the same time, the dependence between the constructor&#8217;s parameter and the field prevents the type from being level 2 immutable:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E1Immutable</span>
<span class="type">class</span> <span class="class">AddToSet</span> {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; stringsToAdd;

    <span class="annotation">@Dependent</span>
    <span class="directive">public</span> AddToSet(<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; set) {
        <span class="local-variable">this</span>.stringsToAdd = set;
    }

    <span class="directive">public</span> <span class="type">void</span> add(<span class="annotation">@Modified</span> <span class="annotation">@NotNull1</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; input) {
        input.addAll(set);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="e2container-annotation">5.3.10. @E2Container</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation is a short-hand for the combination of  <code>@E2Immutable</code>  and  <code>@Container</code> , as described in <a href="#concept-e2immutable">Level 2 immutable</a> and <a href="#concept-containers">Containers</a>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>This annotation is the default in the red mode.</p>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="e2immutable-annotation">5.3.11. @E2Immutable</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation indicates that a type is level 2 immutable, effectively or eventually.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>This annotation is the default in the red mode.</p>
</dd>
<dt class="hdlist1">Details</dt>
<dd>
<p>Level 2 immutability adds extra restrictions on top of level 1 immutability:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>all fields must be not modified;</p>
</li>
<li>
<p>all fields of support data types must be either private, or level 2 immutable themselves;</p>
</li>
<li>
<p>all non-private methods and constructors must be marked  <code>@Independent</code> , i.e.,</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>in the case of constructors, the parameters must not link to the fields of support data types;</p>
</li>
<li>
<p>in the case of methods, neither the return value nor the parameters must link to the fields of support data types.
A consequence of requirement of not modified fields, is that non-private methods cannot be modifying.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="extensionClass-annotation">5.3.12. @ExtensionClass</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="final-annotation">5.3.13. @Final</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation indicates that a field is effectively or eventually final.
Fields that have the Java modifier <code>final</code> possess the annotation, but the analyser does not write it out to avoid clutter.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>Use this annotation to contract in the green mode, with the opposite,  <code>@Variable</code> , being the default.
In the red mode,  <code>@Final</code>  is the default.</p>
</dd>
<dt class="hdlist1">Parameters</dt>
<dd>
<p>The <code>after="mark"</code> parameter indicates that the field is eventually final, after the marking method.</p>
</dd>
<dt class="hdlist1">Details</dt>
<dd>
<p>A field is effectively final when no method, transitively reachable from a non-private non-constructor method, assigns to the field.
A field is eventually final if the above definition holds when one excludes all the methods that are pre-marking, i.e., that hold an annotation <code>@Only(before="mark")</code> or <code>@Mark("mark")</code>.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>Please find an example of an eventually final field in the example of <a href="#e1container-annotation">@E1Container</a>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Example for @Variable, @Final</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Container</span>
<span class="type">class</span> <span class="class">ExampleManualVariableFinal</span> {

    <span class="annotation">@Final</span>
    <span class="directive">private</span> <span class="type">int</span> i;

    <span class="annotation">@Variable</span>
    <span class="directive">private</span> <span class="type">int</span> j;

    <span class="directive">public</span> <span class="directive">final</span> <span class="type">int</span> k; <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">public</span> ExampleManualVariableFinal(<span class="type">int</span> p, <span class="type">int</span> q) {
        setI(p);
        <span class="local-variable">this</span>.k = q;
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="type">int</span> getI() {
        <span class="keyword">return</span> i;
    }

    <span class="annotation">@Modified</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> <span class="type">void</span> setI(<span class="type">int</span> i) {
        <span class="local-variable">this</span>.i = i;
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="type">int</span> getJ() {
        <span class="keyword">return</span> j;
    }

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">void</span> setJ(<span class="type">int</span> j) {
        <span class="local-variable">this</span>.j = j;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This field is effectively final, but there is no annotation because of the <code>final</code> modifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Note that only the constructor accesses this method.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_finalizer">5.3.14. @Finalizer</h4>

</div>
<div class="sect3">
<h4 id="_fluent">5.3.15. @Fluent</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation indicates that a method returns <code>this</code>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>There is no opposite for this annotation.</p>
</dd>
<dt class="hdlist1">Details</dt>
<dd>
<p>Fluent methods do not return a real value.
This is of consequence in the definition of independence for methods, as dependence on <code>this</code> is ignored.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_identity">5.3.16. @Identity</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation indicates that a method returns its first parameter.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>There is no opposite for this annotation.</p>
</dd>
<dt class="hdlist1">Details</dt>
<dd>
<p>Apart for all the obvious consequences, this annotation has an explicit effect on the linking of variables: a method marked  <code>@Identity</code>  only links to the first parameter.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_ignoremodifications">5.3.17. @IgnoreModifications</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>Helper annotation to mark that modifications on a field are to be ignored, because they fall outside the scope of the application.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>There is no opposite for this annotation.
It can only be used for contracting, the analyser cannot generate it.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>The only current use is on <code>System.out</code> and <code>System.err</code>.
The <code>print</code> method family is obviously modifying to these fields, however, we judge it to be outside the scope of the application.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_independent">5.3.18. @Independent</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>Annotation used to indicate that a method or constructor avoids linking the fields of the type to the return value and parameters.
This annotation is only present when there are support data fields.
Additionally, on methods, the analyser only computes the annotation when the method is  <code>@NotModified</code>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>Use this annotation in the green mode.
Its opposite is  <code>@Dependent</code> .</p>
<div class="ulist">
<ul>
<li>
<p><mark>TODO</mark> check definition for methods, parameters dependent as well?</p>
</li>
<li>
<p><mark>TODO</mark> why do we ignore dependence on this?</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_linked">5.3.19. @Linked</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>Annotation to help debug the dependence system.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>There is no opposite.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_linked1">5.3.20. @Linked1</h4>

</div>
<div class="sect3">
<h4 id="_mark">5.3.21. @Mark</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="modified-annotation">5.3.22. @Modified</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>Core annotation which indicates that <a href="#concept-modified">modifications</a> take place on a field, parameter, or in a method.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>It is the default in the green mode, when  <code>@NotModified</code> is not visible.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="modified1-annotation">5.3.23. @Modified1</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation is part of the <a href="#concept-higher-order-modification">higher-order modifications</a>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>the opposite annotation is  <code>@NotModified1</code>.
In green mode, this one is the default; in red mode,  <code>@NotModified1</code> is the default.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>Applying a c</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="mutableModifiesArguments-annotation">5.3.24. @MutableModifiesArguments</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation appears on types which are not a container and not level 1 immutable: at least one method will modify its parameters, and at least one field will be variable.
Definitions are in <a href="#concept-containers">Containers</a> and <a href="#concept-e1immutable">Level 1 immutable</a>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>It is the default in the green mode when none of  <code>@Container</code> ,  <code>@E1Immutable</code> ,  <code>@E1Container</code> ,  <code>@E2Immutable</code> ,  <code>@E2Container</code>  is present.
Use it for contracting in the red mode.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>Types with non-private fields cannot be level 1 immutable.
Here we combine that with a parameter modifying method:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@MutableModifiesArguments</span>
<span class="type">class</span> <span class="class">Mutate</span> {
    <span class="annotation">@Variable</span>
    <span class="directive">public</span> <span class="type">int</span> count;

    <span class="directive">public</span> <span class="type">void</span> add(<span class="annotation">@Modified</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; list) {
        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="integer">0</span>; i&lt;count; i++) {
            list.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">item </span><span class="delimiter">&quot;</span></span>+i);
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="notModified-annotation">5.3.25. @NotModified</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>Core annotation which indicates that no <a href="#concept-modified">modifications</a> take place on a field, parameter, or in a method.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>It is the default in the red mode, when its opposite  <code>@Modified</code>  is not present.</p>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="notModified1-annotation">5.3.26. @NotModified1</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation is part of the <a href="#concept-higher-order-modification">higher-order modifications</a>.
Contracted to a parameter of an abstract type, it indicates that the abstract method cannot be implemented in a modifying way.
Computed on parameters of any type with <a href="#concept-implicitly-immutable">implicitly immutable content</a>, it signifies that</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>It exists only in the green mode; there is no opposite.
It can only be used for contracting, the analyser cannot generate it.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This annotation is a dynamic type annotation on functional types in fields, methods and parameters.
The analyser can compute it in certain circumstances; in other cases, the user can show intent by requesting this property.</p>
</div>
<div class="paragraph">
<p>Note that because suppliers have no parameters, only modifications to the closure apply.
Functional interfaces are always normally  <code>@NotModified</code>: there are no modifying methods on them apart from the abstract method.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Example</dt>
<dd>
<p>We first show an example of a  <code>@NotModified1</code> contract:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the analyser computes the annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="notNull-annotation">5.3.27. @NotNull</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>Core annotation to indicate that a field, parameter, or result of a method can never be <code>null</code>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>Use this annotation for contracting in the green mode.
It is the opposite of  <code>@Nullable</code> .</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="notNull1-annotation">5.3.28. @NotNull1</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="notNull2-annotation">5.3.29. @NotNull2</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="nullable-annotation">5.3.30. @Nullable</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation indicates that the field, parameter, or result of a method can be <code>null</code>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>This is the default in the green mode, when  <code>@NotNull</code>  is not present.
Use it to contract in the red mode.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="only-annotation">5.3.31. @Only</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>Essential annotation for methods in <a href="#concept-eventual">eventually immutable</a> types.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>There is no opposite.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>The following example shows a useful <code>@Only(before="&#8230;&#8203;")</code> method.
Please find an example with a useful <code>@Only(after="&#8230;&#8203;")</code> method in <a href="#testMark-annotation">@TestMark</a>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="propagateModification-annotation">5.3.32. @PropagateModification</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon green"><i class="fa fa-check"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation is part of the <a href="#concept-higher-order-modification">higher-order modifications</a>.
The analyser adds this annotation when an abstract method without modification information is called on a parameter.
This abstract method can be modifying or not, and in general it cannot be known which is the case.
The annotation then informs the analyser that modifications need computing at caller-time.</p>
<div class="paragraph">
<p>The annotation is also possible on fields, in case the parameter becomes the effectively final value of a field.</p>
</div>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>There is no opposite.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>A typical implementation of <code>forEach</code> is a nice example:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@FunctionalInterface</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Consumer</span>&lt;T&gt; {
    <span class="type">void</span> accept(T t); <i class="conum" data-value="1"></i><b>(1)</b>
    ...
}
<span class="annotation">@Container</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Set</span>&lt;T&gt; {
    <span class="keyword">default</span> <span class="type">void</span> forEach(<span class="annotation">@PropagateModification</span> Consumer&lt;T&gt; consumer) {
      <span class="keyword">for</span>(T t: <span class="local-variable">this</span>) consumer.accept(t);
    }
    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>No modification information present on <code>accept</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="singleton-annotation">5.3.33. @Singleton</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation indicates that the class is a <a href="#concept-singleton">singleton</a>: only one instance can exist.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>There is no opposite for this annotation.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>There are many ways to ensure that a type has only one instance.
This is the simplest example:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OnlyOne</span> {
  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> INSTANCE = <span class="keyword">new</span> OnlyOne();

  <span class="directive">public</span> <span class="directive">final</span> <span class="type">int</span> value;

  <span class="directive">private</span> OnlyOne() {
      value = <span class="keyword">new</span> <span class="predefined-type">Random</span>().nextInt(<span class="integer">10</span>);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="testMark-annotation">5.3.34. @TestMark</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>Part of the <a href="#concept-eventual">eventual</a> system, this annotation is computed for methods which return the state of the object with respect to eventuality: <em>after</em> is <code>true</code>, while <em>before</em> is <code>false</code>.</p>
</dd>
<dt class="hdlist1">Parameters</dt>
<dd>
<p>a parameter <code>before</code> exists to reverse the values: when <code>before</code> is true, the method returns <code>true</code> when the state is <em>before</em> and <code>false</code> when the state is <em>after</em>.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>There is no opposite for this annotation.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>The  <code>@TestMark</code>  annotation in the following example returns <code>true</code> when <code>t != null</code>, i.e., <em>after</em> the marked method <code>setT</code> has been called:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Immutable</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">EventuallyE2Immutable_2</span>&lt;T&gt; {

    <span class="directive">private</span> T t;

    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> setT(T t) {
        <span class="keyword">if</span> (t == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
        <span class="keyword">if</span> (<span class="local-variable">this</span>.t != <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        <span class="local-variable">this</span>.t = t;
    }

    <span class="annotation">@Only</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> T getT() {
        <span class="keyword">if</span> (t == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        <span class="keyword">return</span> t;
    }

    <span class="annotation">@TestMark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">boolean</span> isSet() {
        <span class="keyword">return</span> t != <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="utilityClass-annotation">5.3.35. @UtilityClass</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation indicates that the type is a <a href="#concept-utility-class">utility class</a>: its static side is eventually level 2 immutable, and it cannot be instantiated.
As a consequence, should only have static methods.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>There is no opposite for this annotation.</p>
</dd>
<dt class="hdlist1">Details</dt>
<dd>
<p>The level 2 immutability ensures that the (static) fields are sufficiently immutable.
The fact that it cannot be instantiated is verified by</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the fact that all constructors should be private;</p>
</li>
<li>
<p>there should be at least one private constructor;</p>
</li>
<li>
<p>no method or field can use the constructors instantiate objects of this type.</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>The following utility class is copied from the analyser:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@UtilityClass</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">IntUtil</span> {

    <span class="directive">private</span> IntUtil() {
    }

    <span class="comment">// copied from Guava, DoubleMath class</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">boolean</span> isMathematicalInteger(<span class="type">double</span> x) {
        <span class="keyword">return</span> !<span class="predefined-type">Double</span>.isNaN(x) &amp;&amp; !<span class="predefined-type">Double</span>.isInfinite(x) &amp;&amp; x == <span class="predefined-type">Math</span>.rint(x);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="variable-annotation">5.3.36. @Variable</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immu <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field <span class="icon green"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method <span class="icon red"><i class="fa fa-times"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Param <span class="icon red"><i class="fa fa-times"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Summary</dt>
<dd>
<p>This annotation indicates that a field is not <a href="#concept-e1immutable">effectively or eventually final</a>, i.e., it is assigned to in methods accessible from non-private non-constructor methods in the type.</p>
</dd>
<dt class="hdlist1">Mode</dt>
<dd>
<p>This annotation is the default in the green mode.
It is the opposite of  <code>@Final</code> .</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>Any non-eventual type with setters will have fields marked  <code>@Variable</code> :</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Container</span>
<span class="type">class</span> <span class="class">HoldsOneInteger</span> {

  <span class="annotation">@Variable</span>
  <span class="directive">private</span> <span class="type">int</span> i;

  <span class="directive">public</span> <span class="type">void</span> set(<span class="type">int</span> i) {
    <span class="local-variable">this</span>.i = i;
  }

  <span class="directive">public</span> <span class="type">int</span> get() {
    <span class="keyword">return</span> i;
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="annotation-hierarchy">5.4. Relations between annotations</h3>
<div class="paragraph">
<p>In this section we summarize the relations between annotations.</p>
</div>
<div class="sect3">
<h4 id="_on_types">5.4.1. On types</h4>
<div class="paragraph">
<p>Note that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p> <code>@E2Container</code>  is a shorthand for the combination of  <code>@E2Immutable</code>  and  <code>@Container</code> ;</p>
</li>
<li>
<p> <code>@E1Container</code>  is a shorthand for the combination of  <code>@E1Immutable</code>  and  <code>@Container</code> ;</p>
</li>
<li>
<p> <code>@E2Immutable</code>  requires  <code>@E1Immutable</code> ;</p>
</li>
<li>
<p>a type is  <code>@MutableModifiesArguments</code>  if and only if it is not  <code>@E1Immutable</code>  and not  <code>@Container</code> ;</p>
</li>
<li>
<p>when a type is  <code>@MutableModifiesArguments</code> , there will be at least one field marked  <code>@Variable</code> , and at least one parameter marked  <code>@Modified</code> ;</p>
</li>
<li>
<p>by definition, types without fields are  <code>@E2Immutable</code> ;</p>
</li>
<li>
<p>all primitive types are implicitly  <code>@E2Container</code> ; the analyser will not mark them.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_on_fields">5.4.2. On fields</h4>
<div class="paragraph">
<p>Note that  <code>@Variable</code>  fields can be  <code>@NotNull</code> !
This obviously requires a not-null initialiser to be present; all other assignments must be not-null as well.
The opposite, a  <code>@Final</code>  field that is  <code>@Nullable</code> , can only occur when the effectively final value is the <code>null</code> constant.</p>
</div>
<div class="paragraph">
<p>The following opposites are easily seen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a field is either  <code>@Final</code>  or  <code>@Variable</code> </p>
</li>
<li>
<p>a field is either  <code>@NotModified</code> or  <code>@Modified</code> </p>
</li>
<li>
<p>a field is either  <code>@NotNull</code>  (or  <code>@NotNull1</code> , or  <code>@NotNull2</code> ), or  <code>@Nullable</code>  (see also <a href="#nullability">Nullability</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p> <code>@Variable</code>  implies  <code>@Modified</code> , whether modifying methods exist for the field or not;</p>
</li>
<li>
<p> <code>@Final</code>   <code>@Modified</code> : part of  <code>@E1Immutable</code> ;</p>
</li>
<li>
<p> <code>@Final</code>   <code>@NotModified</code>: part of  <code>@E2Immutable</code> ; sufficient for implicitly immutable types; for other types, the visibility and dependence rules kick in.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From the field&#8217;s owning type, following the definitions, we obtain:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if a type is effectively  <code>@E2Immutable</code> , all its fields are  <code>@Final</code>   <code>@NotModified</code>;</p>
</li>
<li>
<p>if a type is effectively  <code>@E1Immutable</code> , all its fields are  <code>@Final</code> ;</p>
</li>
<li>
<p>if a type is  <code>@MutableModifiesArguments</code> , at least one of its field is  <code>@Variable</code> .</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Further, note that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fields of a primitive type are always  <code>@NotNull</code>  and  <code>@NotModified</code>, but neither are marked.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_on_constructors">5.4.3. On constructors</h4>
<div class="paragraph">
<p>Non-trivial constructors have the  <code>@Modified</code>  property.
When there is support data, a constructor is either  <code>@Independent</code>  (green) or  <code>@Dependent</code>  (red).
A constructor without annotations therefore implies either that the type is not  <code>@E1Immutable</code> , or that the constructor is not assigning to support data fields.</p>
</div>
</div>
<div class="sect3">
<h4 id="_on_methods">5.4.4. On methods</h4>
<div class="paragraph">
<p>Opposites:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a method is either  <code>@NotModified</code> (green) or  <code>@Modified</code>  (red)</p>
</li>
<li>
<p>a method is either  <code>@Independent</code>  (green) or  <code>@Dependent</code>  (red).
This property is only relevant when there is support data, and the method is  <code>@NotModified</code></p>
</li>
<li>
<p>a method is either  <code>@NotNull</code>  (or  <code>@NotNull1</code> , or  <code>@NotNull2</code> ) (green), or  <code>@Nullable</code>  (red)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Furthermore,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if a type is effectively  <code>@E2Immutable</code>  (green), all its methods are  <code>@NotModified</code> (green).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>quite trivially, <code>void</code> methods have no annotations relating to a return element</p>
</li>
<li>
<p>methods returning a primitive type are  <code>@NotNull</code> , but this is not marked</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_on_parameters">5.4.5. On parameters</h4>
<div class="paragraph">
<p>Opposites:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a parameter is either  <code>@NotModified</code> (green) or  <code>@Modified</code>  (red)</p>
</li>
<li>
<p>a parameter is either  <code>@NotNull</code>  (or  <code>@NotNull1</code> , or  <code>@NotNull2</code> ) (green), or  <code>@Nullable</code>  (red)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if a type is  <code>@Container</code> , the parameters of all non-private methods and constructors are  <code>@NotModified</code> (green);</p>
</li>
<li>
<p>a parameter of primitive type, unbound parameter type, functional type, or  <code>@E2Immutable</code>  type, is always  <code>@NotModified</code> (green);</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if a type is  <code>@MutableModifiesArguments</code>  (red), at least one of its parameters is  <code>@Modified</code>  (red), which will be marked;</p>
</li>
<li>
<p>quite trivially, parameters of a primitive type are always  <code>@NotNull</code>   and  <code>@NotModified</code>, but we will not mark parameters of a primitive type.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="nullability">5.4.6. Nullability</h4>
<div class="paragraph">
<p>By convention,</p>
</div>
<div class="ulist">
<ul>
<li>
<p> <code>@NotNull1</code>  implies  <code>@NotNull</code> </p>
</li>
<li>
<p> <code>@NotNull2</code>  implies  <code>@NotNull</code> ,  <code>@NotNull1</code> </p>
</li>
<li>
<p>etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This way of working makes most sense in an immutable setting.</p>
</div>
</div>
<div class="sect3">
<h4 id="_eventually_and_effectively_immutable">5.4.7. Eventually and effectively immutable</h4>
<div class="paragraph">
<p>Field types and method return types can be eventually or effectively immutable when their formal type is not level 1 or level 2 immutable, but the dynamic or computed type is.
In the latter case, static analysis shows that all assignments to the field, or all return statements, result in an immutable object.
In the former case, object flow computation proves that the mark has been passed for this object to have become immutable.</p>
</div>
<div class="paragraph">
<p>When a type is level 1 or level 2 eventually immutable, and the object flow computation proves that all assignments or return statements yield an object which is in a state <em>before</em> the mark, the analyser will emit  <code>@BeforeMark</code> .</p>
</div>
<div class="paragraph">
<p>Fields take the annotation of the eventual state, with the qualification of <code>after="&#8230;&#8203;"</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">property</th>
<th class="tableblock halign-left valign-top">not present</th>
<th class="tableblock halign-left valign-top">eventually</th>
<th class="tableblock halign-left valign-top">effectively</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">finality of field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Variable</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Final(after="mark")</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Final</code> </p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">modification of field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Modified</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@NotModified(after="mark")</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@NotModified</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_technical"><em>Technical</em></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_the_analyser">6. The analyser</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_inspection">6.1. Inspection</h3>
<div class="paragraph">
<p>Special naming conventions for creating Java classes that hold annotations and companion methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Types</dt>
<dd>
<p>A sub-type immediately below the primary type in the file can have a dollar at the end.
This indicates that the sub-type becomes a primary type, with the name identical to the sub-type name without the dollar, and the package detailed by a static final field called <code>PACKAGE_NAME</code> in the primary type.</p>
</dd>
<dt class="hdlist1">Methods</dt>
<dd>
<p>the rare occasion of adding an annotation to <code>getClass</code>, which is final in <code>java.lang.Object</code>, requires a dollar at the end which the inspector will remove.</p>
</dd>
<dt class="hdlist1">Constructors</dt>
<dd>
<p>when the type has a $ at the end, the constructor has to follow.
The inspector removes the dollar silently.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Note that the name of the primary type holding the sub-types is completely irrelevant.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resolution">6.2. Resolution</h3>

</div>
<div class="sect2">
<h3 id="_analyser_implementation">6.3. Analyser implementation</h3>
<div class="sect3">
<h4 id="_code_structure">6.3.1. Code structure</h4>
<div class="paragraph">
<p><code>PrimaryTypeAnalyser</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>starts from a <code>SortedType</code>, which contains one <code>PrimaryType</code> and a list of <code>WithInspectionAndAnalysis</code> (methods, fields, sub-types)</p>
</li>
<li>
<p>creates and calls <code>TypeAnalyser</code>, <code>MethodAnalyser</code>, <code>FieldAnalyser</code>, and assigns <code>TypeAnalysis</code>, <code>MethodAnalysis</code>, <code>FieldAnalysis</code>
to <code>TypeInfo.typeAnalysis</code>, <code>MethodInfo.methodAnalysis</code>, <code>FieldInfo.fieldAnalysis</code>.</p>
</li>
<li>
<p>the <code>TypeAnalyser</code> creates, fills, and returns the <code>TypeAnalysis</code> object</p>
</li>
<li>
<p>the <code>FieldAnalyser</code> creates, fills, and returns the <code>FieldAnalysis</code> object</p>
</li>
<li>
<p>the <code>MethodAnalyser</code> creates, fills, and returns the <code>MethodAnalysis</code> object, but it also creates:</p>
<div class="ulist">
<ul>
<li>
<p><code>ParameterAnalyser</code> objects, which fill, create and return <code>ParameterAnalysis</code> objects</p>
</li>
<li>
<p><code>BlockAnalyser</code> objects, which fill, create and return <code>StatementAnalysis</code> objects.
Each <code>StatementAnalysis</code> object corresponds recursively to a <code>Statement</code> in the <code>methodBody</code> block.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>TypeResolution</code> contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the list of circular dependencies</p>
</li>
<li>
<p>the set of implicitly immutable data types for this type</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>TypeAnalysis</code> object holds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a map of constant object flows</p>
</li>
<li>
<p>a map of approved preconditions, ready for  <code>@Mark</code>  and  <code>@Only</code> </p>
</li>
<li>
<p>annotations and properties via the parent <code>Analysis</code> object</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>FieldResolution</code> contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a flag marking if the type is implicitly immutable</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>FieldAnalysis</code> object holds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the object flow of the field</p>
</li>
<li>
<p>an effectively final value, which is an instance of <code>FinalFieldValue</code> unless we know better; it is not set when the field is  <code>@Variable</code> </p>
</li>
<li>
<p>a list of variables linked to the field (other fields, parameters)</p>
</li>
<li>
<p>a set of internal object flows</p>
</li>
<li>
<p>an error map for marking illegal assignments</p>
</li>
<li>
<p>an error flag</p>
</li>
<li>
<p>annotations and properties via the parent <code>Analysis</code> object</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>MethodResolution</code> contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a set of methods of the same type that this method (transitively) calls</p>
</li>
<li>
<p>a flag noting whether it is part of construction</p>
</li>
<li>
<p>a flag whether it creates an object of itself</p>
</li>
<li>
<p>a flag indicating that it only calls static methods</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>MethodAnalysis</code> object holds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a single return value, if available</p>
</li>
<li>
<p>summary information about <code>This</code> (mostly modification, we can maybe reduce this to single boolean?)</p>
</li>
<li>
<p>a list of <code>StatementAnalysis</code> objects holding return value information.
<mark>NOTE</mark> we can also store them in the method analyser, there may not be a need to hold on to them.</p>
</li>
<li>
<p>a map of variables linked to fields and parameters</p>
</li>
<li>
<p>a set of variables linked to the return value(s) of the method</p>
</li>
<li>
<p>the joint precondition</p>
</li>
<li>
<p>the precondition part for  <code>@Mark</code>  and  <code>@Only</code> </p>
</li>
<li>
<p>information about possible  <code>@Mark</code>  and  <code>@Only</code>  annotations (can maybe moved directly into the annotations)</p>
</li>
<li>
<p>a set of internal object flows</p>
</li>
<li>
<p>the object flow of the method</p>
</li>
<li>
<p>a fair number of error flags</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>StatementAnalysis</code> object holds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>information about the statement: <code>Statement</code> reference, parent, next, list of blocks, indices and index</p>
</li>
<li>
<p>a flag indicating if the statement (or block represented by the initial statement of the block) ecapes</p>
</li>
<li>
<p>a flag indicating that the next statement is never reached</p>
</li>
<li>
<p>an error flag</p>
</li>
<li>
<p>a precondition represented by this statement</p>
</li>
<li>
<p>the state of the method after evaluating this statement</p>
</li>
<li>
<p>the precondition of the method after evaluating this statement</p>
</li>
<li>
<p>if the statement has an expression part, the value of the expression</p>
</li>
<li>
<p>replacement information</p>
</li>
<li>
<p>a flag indicating if the method flow reaches the statement</p>
</li>
<li>
<p>all variables referenced so far, and their properties (fully incremental)</p>
</li>
<li>
<p>dependency information so far</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Evaluation of expressions requires an <code>EvaluationContext</code> object which moves from statement to statement, applying resulting changes into the <code>StatementAnalysis</code> object after each evaluation.
Some of these changes then trickle down to the method analyser which updates the <code>MethodAnalysis</code> object.</p>
</div>
</div>
<div class="sect3">
<h4 id="_circular_dependencies">6.3.2. Circular dependencies</h4>
<div class="paragraph">
<p>The analyser approaches primary types independently, albeit in a carefully computed order of dependency between them.
When it detects a circular dependency between two or more primary types, it issues a warning to indicate that a different, less powerful modification detection algorithm kicks in.
We consider circular dependencies bad programming practice; generally, interfaces can be introduced to remedy this.
The manual modification annotations on the interface method effectively substitute for the assumptions that the less powerful modification algorithm makes.</p>
</div>
<div class="paragraph">
<p>Inside a primary type, the analyser deals with circular dependencies between the sub-types, the methods and the fields by running multiple iterations.
The main reason it has to do this is that all fields are visible to all sub-types, even if they are marked <code>private</code>.</p>
</div>
<div class="paragraph">
<p>The processing list determines the order in which the analyser processes fields, methods and sub-types.</p>
</div>
</div>
<div class="sect3">
<h4 id="_nested_classes">6.3.3. Nested classes</h4>
<div class="paragraph">
<p> <code>@Final</code> : across all methods in the primary type</p>
</div>
<div class="paragraph">
<p>Parent or enclosing type when non-static must be have the property as well:  <code>@E1Immutable</code> ,  <code>@E2Immutable</code> ,  <code>@Container</code> ,  <code>@Independent</code> .</p>
</div>
<div class="paragraph">
<p>What to do with abstract superclasses?
They cause a problem because of the abstract methods, which can have any modification status.
<mark>TODO</mark> think and implement.</p>
</div>
<div class="paragraph">
<p>Eventual?
<mark>TODO</mark> think and implement.</p>
</div>
</div>
<div class="sect3">
<h4 id="_modification_of_a_field">6.3.4. Modification of a field</h4>
<div class="paragraph">
<p>The code executes the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Wait until  <code>@Final</code>  or  <code>@Variable</code>  has been established.
If  <code>@Variable</code> , then the field becomes  <code>@Modified</code> .</p>
</li>
<li>
<p>If the field is of a functional interface type, the field is  <code>@NotModified</code> unless we can establish that there is an initializer or unambiguous constructor assignment with an explicit declaration (method reference, lambda, anonymous class implementation).</p>
</li>
<li>
<p>As a short-cut, determine that the field is  <code>@NotModified</code> if its type is level 2 immutable.
Whilst not technically necessary, this short-cut may resolve situations more quickly.</p>
</li>
<li>
<p>Wait until the field summaries in methods have been set.
This typically takes exactly one iteration, because a method which reads a field is later in the processing list.</p>
</li>
<li>
<p>Wait until modification information is available for those methods which read the field.
Importantly, we consider the methods (and SAM declarations of fields) of all types in the primary type.</p>
</li>
<li>
<p>Determine modification based on the modification information in the field summaries.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_modification_of_a_method">6.3.5. Modification of a method</h4>
<div class="paragraph">
<p>The code executes the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the method&#8217;s field summaries contains an assignment to any field, inside the primary type, then the method is  <code>@Modified</code> .</p>
</li>
<li>
<p>Wait until linking information (and hence modification information on fields) becomes available.</p>
</li>
<li>
<p>If any of the field summaries contains a marker for a modified field, then the method becomes  <code>@Modified</code> .
The analyser provides these marks when, amongst others, it sees a modifying method call on the field, or the field is an argument to a modifying parameter.</p>
</li>
<li>
<p>Next, check the modification status of <code>this</code> in <code>thisSummary</code>, when the analyser has observed a local method call.
The method is  <code>@Modified</code>  when the analyser has observed a modification to any of the <code>this</code> objects (<code>super</code>, &#8230;&#8203;).</p>
</li>
<li>
<p>Then, check the marker for circular method calls or undeclared functional interfaces.
In this situation, the modification status of the method depends on the presence of other modifying methods, non-private fields, on dependent methods.</p>
</li>
<li>
<p>Finally, check the marker to copy the modification status from another method.
The analyser issues this marker when the method passes on a functional interface argument to the other method.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_condition_and_state">6.3.6. Condition and state</h4>
<div class="paragraph">
<p>A method can have restrictions on the parameter and field values called <em>preconditions</em>.
In general, these restrictions end up as a boolean expression in <code>MethodAnalysis.precondition</code>.
The exception to this rule are the not-null and size restrictions on parameters, which become properties during evaluation, and are written out as separate annotations.</p>
</div>
<div class="paragraph">
<p>Preconditions that participate in  <code>@Mark</code>  and  <code>@Only</code>  are stored in <code>MethodAnalysis.preconditionForEventual</code>.
They are computed from normal preconditions.</p>
</div>
<div class="paragraph">
<p>As the analyser progresses through the blocks and statements, it keeps track of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the current <em>condition</em>, which is the boolean conjunction of all conditions in ever deeper <code>if</code> statements, (negated in the <code>else</code> block);</p>
</li>
<li>
<p>the current <em>state</em>, which is the boolean conjunction of all restrictions on variables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the condition, top-level disjunctions indicate independent statements, while in the state, top-level conjunctions indicate independent statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> method1(<span class="predefined-type">String</span> a, <span class="predefined-type">String</span> b) {
    <span class="keyword">if</span>(a == <span class="predefined-constant">null</span> || b == <span class="predefined-constant">null</span>) {
        <span class="comment">// condition and state are: a == null || b == null;</span>
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
    }
    <span class="comment">// state is: a != null &amp;&amp; b != null; empty condition</span>
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Java, because of short-circuiting, this is functionally identical to the 'independent' form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> method2(<span class="predefined-type">String</span> a, <span class="predefined-type">String</span> b) {
    <span class="keyword">if</span>(a == <span class="predefined-constant">null</span>) {
        <span class="comment">// condition and state are: a == null</span>
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
    }
    <span class="comment">// state is: a != null; empty condition</span>
    <span class="keyword">if</span>(b == <span class="predefined-constant">null</span>) {
        <span class="comment">// condition is: b == null; state is: a != null &amp;&amp; b == null</span>
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
    }
    <span class="comment">// state is: a != null &amp;&amp; b != null; empty condition</span>
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Condition and state travel deeper inside the blocks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> method3(<span class="predefined-type">String</span> a, <span class="predefined-type">String</span> b) {
    <span class="keyword">if</span>(a == <span class="predefined-constant">null</span>) {
        <span class="comment">// condition and state are: a == null</span>
        <span class="keyword">if</span>(b == <span class="predefined-constant">null</span>) {
            <span class="comment">// condition and state are: a == null &amp;&amp; b == null</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        }
        <span class="comment">// condition is: a == null; state is: a == null &amp;&amp; b != null</span>
        <span class="keyword">return</span>;
    }
    <span class="comment">// state is: a != null; empty condition</span>
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both in <code>method1</code> and <code>method2</code>, the escape via a runtime exception introduces  <code>@NotNull</code>  annotations on the parameters.
The analyser employs dedicated logic to ensure that in a second pass, it does not flag the condition in the <code>if</code> statement as a constant value.
In <code>method3</code>, the conjunction in the condition after two successive <code>if</code> statements does not allow for individual not-null restrictions.
The result is a precondition, annotated as <code>@Precondition("(not (null == a) or not (null == b))")</code>.
Note that, perhaps counter-intuitively, if we were to replace the <code>return</code> statement with a <code>throws</code> statement, it would have <code>a == null</code> as condition, and not <code>a == null &amp;&amp; b != null</code>.</p>
</div>
<div class="paragraph">
<p>The rules for adding and removing to condition and state are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>start the method with the state equal to the preconditions, if applicable;</p>
</li>
<li>
<p>when entering a conditional block, start a new <code>ConditionManager</code> with the statement&#8217;s expression added to the current condition and state;</p>
</li>
<li>
<p>when a conditional block does not return, add the boolean complement to the state;</p>
</li>
<li>
<p>in case of assignments or modifying methods, clear the state (partially);</p>
</li>
<li>
<p>the state of parameters and effectively final fields travels up from inside blocks, but only if these blocks are unconditional.
This is most notably the case for a <code>synchronized</code> block.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_computation_of_mark_only">6.3.7. Computation of @Mark, @Only</h4>
<div class="paragraph">
<p>The presence of eventual properties (level 1 immutable, level 2 immutable, content not null, &#8230;&#8203;) follows from the computation of the  <code>@Only</code>  and  <code>@Mark</code>  annotations.
Here, we document how the analyser computes them.</p>
</div>
<div class="paragraph">
<p>The analyser associates eventuality with a precondition on a field (or technically, on one or more fields); it labels the precondition with a mark string.
Methods that guard against the precondition are <em>before</em> the mark, methods that guard against the boolean complement are <em>after</em> the mark.
We define a guard here as the throwing of a run-time exception when the field&#8217;s value does not satisfy the condition.</p>
</div>
<div class="paragraph">
<p>Each method holds information about such a precondition in <code>SetOnce&lt;Eventual&gt; eventual</code>.
The <code>MethodAnalyser</code> computes the information in <code>computeOnlyMarkPrepWork</code> and <code>computeOnlyMarkAnnotate</code>.</p>
</div>
<div class="paragraph">
<p>Then, the <code>TypeAnalyser</code> combines the information of the methods in <code>analyseOnlyMarkEventuallyE1Immutable</code>; the end result of the whole computation resides in <code>SetOnceMap&lt;String, Value&gt; approvedPreconditions</code> in <code>TypeAnalysis</code>.
The keys are the different preconditions that have been approved for eventuality computation, the values are the associated mark strings consisting of the variable names of the fields in the precondition.
Note: the current implementation relies on the precondition to be lifted using an assignment rather than a content change; the code resides in the level 1 immutability check.
As a consequence, it is currently not possible to use the size of a collection, for example, as a precondition.</p>
</div>
<div class="paragraph">
<p>The eventual annotation will receive a comma-separated list with all the marks in <code>approvedPreconditions</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_statement_analyser">6.3.8. Statement analyser</h4>
<div class="paragraph">
<p>Steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create local variable (<code>for(T t: ts)</code>, assignment statement)</p>
</li>
<li>
<p>evaluate initialisers (classic <code>for</code>, <code>try</code> with resources, normal assignment statements).
The results of the initialisers need to be known to the evaluation context, but cannot be permanent yet.</p>
</li>
<li>
<p>evaluate updates (classic <code>for</code>).
The results of the updaters need to be known to the evaluation context, but cannot be permanent yet.</p>
</li>
<li>
<p>evaluate main expression (many statements).
The results need to be known to the evaluation context.</p>
</li>
<li>
<p>specific <code>return</code> statement code, update method-level data;</p>
</li>
<li>
<p>specific <code>if</code>, <code>switch</code> code to check evaluations to constant</p>
</li>
<li>
<p>primary block, recursive call; merge back by calling <code>lift</code></p>
</li>
<li>
<p>sub-blocks, recursive calls; merge back by calling <code>lift</code></p>
</li>
<li>
<p>determine state after this statement</p>
</li>
<li>
<p>finally, make the results of the evaluation(s) permanent by calling <code>finalise</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_post_and_pre_conditions">6.3.9. Post- and pre-conditions</h4>
<div class="paragraph">
<p>A non-modifying method without parameters can define an <em>aspect</em> of a type, like <code>size</code> or <code>length</code>.
We define methods complementary to a normal class or interface method, using the naming convention <em>method name$action$aspect</em>.
Let&#8217;s call them companion methods for now.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Modification+aspect</dt>
<dd>
<p>for modifying methods, show how the aspect changes from before to after the modification.</p>
</dd>
<dt class="hdlist1">Value (+aspect)</dt>
<dd>
<p>compute edge case values, and return the normal value otherwise.
Aspect can be used, but does not have to be present.</p>
</dd>
<dt class="hdlist1">Precondition</dt>
<dd>
<p>describe the precondition in terms of parameters or field values</p>
</dd>
<dt class="hdlist1">Invariant</dt>
<dd>
<p>without aspect present, it has to be a condition on fields which holds all the time.</p>
</dd>
<dt class="hdlist1">Invariant+aspect</dt>
<dd>
<p>this expression describes an invariant of the aspect.
For example, <code>size &gt;= 0</code>, before and after any method.</p>
</dd>
<dt class="hdlist1">Postcondition</dt>
<dd>
<p>describe the postcondition of the fields after the modification.
(This is the modification without aspect.)</p>
</dd>
<dt class="hdlist1">Transfer (+aspect)</dt>
<dd>
<p>assign state to the return element, transferring it from the current object.</p>
</dd>
<dt class="hdlist1">Generate</dt>
<dd>
<p>generate any other type of</p>
</dd>
<dt class="hdlist1">Erase</dt>
<dd>
<p>we need to think about something that erases state.
A <code>clear()</code> method on a collection should remove all <code>contains(x)</code> clauses.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Implementation issues:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get rid of SIZE and everything surrounding it</p>
</li>
<li>
<p>Parsing the methods, and storing them in the type in a reasonable data structure.
We&#8217;ll work with the evaluated inline-functions; they have a translation mechanism already built in.</p>
</li>
<li>
<p>The system generates preconditions, ensure that they can be tested.</p>
</li>
<li>
<p>From a companion method we have to translate.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_nullity_of_fields">6.3.10. Nullity of fields</h4>
<div class="paragraph">
<p>If the field is effectively final, it receives its values from</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>its initialiser</p>
</li>
<li>
<p>assignments in the constructor and methods that are exclusively part of the construction phase</p>
</li>
<li>
<p>modifying methods cannot change the value, but they can erase constructor information (<code>instance type X</code> instead of <code>new X(&#8230;&#8203;)</code>)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the field is variable, there can be assignments in public methods not part of the assignment phase.</p>
</div>
<div class="paragraph">
<p>Either way, nullity comes from both methods where an assignment take place, and methods where restrictions are placed on the nullity.
The latter can take place in modifying and non-modifying methods.</p>
</div>
<div class="paragraph">
<p>The statement analyser of the first occurrence of a field in a method introduces a value for the field <em>only when both the field&#8217;s value and its nullity are known</em>.
We need to ensure here that this rule will not be the cause of endless delay loops.</p>
</div>
<div class="paragraph">
<p>The expected complication is in methods where there is no value yet for the field, but we still expect the nullity of the field variable to be computed.
The field analyser must be able to grab this nullity independently of the value:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for each method, it needs to know if nullity computations have not been halted.
Typically, this is done in two stages:</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_loop_variables_overview">6.3.11. Loop variables overview</h4>
<div class="paragraph">
<p>Different situations</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>variable defined outside a loop</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>read in the loop, but not assigned in the loop: normal situation</p>
</li>
<li>
<p>assigned in the loop</p>
</li>
</ol>
</div>
</li>
<li>
<p>variable defined in the loop statement.
Either can be assigned inside the loop as well.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>for(String s: strings)</code></p>
</li>
<li>
<p><code>for(int i=0; i&lt;n; i++)</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>localVariablesAssignedInThisLoop</code> needs to be frozen before we know the distinction between situations 1 and 2.
As long as the latest assignment is before the loop, the variable in the loop is represented by <code>var$loop</code>.
Once we&#8217;re beyond the assignment, it becomes <code>var$loop$assigmentId</code>.</p>
</div>
<div class="paragraph">
<p>We make no distinction between <code>forEach</code> and <code>for</code>: in both cases, the variable is added to the <code>localVariablesAssignedInThisLoop</code> set.
While we could force the variable to be <code>final</code> in the former case, we&#8217;ll want different versions in case modifying methods are called on them.</p>
</div>
<div class="paragraph">
<p>In the <code>forEach</code> case, we assign a value, once, during the evaluation phase of the loop statement.</p>
</div>
</div>
<div class="sect3">
<h4 id="_general_property_computation">6.3.12. General property computation</h4>
<div class="paragraph">
<p>We have decided on a very strict <em>write once</em> system: once a value has been determined, it cannot be changed anymore.
Properties are written in a heavily controlled map of type <code>VariableProperties</code>.
The value <code>Level.DELAY</code> is never written in the map, as it indicates that no value has been determined yet.</p>
</div>
<div class="paragraph">
<p>In the statement analyser, property values travel from one statement to the next.
Therefore, the last statement often contains the relevant information for the other analysers to read.</p>
</div>
</div>
<div class="sect3">
<h4 id="_not_null_property">6.3.13. Not-null property</h4>
<div class="paragraph">
<p>Variables in the statement analyser can have not-null induced by the context (parameters in method calls, scope, etc).
At the same time, fields and parameters can get not-null values from the field and parameter analyser.
Combining both in a single, non-incremental value turns out to be impossible.
Therefore, we split, for every variable, non-null in</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>CONTEXT_NOT_NULL</code>: non-null value induced by context</p>
</li>
<li>
<p><code>NOT_NULL_EXPRESSION</code>: non-null value coming from assignments and statement context</p>
</li>
<li>
<p><code>EXTERNAL_NOT_NULL</code>: from the field analyser</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The combination of <code>CONTEXT_NOT_NULL</code> and <code>EXTERNAL_NOT_NULL</code> is the property called <code>NOT_NULL_EXPRESSION</code>, which is read-only unless there is a contract not-null.
It is delayed when one of its components is delayed.</p>
</div>
<div class="paragraph">
<p>While evaluating expressions, we use the property <code>NOT_NULL_EXPRESSION</code>.</p>
</div>
<div class="paragraph">
<p>The method analyser records the return value&#8217;s not-null in <code>NOT_NULL_EXPRESSION</code>, read from the return variable&#8217;s <code>NOT_NULL_EXPRESSION</code>.
The field analyser writes in <code>EXTERNAL_NOT_NULL</code>, and reads from the variables' <code>CONTEXT_NOT_NULL</code> (when no assignment was made), and the assignment&#8217;s values' <code>NOT_NULL_EXPRESSION</code>.</p>
</div>
<div class="paragraph">
<p>The parameter analyser maintains the two aspects: context from the statement analyser, and external from the field analyser.</p>
</div>
<div class="paragraph">
<p>The statement analyser uses the properties <code>CONTEXT_NOT_NULL_DELAY</code> and <code>CONTEXT_NOT_NULL_DELAY_RESOLVED</code> to control a delay on <code>CONTEXT_NOT_NULL</code>, when a method&#8217;s not-null properties, where the variable occurs as argument, have not been analysed yet.</p>
</div>
<div class="paragraph">
<p>It is important to record the flow of the properties, and especially the mechanisms to break delays when no information is present.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">In the statement analyser</dt>
<dd>
<p>Let us consider the following cases:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the variable occurs in the <code>ChangeData</code> of <code>apply</code> of the main expression: any delays are resolved to <code>NULLABLE</code>, when no context not-null delay is present</p>
</li>
<li>
<p>the variable does not occur in the <code>ChangeData</code>, but is still involved (say the local copy of a variable field <code>s$0</code>)</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">In the field analyser</dt>
<dt class="hdlist1">In the parameter analyser</dt>
<dd>
<p>Once a context not-null is known in the statement analyser&#8217;s last statement, the parameter&#8217;s value can be set.
Important: this is one-way traffic!
The first statement does NOT copy this value into the 'INITIAL'.
Once a value can come from a field, the parameter analyser will copy it.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_modification_property">6.3.14. Modification property</h4>
<div class="paragraph">
<p>The property indicating modification of a variable has been split in the same way as the not-null property:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>variables in statements use <code>CONTEXT_MODIFIED</code> and <code>MODIFIED_OUTSIDE_METHOD</code>, summarized in <code>MODIFIED_VARIABLE</code>.</p>
</li>
<li>
<p>the method&#8217;s modification status is in <code>MODIFIED_METHOD</code></p>
</li>
<li>
<p>a field&#8217;s modification is in <code>MODIFIED_OUTSIDE_METHOD</code></p>
</li>
<li>
<p>modification of <code>this</code> is recorded in <code>METHOD_CALLED</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The statement analyser uses the properties <code>METHOD_DELAY</code> and <code>METHOD_DELAY_RESOLVED</code> to control a delay on <code>CONTEXT_MODIFIED</code>, when a method&#8217;s modification properties, where the variable occurs as argument or scope, have not been analysed yet.</p>
</div>
<div class="paragraph">
<p>Again let us record the flow of properties and delay-breaking mechanisms:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">In the statement analyser</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>should normally be broken in <code>MethodLevelData</code>, compute modification.</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">In the parameter analyser</dt>
<dd>
<p>Entirely the same as for the not-null.
=== Statement analysis</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>There is one <code>StatementAnalysis</code> object per statement, so a method consists of a chain of statements.
All variables that exist in statement <em>i</em> will exist in statement <em>i+1</em> as well.
A method&#8217;s last statement is the place to find the final value of non-local variables.</p>
</div>
<div class="paragraph">
<p>Statement analysis is carried out until all statement analysers reach status <code>DONE</code>.
A statement analyser <em>i+1</em> cannot reach done unless <em>i</em> is already has reached <code>DONE</code>.
Four main aspects control delays in the statement analyser:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the status of the analyser of the previous statement</p>
</li>
<li>
<p>the value of variables</p>
</li>
<li>
<p>the linked variable set of variables</p>
</li>
<li>
<p>the three expressions in the condition manager: condition, state, pre-condition</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_variables">6.4. Variables</h3>
<div class="paragraph">
<p>We recognize the following types of variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fields, where it is important whether the field is effectively final, variable, or as yet undecided in the first iteration(s)</p>
</li>
<li>
<p>parameters, which are non-assignable</p>
</li>
<li>
<p>local variables, among which copies of variable fields and versions of variables used in loops but defined outside them</p>
</li>
<li>
<p><code>this</code>, <code>super</code></p>
</li>
<li>
<p>dependent variables, like the cells in an array; mostly treated as local variables</p>
</li>
<li>
<p>one return variable for each method, which is assigned a value in a <code>return</code> statement</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some variables never leave the statement analyser(s).
However, there are important information flows:</p>
</div>
<div class="paragraph">
<p>The method analyser reads</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the fact whether fields have been assigned to help decide on the modification of the method;</p>
</li>
<li>
<p>the value of the return variable of the last statement to decide on the method&#8217;s return value;</p>
</li>
<li>
<p>the modification properties of the <code>this</code> and <code>super</code> variables to help decide on the modification of the method.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The field analyser reads</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>almost all information about the fields occurring in the last statement</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The parameter analyser reads</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>properties of the parameter variables in the last statement</p>
</li>
<li>
<p>properties and from the field analyser in case a parameter has been assigned to a field or linked to a field</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The statement analyser copies back information</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>from the field analyser, about fields occurring in the statement</p>
</li>
<li>
<p>from the parameter analyser</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It is important to note that there is very limited 'circular' information flow.</p>
</div>
<div class="paragraph">
<p>Fields are created in the statement analyser only when they occur.
Given the write-once nature of the design, their value remains undecided until the field analyser has decided whether the variable is effectively final or not.
In the latter case, the actual value of a field can change from one statement to the next (or even within statements); this requires additional logic.</p>
</div>
<div class="paragraph">
<p>Modification and linking is a one-way flow from</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>main computation is in the statement analyser</p>
</li>
<li>
<p>from the statement analyser to the field analyser: the computation of <code>CONTEXT_MODIFIED</code>, closely coupled with the computation of the linked variables of a field variable.
All variables start in the first statement with an empty set of linked variables, and a <code>Level.FALSE</code> value for the context modification, unless the user explicitly contracted the modification status of the parameter with an annotation.</p>
</li>
<li>
<p>from the field analyser to parameter analyser: in the form of the <code>MODIFIED_IN_METHOD</code> property, which ends up combined with <code>CONTEXT_MODIFIED</code> into the parameter&#8217;s final <code>MODIFIED_VARIABLE</code> property determining its  <code>@Modified</code> / <code>@NotModified</code> annotation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>External not-null (ENN) travels from the parameter analyser back to the statement analysers, after values of fields have been established.
Because a statement reaches <code>DONE</code> status as soon as value and linked variables have been established, an explicit delay system exists to make sure that statemens which involve fields with a delayed ENN are revisited once.</p>
</div>
<div class="sect3">
<h4 id="_variable_fields">6.4.1. Variable fields</h4>
<div class="paragraph">
<p>Variable fields interact with synchronisation.
A time increase is equivalent to an opportunity for another thread to update the content of variable fields.</p>
</div>
<div class="paragraph">
<p>The analyser can determine if a method increases time when called.
Calls to non-private methods always increase time because the user can override them.
Certain statements increase time (<code>try-catch</code>, <code>synchronized</code>).
The method resolver determines if a method increases time or not.</p>
</div>
<div class="paragraph">
<p>The statement analyser keeps track of time.
Determining time obviously depends on the methods being called, but because the method resolver determines if a method increases time, this happens in a deterministic way in the first iteration of the analyser.</p>
</div>
</div>
<div class="sect3">
<h4 id="_different_variable_states">6.4.2. Different variable states</h4>
<div class="paragraph">
<p>Each statement analyser keeps up to three different states for each variable:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Initial state</dt>
<dd>
<p>the initial state is either the state as inherited from the previous statement, or the variable&#8217;s initial state.
The latter situation occurs for every variable introduced in the first statement of each method.</p>
</dd>
<dt class="hdlist1">Evaluation state</dt>
<dd>
<p>the state after evaluation of the main expression of the statement.
Obviously, not all statements have such an expression, or the variable may not occur at all in the expression, in which case the evaluation state can be skipped.</p>
</dd>
<dt class="hdlist1">Merge state</dt>
<dd>
<p>if the statement has sub-blocks, a summary state exists to allow progressing to the next statement.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Information always travels from initial, potentially via evaluation, to merge; never in a different order!
The analyser computes the evaluation of statement <em>i</em> before starting the statement analyser of the sub-blocks, and computes the merge of statement <em>i</em> after all statement analysers in all sub-blocks have been activated.</p>
</div>
<div class="paragraph">
<p>We use suffixes <code>-C</code>, <code>-E</code> and <code>:M</code> respectively, which means that the following comparisons hold alphanumerically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="integer">0</span>-C &lt; <span class="integer">0</span>-E &lt; O<span class="float">.0</span><span class="float">.0</span>-C &lt; <span class="float">0.0</span><span class="float">.0</span>-E &lt; <span class="float">0.0</span><span class="float">.0</span>:M &lt; <span class="float">0.0</span><span class="float">.1</span>-C &lt; ... &lt; <span class="integer">0</span>:M &lt; <span class="integer">1</span>-C &lt; ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_data_stored_for_a_variable">6.4.3. Data stored for a variable</h4>
<div class="paragraph">
<p>The <code>VariableInfo</code> objects hold the following data:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Variable</dt>
<dd>
<p>the variable being stored.
Always present from the start.</p>
</dd>
<dt class="hdlist1">Assignment ID</dt>
<dd>
<p>A marker for when this particular <code>VariableInfo</code> object is created.
It contains the statement index, and the level in the container, separated by a colon.
This value is present from the creation of the <code>VariableInfo</code> object, even though it can vary across <code>VariableInfo</code> objects for the same variable.</p>
</dd>
<dt class="hdlist1">Value</dt>
<dd>
<p>starts off with <code>NO_VALUE</code> (not assigned), and becomes immutable when it receives a value.</p>
</dd>
<dt class="hdlist1">Linked variables</dt>
<dd>
<p>start off with <code>null</code>, and becomes immutable when it receives a value.
Bar one exception, the linked variables come with the assignment of a value, potentially in a later iteration.
The linked variables of a variable field change when the analyser creates a new local copy for reading, i.e., outside an assignment.</p>
</dd>
<dt class="hdlist1">Properties</dt>
<dd>
<p>a properties map, with <code>Level.DELAY</code> being the default value.</p>
</dd>
<dt class="hdlist1">Statement time</dt>
<dd>
<p>a constant <code>NOT_A_VARIABLE_FIELD</code> for all non-variable fields.
For fields, starts off with <code>VARIABLE_FIELD_DELAYED</code> (not assigned) until we know if the field is variable or not.
Then, for variable fields, it stores the statement time of the latest assignment.</p>
</dd>
<dt class="hdlist1">Object flow</dt>
<dd>
<p>generally also set during an assignment.
The value <code>NO_FLOW</code> is used when no value as been set.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>All these fields are immutable once they have been set, except the <code>properties</code> map, which is incremental.
The <code>READ</code> and <code>ASSIGNED</code> properties have the following special behaviour: &#8230;&#8203; <mark>TODO</mark></p>
</div>
</div>
<div class="sect3">
<h4 id="_tests_basics_0">6.4.4. Tests: Basics_0</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> effectivelyFinal = <span class="string"><span class="delimiter">&quot;</span><span class="content">abc</span><span class="delimiter">&quot;</span></span>;
<span class="directive">public</span> <span class="predefined-type">String</span> getEffectivelyFinal() {
    <span class="keyword">return</span> effectivelyFinal;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Analysers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Statement analyser, iteration 0, statement 0, return statement.
The field <code>effectivelyFinal</code> does not yet exist in the list of variables; the change data yields a <code>FieldReference</code> pointing to a value of <code>NO_VALUE</code>, and a marker that the variable is read in this statement.</p>
</li>
<li>
<p>Method analyser: <mark>TODO</mark></p>
</li>
<li>
<p>Field analyser, iteration 0: it is immediately clear that the field is explicitly final, and that the initialiser is level 2 immutable.
Therefore, an effectively final value can be assigned: <code>"abc"</code>.
Everything can be concluded.</p>
</li>
<li>
<p>Statement analyser, iteration 1: at initialisation, the variable is created, and the effectively final value is filled.
The main evaluation can therefore return a value.
The return variable can also be set.</p>
</li>
<li>
<p>Method analyser: can conclude all except for the approved pre-conditions, which will remain unresolved?</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_tests_basics_1">6.4.5. Tests: Basics_1</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; f1;

<span class="directive">public</span> Basics_1(<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; p0, <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; p1, <span class="predefined-type">String</span> p2) {
    <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; s1 = p0;
    <span class="local-variable">this</span>.f1 = s1;
}

<span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; getF1() { <span class="keyword">return</span> f1; }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Iteration 0, statement analyser for the constructor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>statement 0: at initialisation, <code>this</code> and the three parameters are created as variables, in the <code>INITIAL</code> phase.
The local variable <code>s1</code> is created, and assigned to the first parameter.
Both exist in <code>EVAL</code> phase, one with an assignment id, the other with a read id.</p>
</li>
<li>
<p>statement 1: a field reference is created, and assigned the value <code>p0</code>.
The field is linked to this parameter.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Iteration 0, statement analyser for the getter:
* statement 0: the field does not yet exist in the list of variables.
It is marked as read during evaluation, and will be created during the initialisation step of the next iteration.
The return variable has been created at initialisation, but for now has no value.</p>
</div>
<div class="paragraph">
<p>Iteration 0, field analyser:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the field is marked as effectively final.</p>
</li>
<li>
<p>because there is no /</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Iteration 1, statement analyser for getter:
* the field <code>f1</code> has the value <code>instance type Set&lt;String&gt;</code>, not linked locally.
* the return variable points to the field <code>f1</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">IMPORTANT</dt>
<dd>
<p>We could also return the value of <code>f1</code> in the return statement, but at the moment we don&#8217;t think it matters that much.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Iteration 1, field analyser:
Modification is determined, as is nullability.</p>
</div>
<div class="paragraph">
<p>Iteration 2: parameter analyser: the <code>@NotNull</code> of the field travels to the parameter.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tests_modification_0">6.4.6. Tests: Modification_0</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; set1 = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;();

<span class="directive">public</span> <span class="type">void</span> add(<span class="annotation">@NotNull</span> <span class="predefined-type">String</span> v) {
    set1.add(v);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Iteration 0, statement analyser in <code>add</code>, statement 0:
* the expression evaluates to <code>NO_VALUE</code> as <code>set1</code> is not a known variable</p>
</div>
<div class="paragraph">
<p>Iteration 0, field analyser:
* the field is explicitly final.
We don&#8217;t have to wait for modification since the field is public.</p>
</div>
<div class="paragraph">
<p>Iteration 1, statement analyser in <code>add</code>: Value, linked variables, and <code>@Modified</code> determined.</p>
</div>
</div>
<div class="sect3">
<h4 id="_breaking_delays">6.4.7. Breaking delays</h4>
<div class="paragraph">
<p>Break that only works partially, in iteration 1+ assignment from analyser to variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"> <span class="keyword">if</span> (initialValue.expressionIsDelayed &amp;&amp; notYetAssignedToWillBeAssignedToLater) {
    <span class="predefined-type">String</span> objectId = index + <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span> + fieldReference.fieldInfo.fullyQualifiedName();
    <span class="predefined-type">Expression</span> initial = NewObject.initialValueOfField(objectId,
        primitives, fieldReference.parameterizedType());
    initialValue = <span class="keyword">new</span> ExpressionAndDelay(initial, <span class="predefined-constant">false</span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinite when break not present, with break the analyser works fine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">FirstThen_0</span>&lt;S&gt; {

    <span class="directive">private</span> S first;

    <span class="directive">public</span> FirstThen_0(<span class="annotation">@NotNull</span> S first) {
        <span class="local-variable">this</span>.first = Objects.requireNonNull(first);
    }

    <span class="directive">public</span> <span class="type">void</span> set() {
        <span class="keyword">if</span> (first == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Already set</span><span class="delimiter">&quot;</span></span>);
        first = <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinite when break not present, too early with break:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Singleton_7</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">boolean</span> created;

    <span class="directive">public</span> Singleton_7(<span class="type">int</span> k) {
        <span class="keyword">if</span> (created) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        created = <span class="predefined-constant">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinite either way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Project_2</span> {

    <span class="directive">static</span> <span class="type">class</span> <span class="class">Container</span> {
        <span class="directive">final</span> <span class="predefined-type">String</span> value;

        <span class="directive">public</span> <span class="predefined-type">Container</span>(<span class="predefined-type">String</span> value) {
            <span class="local-variable">this</span>.value = value;
        }
    }

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Container</span>&gt; kvStore = <span class="keyword">new</span> <span class="predefined-type">ConcurrentHashMap</span>&lt;&gt;();

    <span class="directive">public</span> <span class="predefined-type">String</span> set(<span class="predefined-type">String</span> key, <span class="predefined-type">String</span> value) {
        <span class="predefined-type">Container</span> prev = kvStore.get(key);
        <span class="keyword">if</span> (prev == <span class="predefined-constant">null</span>) {
            <span class="keyword">new</span> <span class="predefined-type">Container</span>(value); <span class="comment">// removing container also solves the problem</span>
        }
        <span class="keyword">return</span> prev.value; <span class="comment">// cause of the problem (change to key or constant solves the issue)</span>
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_supporting_tools">7. Supporting tools</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_gradle_plugin">7.1. Gradle plugin</h3>
<div class="paragraph">
<p>The Gradle plugin greatly facilitates the use of the analyser by integrating it your project&#8217;s build process.
We based its initial implementation on the one from <a href="https://www.sonarqube.org/" target="_blank" rel="noopener">SonarQube</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example of <code>build.gradle</code> file</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">plugins {
    id <span class="string"><span class="delimiter">'</span><span class="content">java</span><span class="delimiter">'</span></span>
    id <span class="string"><span class="delimiter">'</span><span class="content">org.e2immu.analyser</span><span class="delimiter">'</span></span>
}

...

repositories {
    ...
}

dependencies {
   ...
}

e2immu {
    skipProject = <span class="predefined-constant">false</span>
    sourcePackages = <span class="string"><span class="delimiter">'</span><span class="content">org.e2immu.</span><span class="delimiter">'</span></span>
    jmods = <span class="string"><span class="delimiter">'</span><span class="content">java.base.jmod,java.se.jmod</span><span class="delimiter">'</span></span>
    jre = <span class="string"><span class="delimiter">'</span><span class="content">/Library/Java/JavaVirtualMachines/openjdk-11.0.2.jdk/Contents/Home/</span><span class="delimiter">'</span></span>
    writeAnnotatedAPIPackages = <span class="string"><span class="delimiter">'</span><span class="content">org.e2immu.</span><span class="delimiter">'</span></span>
    writeAnnotationXMLPackages = <span class="string"><span class="delimiter">'</span><span class="content">org.e2immu.</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The list of properties configurable differs slightly from the one of the command line.
Gradle takes care of source and class path.</p>
</div>
</div>
<div class="sect2">
<h3 id="_key_value_store">7.2. Key-value store</h3>
<div class="paragraph">
<p>The key-value store is a simple, two-class implementation of an independent key-value store acting as a bridge between the  <em>e2immu</em>  analyser and the  IntelliJ IDEA  plugin.
It is mostly agnostic to the purpose in the project: it stores key-value pairs in sub-stores called projects.</p>
</div>
<div class="paragraph">
<p>Unless directed differently by the <code>e2immu-port</code> parameter, the store starts listening on port 8281 for HTTP communication.
The protocol summary is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text"># get an annotation name for an element
# curl http://localhost:8281/v1/get/project-name/element-description
#
# set the annotation name for an element
# curl http://localhost:8281/v1/set/project-name/element-description/annotation-name
#
# get annotation names for a whole list of elements
# curl -X POST @elements.json http://localhost:8281/v1/get/project-name
#
# set the annotation names for a whole map of elements
# curl -X PUT @elementsandannotations.json http://localhost:8281/v1/set/project-name
#
# get all key-value pairs for a project
# curl http://localhost:8281/v1/list/project-name
#
# list all projects
# curl http://localhost:8281/v1/list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Projects that do not exist will be created on-demand.
The bulk <em>get</em> operation may receive more elements than that it asked for:
depending on the effects of recent <em>set</em> operations, the store may include recently updated keys that were asked for recently as well.</p>
</div>
<div class="paragraph">
<p>Start the store by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell script">~/g/e/annotation-store (master)&gt; gradle run

&gt; Task :annotation-store:run
Aug 01, 2020 9:19:55 AM org.e2immu.kvstore.Store
INFO: Started kv server on port 8281; read-within-millis 5000
&lt;=========----&gt; 75% EXECUTING [1m 39s]
&gt; :annotation-store:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>In another terminal, experiment with the <code>curl</code> statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell script">~&gt; curl http://localhost:8281/v1/get/default/hello
{&quot;hello&quot;:&quot;&quot;}⏎
~&gt; curl http://localhost:8281/v1/set/default/hello/there
{&quot;updated&quot;:1,&quot;ignored&quot;:0,&quot;removed&quot;:0}⏎
~&gt; curl http://localhost:8281/v1/get/default/hello
{&quot;hello&quot;:&quot;there&quot;}⏎
~&gt; curl http://localhost:8281/v1/set/default/its/me
{&quot;updated&quot;:1,&quot;ignored&quot;:0,&quot;removed&quot;:0}⏎
~&gt; curl http://localhost:8281/v1/list/default
{&quot;its&quot;:&quot;me&quot;,&quot;hello&quot;:&quot;there&quot;}⏎
~&gt; curl http://localhost:8281/v1/list
{&quot;projects&quot;:[&quot;default&quot;]}⏎</code></pre>
</div>
</div>
<div class="paragraph">
<p>Removing a key-value pair only works via the PUT method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell script">~&gt; curl http://localhost:8281/v1/set/default/its/
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Resource not found&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;⏎
~&gt; cat update.json
{&quot;its&quot;:&quot;&quot;,&quot;hello&quot;:&quot;here&quot;}
~&gt; curl -X PUT -d @update.json  http://localhost:8281/v1/set/default
{&quot;updated&quot;:1,&quot;ignored&quot;:0,&quot;removed&quot;:1}⏎
~&gt; curl http://localhost:8281/v1/list/default
{&quot;hello&quot;:&quot;here&quot;}⏎</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_intellij_idea_plugin">7.3.  IntelliJ IDEA  plugin</h3>
<div class="paragraph">
<p>Without a plugin for an IDE, the analyser would be hard to use, and the main purpose of the project, namely, unobtrusively assisting in better coding, would remain very far off.
The current plugin for  IntelliJ IDEA  is absolutely minimal.
We based our initial implementation on the <a href="https://plugins.jetbrains.com/plugin/13303-return-highlighter" target="_blank" rel="noopener">Return statement highlighter plugin</a> by Edoardo Luppi.</p>
</div>
<div class="sect3">
<h4 id="visual-objectives">7.3.1. Visual objectives</h4>
<div class="paragraph">
<p>For the proof of concept, we aim to color elements of the source code in such a way that there is visual information explaining why a type is not  <code>@E2Immutable</code>  or  <code>@Container</code> .
In the green mode, we highlight the immutable elements, which useful when they are sparse.
In the red mode, we warn for mutable ones in an otherwise pretty immutable environment:</p>
</div>
<div class="paragraph">
<p>Following the <a href="#annotation-hierarchy">Relations between annotations</a> for types, we color:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">annotation on type</th>
<th class="tableblock halign-left valign-top">green mode</th>
<th class="tableblock halign-left valign-top">red mode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@E2Container</code>  (incl. primitives)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">green</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@E2Immutable</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">green</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@E1Container</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">brown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">brown</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@E1Immutable</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">brown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">brown</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Container</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">blue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">blue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@MutableModifiesArguments</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">red</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@BeforeMark</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">purple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">purple</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For fields, we note that  <code>@Variable</code> - <code>@Final</code>  and  <code>@NotModified</code>- <code>@Modified</code>  can technically occur in each combination:</p>
</div>
<div class="ulist">
<ul>
<li>
<p> <code>@Variable</code>   <code>@Modified</code> : impossible for unmodifiable types</p>
</li>
<li>
<p> <code>@Variable</code>   <code>@NotModified</code></p>
</li>
<li>
<p> <code>@Final</code>   <code>@Modified</code> : part of  <code>@E1Immutable</code> , impossible for unmodifiable types</p>
</li>
<li>
<p> <code>@Final</code>   <code>@NotModified</code>: part of  <code>@E2Immutable</code> </p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We therefore color the annotation hierarchy for fields as:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">combination</th>
<th class="tableblock halign-left valign-top">annotation on field</th>
<th class="tableblock halign-left valign-top">green mode</th>
<th class="tableblock halign-left valign-top">red mode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Variable</code>   <code>@Modified</code> </p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock"> <code>@Variable</code> </p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">black</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">red</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Variable</code>   <code>@NotModified</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Final</code>   <code>@Modified</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Modified</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">brown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">brown</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Final</code>   <code>@NotModified</code>, unmodifiable types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Final</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">green</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Final</code>   <code>@NotModified</code>, modifiable types only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@NotModified</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">green</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@SupportData</code>  (when field  <code>@NotModified</code> and owning type  <code>@E1Immutable</code> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@SupportData</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">green italics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black italics</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The  <code>@SupportData</code>  annotation is relevant to understand why a type is not level 2 immutable.
In other situations, it simply clutters.
The analyser will only emit it when the type is already  <code>@E1Immutable</code>  or  <code>@E1Container</code> , and the field is already  <code>@NotModified</code>.</p>
</div>
<div class="paragraph">
<p>The plugin transfers dynamic type annotations involving immutability (such as  <code>@E2Container</code> ) from the field to the type.
As a consequence, the left-hand side <code>Set</code> type will color green in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; strings = <span class="predefined-type">Set</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">abc</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">def</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>according to the first color scheme.</p>
</div>
<div class="paragraph">
<p>Methods declarations mix dependency with modification.
Independence is not necessary when there are no support types, and, given that we only start showing support data types when all fields are  <code>@NotModified</code>, which implies that all methods are  <code>@NotModified</code>, it makes sense to emit the dependency annotations only in the  <code>@NotModified</code> situation:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 60%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">annotation on method</th>
<th class="tableblock halign-left valign-top">green mode</th>
<th class="tableblock halign-left valign-top">red mode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Independent</code>  (implying  <code>@NotModified</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">green</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Dependent</code>  (implying  <code>@NotModified</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">brown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">brown</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@NotModified</code> (no support data)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">green</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Modified</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">red</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The interesting aspect to constructors is whether they are independent or not.
To be consistent with the system for methods, the analyser will only emit the annotation when the type is showing support data.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 60%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">annotation on constructor</th>
<th class="tableblock halign-left valign-top">green mode</th>
<th class="tableblock halign-left valign-top">red mode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Independent</code>  (when support data)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">green</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Dependent</code>  (when support data)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">brown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">brown</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no support data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The situation of parameters is binary.
The analyser colors:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">annotation on parameter</th>
<th class="tableblock halign-left valign-top">green mode</th>
<th class="tableblock halign-left valign-top">red mode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@NotModified</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">green</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Modified</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">red</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_information_flow">7.3.2. Information flow</h4>
<div class="paragraph">
<p>Exactly which information does the analyser store in the key-value store?
The keys are type names, method names, parameter names, or field names in a format that both analyser and plugin understand:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for a type, we use the fully qualified name, with sub-types separated by dots;</p>
</li>
<li>
<p>for a method, we use the <em>distinguishing name</em>, which is a slightly custom format that looks like</p>
<div class="paragraph">
<p>type&#8217;s fully qualified name '.' method name '(' parameter type ',' parameter type &#8230;&#8203; ')'</p>
</div>
<div class="paragraph">
<p>where the parameter type is 'T#2' or 'M#0' when it is the third type parameter of the method&#8217;s type, or the first type parameter of the method, respectively.
If the parameter type is not a type parameter, the fully qualified name suffices;</p>
</div>
</li>
<li>
<p>for a parameter, we append the '#' sign followed by the index to the method&#8217;s distinguishing name, starting from 0;</p>
</li>
<li>
<p>for a field, we use the fully qualified name of the type, a ':', and the name of the field.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On top of that comes the combination of a type and a field or method for the dynamic type annotations of fields and methods:
the composite key is the field&#8217;s or method&#8217;s key followed by a space, and the type&#8217;s key.</p>
</div>
<div class="paragraph">
<p>The values consist of a single annotation type name in lowercase, like <em>e2immutable</em> or <em>notmodified</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementation">7.3.3. Implementation</h4>
<div class="paragraph">
<p>The <code>JavaAnnotator</code> class links the plugin to the abstract syntax tree (or PSI in IntelliJ-speak).
It is instrumental to decide which textual elements are to be highlighted.</p>
</div>
<div class="paragraph">
<p>The plugin framework creates the annotator on the basis of the <code>java.xml</code> configuration file.
It is statically connected to the <code>JavaConfig</code> singleton instance which holds the configuration of the plugin.</p>
</div>
<div class="paragraph">
<p>It is also statically connected to the <code>AnnotationStore</code> singleton which is responsible for the assignment of elements to annotations.
Elements will be described in a standardized format which will extend fully qualified type names.
Annotations will be described as the simple names of the e2immu annotations.</p>
</div>
<div class="paragraph">
<p>The annotation store connects to an external server whose address is modifiable in the plugin configuration.
By default, it connects to a local instance on <a href="http://localhost:8281" class="bare">http://localhost:8281</a>. For now, this is a key-value store which keeps track of request and update times.</p>
</div>
<div class="paragraph">
<p>The annotation store keeps a cache where elements have a certain TTL.
As soon as an element is not in the cache, the plugin requests the annotation value from the external server.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_where_next"><em>Where next?</em></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_copyright_and_license">8. Copyright and License</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Copyright &#169; 2020-2021, Bart Naudts, <a href="https://www.e2immu.org" class="bare">https://www.e2immu.org</a></p>
</div>
<div class="paragraph">
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
See the GNU Lesser General Public License for more details.
You should have received a copy of the GNU Lesser General Public License along with this program.
If not, see <a href="http://www.gnu.org/licenses/" class="bare">http://www.gnu.org/licenses/</a>.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-04-13 12:17:22 +0200
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</body>
</html>