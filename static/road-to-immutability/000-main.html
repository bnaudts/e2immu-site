<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="description" content="A walk-through of the concepts and definitions of _e2immu_">
<meta name="author" content="Bart Naudts &lt;bart.naudts@e2immu.org&gt;">
<title>The road to immutability</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>The road to immutability</h1>
<div class="details">
<span id="author" class="author">Bart Naudts &lt;bart.naudts@e2immu.org&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_dedication">Dedication</a></li>
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#assumptions">2. Assumptions</a></li>
<li><a href="#_the_purpose_of_annotations">3. The purpose of annotations</a></li>
<li><a href="#_level_1_immutability">4. Level 1 immutability</a></li>
<li><a href="#modification">5. Modification</a></li>
<li><a href="#_containers">6. Containers</a></li>
<li><a href="#linking-and-independence">7. Linking and independence</a></li>
<li><a href="#_level_2_immutability">8. Level 2 immutability</a>
<ul class="sectlevel2">
<li><a href="#_definition">8.1. Definition</a></li>
<li><a href="#dynamic-type-annotations">8.2. Dynamic type annotations</a></li>
<li><a href="#inheritance">8.3. Inheritance</a></li>
</ul>
</li>
<li><a href="#eventual-immutability">9. Eventual immutability</a>
<ul class="sectlevel2">
<li><a href="#_builders">9.1. Builders</a></li>
<li><a href="#_definition_2">9.2. Definition</a></li>
<li><a href="#_propagation">9.3. Propagation</a></li>
<li><a href="#_before_the_mark">9.4. Before the mark</a></li>
<li><a href="#_extensions_of_annotations">9.5. Extensions of annotations</a></li>
</ul>
</li>
<li><a href="#modification-part2">10. Modification, part2</a>
<ul class="sectlevel2">
<li><a href="#_cyclic_references">10.1. Cyclic references</a></li>
<li><a href="#linking-formally">10.2. Linking, formally</a></li>
<li><a href="#_abstract_methods_and_functional_interfaces">10.3. Abstract methods and functional interfaces</a></li>
</ul>
</li>
<li><a href="#higher-level-modifications">11. Higher-level modifications</a>
<ul class="sectlevel2">
<li><a href="#_propagating_modifications">11.1. Propagating modifications</a></li>
<li><a href="#content-linking">11.2. Content linking</a></li>
<li><a href="#_iterator_iterable_loops">11.3. Iterator, Iterable, loops</a></li>
<li><a href="#_extending_implicitly_immutable_types">11.4. Extending implicitly immutable types</a></li>
<li><a href="#_implications_for_immutability">11.5. Implications for immutability</a></li>
</ul>
</li>
<li><a href="#support-classes">12. Support classes</a>
<ul class="sectlevel2">
<li><a href="#support-flipswitch">12.1. FlipSwitch</a></li>
<li><a href="#support-setonce">12.2. SetOnce</a></li>
<li><a href="#support-eventuallyfinal">12.3. EventuallyFinal</a></li>
<li><a href="#support-freezable">12.4. Freezable</a></li>
<li><a href="#support-setoncemap">12.5. SetOnceMap</a></li>
<li><a href="#support-lazy">12.6. Lazy</a></li>
<li><a href="#support-firstthen">12.7. FirstThen</a></li>
<li><a href="#in-the-analyser">12.8. Support classes in the analyser</a></li>
</ul>
</li>
<li><a href="#_other_annotations">13. Other annotations</a>
<ul class="sectlevel2">
<li><a href="#nullable-section">13.1. Nullable, not null</a></li>
<li><a href="#identity-and-fluent">13.2. Identity and fluent methods</a></li>
<li><a href="#finalizers">13.3. Finalizers</a></li>
<li><a href="#_utility_class_extensions_singleton">13.4. Utility class, extensions, singleton</a></li>
</ul>
</li>
<li><a href="#preconditions-and-instance-state">14. Preconditions and instance state</a></li>
<li><a href="#_copyright_and_license">15. Copyright and License</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Effective and eventual immutability with <em>e2immu</em>, a static code analyser for Java.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dedication">Dedication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This work is dedicated to those who have had, or are still having, a difficult pandemic.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document aims to be a logical walk through of the concepts of the  <em>e2immu</em>  project.
It does not intend to be complete, and is not structured for reference.</p>
</div>
<div class="paragraph">
<p>The overarching aim of the  <em>e2immu</em>  project is to improve every day programming by making code more readable, more robust, and more future-proof.
More concretely, the project focuses on adding various forms of immutability protections to your Java code base, by making the immutable nature of the types more visible.</p>
</div>
<div class="paragraph">
<p><em>Why Java?</em> As a widely used object-oriented programming language, it has evolved over the years, and it has been increasingly equipped with functional programming machinery.
It is therefore possible to write Java code in different styles, from overly object oriented to almost fully functional.
Combine this with lots of legacy code, both in house and in libraries, and many large software projects will end up mixing styles a lot.
This adds to the complexity of understanding and maintaining the code base.</p>
</div>
<div class="paragraph">
<p><em>Why immutability?</em> An important aspect of understanding the code of large software projects is to try to assess the <em>object lifecycle</em> of the data it manages: when and how are these objects modified?
In object-oriented programming, full of public getters and setters, objects can be modified all the time.
In many a functional set-up, objects are immutable but new immutable versions pop up all the time.
Java allows for the whole scala from object-oriented to functional, and the whole ecosystem reflects this choice.</p>
</div>
<div class="paragraph">
<p>An easy way to envisage the life cycle of an object is to assume that it consists of a building phase, followed by an immutable phase.
We set out to show that there are different forms of immutability, from very strict deep immutability to weak guarantees of non-modification, that can be made visible in the code.
We believe that code complexity can be greatly reduced when the software engineer is permanently aware of the modification state of objects.</p>
</div>
<div class="paragraph">
<p>The  <em>e2immu</em>  project consists of a set of definitions, a static code analyser to compute and enforce rules and definitions, and IDE support to visualize the results without cluttering.
Using  <em>e2immu</em>  in your project will help to maintain higher coding standards, the ultimate beneficiary being code that will survive longer.</p>
</div>
<div class="paragraph">
<p>A <em>lack of references</em> in this version of the work is explained by the fact that this is my first foray into the world of static code analysers, and theory of software engineering and programming languages.
Academically coming from the theory of machine learning, I spent a decade and a half writing software and managing teams of software engineers.
This work builds on that practical experience alone.
I did not consult or research the literature, and I realise I may be duplicating quite a lot here.
I only, explicitly, want to mention JetBrain&#8217;s brilliant <a href="https://www.jetbrains.com/idea/" target="_blank" rel="noopener">IntelliJ IDEA</a>, which acts as my gold standard.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assumptions">2. Assumptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We discuss the Java language, version 8 and higher.
We have already indicated that we believe that Java offers too much freedom to programmers.
In this section, we impose some limits that are not critical to the substance of the discussion, but facilitate reasoning.
Think of them as low-hanging fruit programming guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Exceptions do not belong to the normal programming flow; they are meant to raise situations that the program does not want to deal with.</p>
</li>
<li>
<p>Parameters of a method cannot be assigned; we act as if they always have the <code>final</code> modifier.
The simple way around is to create a new local variable, and assign the parameter to it.</p>
</li>
<li>
<p>We make no distinction between the various non-private access modifiers (package-private, protected, public).
Either a field, method or type is private, or it is not.</p>
</li>
<li>
<p>Static fields can only be used for non-constant purposes in very limited circumstances; one example is a variable to check enforce a singleton.
The whole topic of using statics to access thread-local variables is outside the scope of  <em>e2immu</em>  at the moment.</p>
</li>
<li>
<p>Methods must be static if they do not access non-static fields, and do not implement or overload some interface or class method.</p>
</li>
<li>
<p>Synchronization is orthogonal to the data of the program; whilst it may have an influence on <em>when</em> certain code runs, it should not be used to influence the semantics of the code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The  <em>e2immu</em>  code analyser warns for many other doubtful practices, as detailed in the user manual.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_purpose_of_annotations">3. The purpose of annotations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this document we will add many annotations to the code fragments shown.
We are acutely aware annotations clutter the code and can make it less readable.
Some IDEs, however, like JetBrains' IntelliJ IDEA, have extensive support to make working with annotations visually pleasing.</p>
</div>
<div class="paragraph">
<p>The  <em>e2immu</em>  code analyser computes almost all the annotations that we add to the code fragments in this document.
The complementary IDE plugin uses them to color code types, methods and fields.
Except when the annotations act as a contract, in interfaces, they do not have to be present in your code.</p>
</div>
<div class="paragraph">
<p>Explicitly adding the annotations to classes can be helpful during software development, however.
Say you intend for a class to be immutable, then you can add the corresponding annotation to the type.
Each time the code analyser runs, and the computation finds the type is not immutable, it will raise an error.</p>
</div>
<div class="paragraph">
<p>Explicit annotations also act as a safe-guard against the changing of semantics by overriding methods.
Making the method <code>final</code>, or the type <code>final</code>, merely <em>prohibits</em> overriding, which is typically too strong a mechanism.</p>
</div>
<div class="paragraph">
<p>The final situation where explicit annotations in the code are important, is for the development of the analyser.
We add them to the code as a means of verification: the analyser will check if it generates the same annotation at that location.
A number of annotations serve no other purpose than debugging: <code>@Linked</code>, <code>@Independent</code>, <code>@Constant</code>, &#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_1_immutability">4. Level 1 immutability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let us start with a definition:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition</strong>: We say a field is <strong>effectively final</strong> when it either has the modifier <code>final</code>, or it is not assigned to in methods that can be transitively called from non-private (non-constructor) methods.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code analyser annotates with  <code>@Final</code>  in the latter case; there is no point in cluttering with an annotation when the modifier is already there.
It annotates fields that are not effectively final with  <code>@Variable</code> .</p>
</div>
<div class="paragraph">
<p>This definition allows effectively final fields to be assigned in methods accessible only from the constructor:</p>
</div>
<div class="listingblock">
<div class="title">Example 1, effectively final, but not with the <code>final</code> modifier</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">EffectivelyFinal1</span> {
    <span class="annotation">@Final</span>
    <span class="directive">private</span> <span class="predefined-type">Random</span> random;

    <span class="directive">public</span> EffectivelyFinal1() {
        initialize(<span class="integer">3L</span>);
    }

    <span class="directive">private</span> <span class="type">void</span> initialize(<span class="type">long</span> seed) {
        random = <span class="keyword">new</span> <span class="predefined-type">Random</span>(seed);
    }

    <span class="comment">// no methods access initialize()</span>

    <span class="directive">public</span> <span class="type">int</span> nextInt() {
        <span class="keyword">return</span> random.nextInt();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Obviously, if the same method is also accessible after construction, the field becomes variable:</p>
</div>
<div class="listingblock">
<div class="title">Example 2, the method setting the field is accessible after construction</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">EffectivelyFinal2</span> {
    <span class="annotation">@Variable</span>
    <span class="directive">private</span> <span class="predefined-type">Random</span> random;

    <span class="directive">public</span> EffectivelyFinal2() {
        reset();
    }

    <span class="directive">public</span> <span class="type">void</span> reset() {
        initialize(<span class="integer">3L</span>);
    }

    <span class="directive">private</span> <span class="type">void</span> initialize(<span class="type">long</span> seed) {
        random = <span class="keyword">new</span> <span class="predefined-type">Random</span>(seed);
    }

    <span class="directive">public</span> <span class="type">int</span> nextInt() {
        <span class="keyword">return</span> random.nextInt();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that it is perfectly possible to rewrite the first example in such a way that the <code>final</code> modifier can be used.
From the point of view of the code analyser, this does not matter.
The wider definition will allow for more situations to be recognized for what they really are.</p>
</div>
<div class="paragraph">
<p>When an object consists solely of primitives, or deeply immutable objects such as <code>java.lang.String</code>, having all fields effectively final is sufficient to generate an object that is again deeply immutable.</p>
</div>
<div class="listingblock">
<div class="title">Example 3, an object consisting of primitives and a string.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">DeeplyImmutable1</span> {
    <span class="directive">public</span> <span class="directive">final</span> <span class="type">int</span> x;
    <span class="directive">public</span> <span class="directive">final</span> <span class="type">int</span> y;
    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">String</span> message;

    <span class="directive">public</span> DeeplyImmutable1(<span class="type">int</span> x, <span class="type">int</span> y, <span class="predefined-type">String</span> message) {
        <span class="local-variable">this</span>.message = message;
        <span class="local-variable">this</span>.x = x;
        <span class="local-variable">this</span>.y = y;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example 4, another way of being effectively final</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">DeeplyImmutable2</span> {
    <span class="annotation">@Final</span>
    <span class="directive">private</span> <span class="type">int</span> x;
    <span class="annotation">@Final</span>
    <span class="directive">private</span> <span class="type">int</span> y;
    <span class="annotation">@Final</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> message;

    <span class="directive">public</span> DeeplyImmutable2(<span class="type">int</span> x, <span class="type">int</span> y, <span class="predefined-type">String</span> message) {
        <span class="local-variable">this</span>.message = message;
        <span class="local-variable">this</span>.x = x;
        <span class="local-variable">this</span>.y = y;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getMessage() {
        <span class="keyword">return</span> message;
    }

    <span class="directive">public</span> <span class="type">int</span> getX() {
        <span class="keyword">return</span> x;
    }

    <span class="directive">public</span> <span class="type">int</span> getY() {
        <span class="keyword">return</span> y;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examples 3 and 4 are functionally equivalent: there is no way of changing the values of the fields once they have been set.
In the real world there may be a reason why someone requires the getters.
Or, you may be given code as in Example 2, but you are not allowed to change it.
Whatever the reason, the code analyser should recognize effective finality.</p>
</div>
<div class="paragraph">
<p>Note that we will not make a distinction between any of the different non-private access modes in Java.
Only the private modifier gives sufficient guarantees that no reassignment to the fields is possible.</p>
</div>
<div class="paragraph">
<p>We now have observed that for the purpose of defining immutability, having all your fields effectively final can be sufficient in certain circumstances.
We use this as the basis for the first level of immutability:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition</strong>: We call a type <strong>effectively level 1 immutable</strong> when all its fields are effectively final.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The code analyser annotates level 1 immutable types with  <code>@E1Immutable</code> .
Types that are not  <code>@E1Immutable</code>  because they have at least one  <code>@Variable</code>  field, are annotated either  <code>@MutableModifiesArguments</code>  or  <code>@Container</code> , depending on properties of the methods' parameters to be explained later.</p>
</div>
<div class="paragraph">
<p>Note that as of more recent versions of Java, the <code>record</code> type enforces explicitly final fields, along with additional support for equality and visibility.
Any <code>record</code> will at least be  <code>@E1Immutable</code> .</p>
</div>
<div class="paragraph">
<p>As above with effective finality, the term <em>effective</em> is present to make a distinction between formal immutability, and immutability that the code analyser computes.
It will also serve to distinguish from <em>eventual</em> immutability, where (in this case) the finality will be achieved only after the code reaches a certain state.
More on this later, but here is a first example of an eventually level 1 immutable type:</p>
</div>
<div class="listingblock">
<div class="title">Simplified version of <code>SetOnce</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E1Immutable</span>(after=<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">SetOnce</span>&lt;T&gt; {
    <span class="directive">private</span> T t;

    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> set(T t) {
        <span class="keyword">if</span>(t == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
        <span class="keyword">if</span>(<span class="local-variable">this</span>.t != <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Already set</span><span class="delimiter">&quot;</span></span>);
        <span class="local-variable">this</span>.t = t;
    }

    <span class="annotation">@Only</span>(after=<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> get() {
        <span class="keyword">if</span>(<span class="local-variable">this</span>.t == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Not yet set</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> <span class="local-variable">this</span>.t;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once a value has been set, the field <code>t</code> cannot be assigned anymore.</p>
</div>
<div class="paragraph">
<p>We have just observed that if one restricts to primitives and types like <code>java.lang.String</code>, level 1 immutability is sufficient to guarantee deep immutability.
It is not feasible, and we do not wish to, work only with deeply immutable objects.
Moreover, it is easy to see that level 1 immutability is not enough to guarantee what we intuitively may think immutability stands for:</p>
</div>
<div class="listingblock">
<div class="title">Example 5, level 1 immutability does not guarantee intuitive immutability</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E1Immutable</span>
<span class="type">class</span> <span class="class">StringsInArray</span> {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span><span class="type">[]</span> data;
    <span class="directive">public</span> StringsInArray(<span class="predefined-type">String</span><span class="type">[]</span> strings) {
        <span class="local-variable">this</span>.data = strings;
    }
    <span class="directive">public</span> <span class="predefined-type">String</span> getFirst() {
        <span class="keyword">return</span> data[<span class="integer">0</span>];
    }
}

...
String<span class="type">[]</span> strings = { <span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">b</span><span class="delimiter">&quot;</span></span> };
StringsInArray sia = <span class="keyword">new</span> StringsInArray(strings);
Assert.assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>, sia.getFirst());
strings[<span class="integer">0</span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>; <i class="conum" data-value="1"></i><b>(1)</b>
Assert.assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>, sia.getFirst()); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>External modification of the array.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>As a consequence, the data structure has been modified.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To continue, we must first understand the notion of modification.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modification">5. Modification</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition</strong>: a <strong>method is modifying</strong> if it causes an assignment in the object graph of the fields of the object it is applied to.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We use the term 'object graph' to denote the fields of the object, the fields of these fields, etc., to arbitrary depth.</p>
</div>
<div class="paragraph">
<p>Consequently, a method is not modifying if it only reads from the object graph of the fields.
The code analyser uses the annotations  <code>@NotModified</code> and  <code>@Modified</code> .
They are exclusive, and the analyser will compute one or the other for every method of the type.
All non-trivial constructors are modifying, so we avoid clutter by not annotating them.</p>
</div>
<div class="paragraph">
<p>It follows from the definition that directly assigning to the fields also causes the  <code>@Modified</code>  mark for methods.
As a consequence, setters are  <code>@Modified</code> , while getters are  <code>@NotModified</code>.
Consider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Counter</span> {
    <span class="annotation">@Variable</span>
    <span class="directive">private</span> <span class="type">int</span> counter;

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="type">int</span> getCounter() {
        <span class="keyword">return</span> counter;
    }

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">int</span> increment() {
        counter += <span class="integer">1</span>;
        <span class="keyword">return</span> counter;
    }
}

<span class="type">class</span> <span class="class">CountedInfo</span> {
    <span class="annotation">@Final</span>
    <span class="annotation">@Modified</span>
    <span class="directive">private</span> <span class="directive">final</span> Counter counter = <span class="keyword">new</span> Counter();

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">void</span> printInfo(<span class="predefined-type">String</span> info) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Message </span><span class="delimiter">&quot;</span></span> + counter.increment() + <span class="string"><span class="delimiter">&quot;</span><span class="content">: </span><span class="delimiter">&quot;</span></span>+info);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We also see in the example that the <code>printInfo</code> method is  <code>@Modified</code> .
This is because it calls a modifying method on one of the fields: <code>increment</code>.</p>
</div>
<div class="paragraph">
<p>Moving from methods to parameters and fields, keeping the same two annotations,</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition</strong>:
The analyser marks a <strong>parameter</strong> as <strong>modified</strong> when the parameter&#8217;s method applies an assignment or modifying methods on the object that enters the method via the parameter.
This definition holds with respect to the parameter&#8217;s entire object graph.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We will apply a similar reasoning to a field:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition</strong>:
The analyser marks a <strong>field</strong> as <strong>modified</strong> when at least one of the type&#8217;s methods, transitively reachable from a non-private non-constructor method, applies at least one assignment to or modifying method on this field.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let us start by agreeing that the methods of <code>Object</code> and <code>String</code> are all  <code>@NotModified</code>.
This is pretty obvious in the case of <code>toString</code>, <code>hashCode</code>, <code>getClass</code>.
It is less obvious for the <code>wait</code> and other synchronization-related methods, but remember that as discussed in the <a href="#assumptions">Assumptions</a>, we exclude synchronization support from this discussion.</p>
</div>
<div class="paragraph">
<p>Note also that we cannot add modifying methods to the type <code>DeeplyImmutable1</code> in Example 3.</p>
</div>
<div class="paragraph">
<p>Proceeding, let us also look at (a part of) the <code>Collection</code> interface, where we&#8217;ve restricted the annotations to  <code>@NotModified</code> and  <code>@Modified</code> .
While in normal classes the analyser computes the annotations, in interfaces the user stipulates or <em>contracts</em> behaviour by annotating:</p>
</div>
<div id="collection-interface" class="listingblock">
<div class="title">Modification aspects of the Collection interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Collection</span>&lt;E&gt; <span class="directive">extends</span> <span class="predefined-type">Iterable</span>&lt;E&gt; {
    <span class="annotation">@Modified</span>
    <span class="type">boolean</span> add(E e);

    <span class="annotation">@Modified</span>
    <span class="type">boolean</span> addAll(<span class="annotation">@NotModified</span> <span class="predefined-type">Collection</span>&lt;? <span class="directive">extends</span> E&gt; collection);

    <span class="annotation">@NotModified</span>
    <span class="type">boolean</span> contains(<span class="predefined-type">Object</span> object);

    <span class="annotation">@NotModified</span>
    <span class="type">boolean</span> containsAll(<span class="annotation">@NotModified</span> <span class="predefined-type">Collection</span>&lt;?&gt; c);

    <span class="annotation">@NotModified</span>
    <span class="type">void</span> forEach(Consumer&lt;? <span class="local-variable">super</span> E&gt; action);

    <span class="annotation">@NotModified</span>
    <span class="type">boolean</span> isEmpty();

    <span class="annotation">@Modified</span>
    <span class="type">boolean</span> remove(<span class="predefined-type">Object</span> object);

    <span class="annotation">@Modified</span>
    <span class="type">boolean</span> removeAll(<span class="annotation">@NotModified</span> <span class="predefined-type">Collection</span>&lt;?&gt; c);

    <span class="annotation">@NotModified</span>
    <span class="type">int</span> size();

    <span class="annotation">@NotModified</span>
    Stream&lt;E&gt; stream();

    <span class="annotation">@NotModified</span>
    <span class="predefined-type">Object</span><span class="type">[]</span> toArray();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding an object to a collection (set, list) will cause some assignment somewhere inside the data structure.
Returning the size of the collection should not.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Under supervision of the static code analyser, you will not be able to create an implementation of this interface which violates the modification rules.
This is intentional: no implementation should modify the data structure when <code>size</code> is called.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Adding all elements of a collection to the object (in <code>addAll</code>) should not modify the input collection, whence the  <code>@NotModified</code>.
Other types in the parameters have not been annotated with  <code>@NotModified</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Object</code> because it is deeply immutable;</p>
</li>
<li>
<p><code>E</code> because it is of an unbound generic type, it has the same methods available as <code>Object</code>.
No code statically visible to implementations of <code>Collection</code> can make modifications to <code>E</code>;</p>
</li>
<li>
<p><code>Consumer</code> because it is a functional interface (an interface with a single abstract method); they are  <code>@NotModified</code> by definition.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to keep the narrative going, we defer a discussion of modification in the context of parameters of functional interface types to the section <a href="#higher-level-modifications">Higher-level modifications</a>.
Here, we continue with the first use case of modification: containers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_containers">6. Containers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Loosely speaking, a container is a type to which you can safely pass on your objects, it will not modify them.
This is the formal rule:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition</strong>: a type is a <strong>container</strong> when no non-private method or constructor modifies its parameters.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Whatever else the container does, storing the parameters in fields or not, it will not change your objects.
You obviously remain free to change them elsewhere; then the container will hold on to the changed object, not some copy.</p>
</div>
<div class="paragraph">
<p>Containers are complementary to immutable objects, and we will find that many immutable objects are containers, while some containers are the precursors to immutable types.
There are two archetypes for containers: collections and builders.</p>
</div>
<div class="paragraph">
<p>The code analyser will annotate a type that is both level 1 immutable, and a container, with  <code>@E1Container</code> .
This occurs frequently enough to justify a separate annotation.
The simple but useful utility type <code>Pair</code> trivially satisfies both requirements:</p>
</div>
<div class="listingblock">
<div class="title">A pair of objects</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E1Container</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Pair</span>&lt;K,V&gt; {
    <span class="directive">public</span> <span class="directive">final</span> K k;
    <span class="directive">public</span> <span class="directive">final</span> V v;
    <span class="directive">public</span> Pair(K k, V v) {
        <span class="local-variable">this</span>.k = k;
        <span class="local-variable">this</span>.v = v;
    }
    <span class="directive">public</span> K getK() {
        <span class="keyword">return</span> k;
    }
    <span class="directive">public</span> V getV() {
        <span class="keyword">return</span> v;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>While it is clearly level 1 immutable, it will remain to be seen if it satisfies all criteria for intuitive immutability.
However, it is easily recognized as a container: a type you use and trust to hold objects.</p>
</div>
<div class="paragraph">
<p>Containers occur frequently as static sub-types to build immutable objects.
Examples of these will follow later, after the definition of level 2 immutability.</p>
</div>
<div class="paragraph">
<p>Let us conclude this section with an example consisting of three types: the first a class computed to be a container, the second a container according to the contract, and the third a class which cannot be a container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Container</span>
<span class="type">class</span> <span class="class">ErrorMessage</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> message;

    <span class="directive">public</span> ErrorMessage(<span class="predefined-type">String</span> message) {
        <span class="local-variable">this</span>.message = message;
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getMessage() {
        <span class="keyword">return</span> message;
    }

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">void</span> setMessage(<span class="predefined-type">String</span> message) {
        <span class="local-variable">this</span>.message = message;
    }
}

<span class="annotation">@Container</span>
<span class="type">interface</span> <span class="class">ErrorRegistry</span> {
    <span class="annotation">@NotModified</span>
    <span class="predefined-type">List</span>&lt;ErrorMessage&gt; getErrors();

    <span class="annotation">@Modified</span>
    <span class="type">void</span> addError(<span class="annotation">@NotModified</span> ErrorMessage errorMessage); <i class="conum" data-value="1"></i><b>(1)</b>
}

<span class="type">class</span> <span class="class">BinaryExpression</span> <span class="directive">extends</span> <span class="predefined-type">Expression</span> {
    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">Expression</span> lhs;
    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">Expression</span> rhs;

    <span class="comment">// ...</span>

    <span class="directive">public</span> <span class="type">void</span> evaluate(<span class="annotation">@Modified</span> ErrorRegistry errorRegistry) {
        <span class="comment">// ...</span>
        <span class="keyword">if</span>(lhs <span class="keyword">instanceof</span> NullConstant || rhs <span class="keyword">instanceof</span> NullConstant) {
            errorRegistry.addError(<span class="keyword">new</span> ErrorMessage(...)); <i class="conum" data-value="2"></i><b>(2)</b>
        }
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implementations of <code>ErrorRegistry</code> will not be allowed to use the <code>setMessage</code> setter in <code>addError</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here a modifying method call takes place.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>BinaryExpression</code> class is not a container, because it uses one of the parameters of a public method, <code>errorRegistry</code> of <code>evaluate</code>, as a writable container.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="linking-and-independence">7. Linking and independence</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let us now elaborate on how we will compute modifications, in a path towards level 2 immutability.
Consider the following example:</p>
</div>
<div class="listingblock">
<div class="title">Example 6, field linked to constructor parameter</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">LinkExample1</span>&lt;X&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;X&gt; set;

    <span class="directive">public</span> LinkExample1(<span class="predefined-type">Set</span>&lt;X&gt; xs) {
        <span class="local-variable">this</span>.set = xs;
    }

    <span class="directive">public</span> <span class="type">void</span> add(X x) {
        set.add(x);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After construction, an instance of <code>LinkExample1</code> contains a reference to the set that was passed on as an argument to its constructor.
We say the field <code>set</code> links to the parameter <code>xs</code> of the constructor.
In this example, this is an expensive way of saying that there is an assignment from one to the other.
However, linking can become more complicated.</p>
</div>
<div class="paragraph">
<p>The  <em>e2immu</em>  analyser will add modification annotations to <code>LinkExample1</code> as follows:</p>
</div>
<div class="listingblock">
<div class="title">Example 7, field linked to constructor parameter, with annotations</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">LinkExample1</span>&lt;X&gt; {
    <span class="annotation">@Modified</span>
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;X&gt; set;

    <span class="directive">public</span> LinkExample1(<span class="annotation">@Modified</span> <span class="predefined-type">Set</span>&lt;X&gt; xs) {
        <span class="local-variable">this</span>.set = xs;
    }

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">void</span> add(X x) {
        set.add(x);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The parameter <code>x</code> of <code>LinkExample1.add</code> is  <code>@NotModified</code> because the first parameter of <code>Set.add</code> is  <code>@NotModified</code>.
The <code>add</code> method modifies the field, which causes the annotation first on the method, then on the field, and finally on the parameter of the constructor.
Because of the latter, <code>LinkExample1</code> cannot be marked  <code>@Container</code> .</p>
</div>
<div class="paragraph">
<p>Linking looks at the underlying object, and not at the variable.
Consider the following alternative <code>add</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Example 8, alternative add method</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Modified</span>
<span class="directive">public</span> <span class="type">void</span> add(X x) {
    <span class="predefined-type">Set</span>&lt;X&gt; theSet = <span class="local-variable">this</span>.set;
    X theX = x;
    theSet.add(theX);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nothing has changed, obviously.
Finally, as an example of how linking can become more complicated than following assignments, consider a typical <em>view</em> on a collection:</p>
</div>
<div class="listingblock">
<div class="title">Example 9, linking using a method call</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;X&gt; list = createSomeLargeList();
<span class="predefined-type">List</span>&lt;X&gt; sub = list.subList(<span class="integer">1</span>, <span class="integer">5</span>);
sub.set(<span class="integer">0</span>, x); <span class="comment">// will modify sub, and list!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the other side of the spectrum, linking does not work on objects that cannot be modified, like primitives or deeply immutable objects such as the primitives, or <code>java.lang.String</code>.</p>
</div>
<div class="paragraph">
<p>Let us summarize by:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Intuitively, linking two variables means that modifying the content of one variable implies that the content of the linked variable may be modified too.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We will discuss linking formally in <a href="#linking-formally">Linking, formally</a>.
For now, assume that a field links to another field, or to a parameter, if there is a possibility that both variables represent (part of) the same object (their object graphs overlap).</p>
</div>
<div class="paragraph">
<p>The opposite of linking is independence.
While the code analyser will not express all the linking that goes on, it will annotate (in)dependence on the entry and exit points of the type: a method&#8217;s return value and parameters, and a constructor&#8217;s parameters.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition</strong>:
A method or constructor is <strong>independent</strong> when neither the parameters, nor the returned value (in case there is one, not <code>void</code>, not <code>this</code>) link to any of the fields of the type.
The independence (or dependence) is marked with  <code>@Independent</code>  (or  <code>@Dependent</code> ) on the method for the return value, and on the relevant parameters otherwise.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>It follows immediately that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>empty constructors of top-level types and static sub-types (but not necessarily inner classes, sub-types that are not static) are always independent;</p>
</li>
<li>
<p>non-modifying methods that return primitives or deeply immutable objects are independent, since no assignments to fields take place, and the returned objects cannot be modified.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples follow soon, once immutability has been defined in more detail.
Note that we will mark a constructor as  <code>@Independent</code>  when all its parameters are  <code>@Independent</code> , and  <code>@Dependent</code>  when at least one parameter is  <code>@Dependent</code> .</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_2_immutability">8. Level 2 immutability</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_definition">8.1. Definition</h3>
<div class="paragraph">
<p>First, what do we want intuitively?
A useful form of immutability, less strong than deeply immutable, but better than level 1 immutability for many situations.
We propose the following description:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>After construction, an immutable type holds a number of objects; the type will not change their content, nor will it exchange these objects for other objects, or allow others to do so.
The type is not responsible for what others do to the content of the objects it was given.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Technically, level 2 immutability is much harder to define than level 1 immutability.
We identify three rules, on top of the obvious level 1 immutability requirement.
One of these must be observed at all times:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition</strong>: the <strong>first rule of level 2 immutability</strong> is that all fields must be  <code>@NotModified</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Our friend the <code>Pair</code> satisfies this first rule:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Pair</span>&lt;K,V&gt; {
    <span class="directive">public</span> <span class="directive">final</span> K k;
    <span class="directive">public</span> <span class="directive">final</span> V v;
    <span class="directive">public</span> Pair(K k, V v) {
        <span class="local-variable">this</span>.k = k;
        <span class="local-variable">this</span>.v = v;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that since <code>K</code> and <code>V</code> are unbound generic types, it is not possible to modify their content from inside <code>Pair</code>, since there are no modifying methods one can call on unbound types.</p>
</div>
<div class="paragraph">
<p>How does it fit the intuitive rule for immutability?
The type <code>Pair</code> holds two objects.
The type does not change their content, nor will it exchange these two objects for others, or allow others to do so.
It is clear the users of <code>Pair</code> may be able to change the content of the objects they put in the <code>Pair</code>.
Summarizing: <code>Pair</code> fits the intuitive definition nicely.</p>
</div>
<div class="paragraph">
<p>Here is an example which shows the necessity of the first rule more explicitly:</p>
</div>
<div id="point-and-line" class="listingblock">
<div class="title">Point and Line</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Container</span>
<span class="type">class</span> <span class="class">Point</span> {
    <span class="annotation">@Variable</span>
    <span class="directive">private</span> <span class="type">double</span> x;

    <span class="annotation">@Variable</span>
    <span class="directive">private</span> <span class="type">double</span> y;

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="type">double</span> getX() {
        <span class="keyword">return</span> x;
    }

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">void</span> setX(<span class="type">double</span> x) {
        <span class="local-variable">this</span>.x = x;
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="type">double</span> getY() {
        <span class="keyword">return</span> y;
    }

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">void</span> setY(<span class="type">double</span> y) {
        <span class="local-variable">this</span>.y = y;
    }
}

<span class="annotation">@E1Container</span>
<span class="type">class</span> <span class="class">Line</span> {
    <span class="annotation">@Final</span>
    <span class="annotation">@Modified</span>
    <span class="directive">private</span> <span class="predefined-type">Point</span> point1;

    <span class="annotation">@Final</span>
    <span class="annotation">@Modified</span>
    <span class="directive">private</span> <span class="predefined-type">Point</span> point2;

    <span class="directive">public</span> <span class="predefined-type">Line</span>(<span class="predefined-type">Point</span> point1, <span class="predefined-type">Point</span> point2) {
        <span class="local-variable">this</span>.point1 = point1;
        <span class="local-variable">this</span>.point2 = point2;
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="predefined-type">Point</span> middle() {
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Point</span>((point1.getX() + point2.getX())/<span class="float">2.0</span>,
             (point1.getY()+point2.getY())/<span class="float">2.0</span>);
    }

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">void</span> translateHorizontally(<span class="type">double</span> x) {
        point1.setX(point1.getX() + x); <i class="conum" data-value="1"></i><b>(1)</b>
        point2.setX(point2.getX() + x);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Modifying operation on <code>point1</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The fields <code>point1</code> and <code>point2</code> are effectively final.
Without the translation method, the fields would be  <code>@NotModified</code> as well.
The translation method modifies their content, rendering the type not level 2 immutable.</p>
</div>
<div class="paragraph">
<p>Assuming a type&#8217;s goal is to store a number of objects, it is easy to see that a level 1 immutable type cannot hold additional, modifiable state.
It follows that every method call on the container object with the same arguments will render the same result.
(Note that this cannot be bypassed by using <em>static</em> state, i.e., state specific to the type rather than the object.
Our definitions make no distinction between static and instance fields.)</p>
</div>
<div class="paragraph">
<p>In order to hold an arbitrary (or even modestly large) amount of objects, a type has to have <em>support data</em>: think an array, a tree structure, buckets for a hash table, etc.
The rest of the definition of level 2 immutability is essentially about expressing the immutability of this support data.
After construction, a level 2 immutable type will still hold a fixed number of objects, and the type will not change their content, nor exchange them for other objects, nor allow others to exchange them.</p>
</div>
<div class="paragraph">
<p>We will introduce two additional rules to the definition of level 2 immutability.
They will only be of relevance for <em>some</em> fields; requiring them for all fields results in too strong a definition, and we have seen higher up that there are situations where the first rule is sufficient.
Rather than specifying which fields need to follow the additional rules, it is easier to say which fields are exempt from them:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>fields that are of level 2 immutable type themselves;</p>
</li>
<li>
<p>fields whose type can be replaced by an unbound type parameter.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that for all modification purposes we can replace unbound type parameters with <code>java.lang.Object</code>, which is level 2 immutable.
We will call those fields <em>implicitly immutable</em>, and the total of the values of fields of implicitly immutable type the <em>implicitly immutable content</em> of the type.
Their primary characteristic is that their content is inaccessible from within the type</p>
</div>
<div class="paragraph">
<p>Constructor parameters of unbound type parameter, or method return types of unbound type parameter are always independent, in the same way that level 2 immutable types are: inside the class, there&#8217;s no way of modifying them.</p>
</div>
<div class="paragraph">
<p>We now add rules 2 and 3 to the definition, and obtain:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition: level 2 immutability</strong>:</p>
</div>
<div class="paragraph">
<p>(<strong>Rule 0</strong>: The type is level 1 immutable: all fields are effectively final)</p>
</div>
<div class="paragraph">
<p><strong>Rule 1</strong>: All fields are  <code>@NotModified</code>.</p>
</div>
<div class="paragraph">
<p><strong>Rule 2</strong>: All fields are either private, or of level 2 immutable or implicitly immutable type.</p>
</div>
<div class="paragraph">
<p><strong>Rule 3</strong>: All constructors and non-private methods are independent of the fields.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Rule 2 is there to ensure that the content of the object cannot be modified by means of access to the non-private fields.
Rule 3 ensures that the content of the object cannot be modified externally.</p>
</div>
<div class="paragraph">
<p>The first rule can be reached <em>eventually</em> if there is one or more methods that effect a transition from the mutable to the immutable state.
This typically means that all methods that assign or modify fields become off-limits after calling this marker method.
Eventuality for rules 2 and 3 seems too far-fetched.
We address the topic of eventual immutability fully in the section <a href="#eventual-immutability">Eventual immutability</a>.</p>
</div>
<div class="paragraph">
<p>The section <a href="#higher-level-modifications">Higher-level modifications</a> will discuss modification and independence of types with abstract methods, such as functional interface types.</p>
</div>
<div class="paragraph">
<p>Let us go to examples immediately.</p>
</div>
<div class="listingblock">
<div class="title">Example with array, v1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">ArrayContainer1</span>&lt;T&gt; {
    <span class="directive">private</span> <span class="directive">final</span> T<span class="type">[]</span> data;
    <span class="directive">public</span> ArrayContainer1(T<span class="type">[]</span> ts) {
        <span class="local-variable">this</span>.data = ts;
    }
    <span class="directive">public</span> Stream&lt;T&gt; stream() {
        <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.stream(data);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After creation, changes to the source array <code>ts</code> are effectively changes to the data array <code>data</code>.
This construct fails rule 3, independence.
Here the array of type <code>T[]</code> is the support data that holds <code>T</code>, which also appears in the return type of the <code>stream</code> method, held by <code>Stream</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example with array, v2, still not OK</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">ArrayContainer2</span>&lt;T&gt; {
    <span class="directive">public</span> <span class="directive">final</span> T<span class="type">[]</span> data;
    <span class="directive">public</span> ArrayContainer2(T<span class="type">[]</span> ts) {
        <span class="local-variable">this</span>.data = <span class="keyword">new</span> T[ts.length];
        <span class="predefined-type">System</span>.arraycopy(ts, <span class="integer">0</span>, data, <span class="integer">0</span>, ts.length);
    }
    <span class="directive">public</span> Stream&lt;T&gt; stream() {
        <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.stream(data);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Users of this type can modify the content of the array using direct field access!
This construct fails rule 2, which applies for the same reasons as in the previous example.</p>
</div>
<div class="listingblock">
<div class="title">Example with array, v3, safe</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">ArrayContainer3</span>&lt;T&gt; {
    <span class="directive">private</span> <span class="directive">final</span> T<span class="type">[]</span> data; <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> ArrayContainer3(T<span class="type">[]</span> ts) {
        <span class="local-variable">this</span>.data = <span class="keyword">new</span> T[ts.length]; <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">System</span>.arraycopy(ts, <span class="integer">0</span>, data, <span class="integer">0</span>, ts.length);
    }
    <span class="directive">public</span> Stream&lt;T&gt; stream() {
        <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.stream(data);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The array is private, and therefore protected from external modification.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The array has been copied, and therefore is independent of the one passed in the parameter.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The independence rule enforces the type to have its own structure rather than someone else&#8217;s.
Here&#8217;s the same group of examples, now with JDK Collections:</p>
</div>
<div class="listingblock">
<div class="title">Example with collection, v1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">SetBasedContainer1</span>&lt;T&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;T&gt; data;
    <span class="directive">public</span> SetBasedContainer1(<span class="predefined-type">Set</span>&lt;T&gt; ts) {
        <span class="local-variable">this</span>.data = ts; <i class="conum" data-value="1"></i><b>(1)</b>
    }
    <span class="directive">public</span> Stream&lt;T&gt; stream() {
        <span class="keyword">return</span> data.stream();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>After creation, changes to the source set are effectively changes to the data.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The lack of independence of the constructor violates rule 3 in the first example.</p>
</div>
<div class="listingblock">
<div class="title">Example with collection, v2, still not OK</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">SetBasedContainer2</span>&lt;T&gt; {
    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;T&gt; data; <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> SetBasedContainer2(<span class="predefined-type">Set</span>&lt;T&gt; ts) {
        <span class="local-variable">this</span>.data = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;(ts);
    }
    <span class="directive">public</span> Stream&lt;T&gt; stream() {
        <span class="keyword">return</span> data.stream();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Users of this type can modify the content of the set after creation!</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here, the <code>data</code> field is public, which allows for external modification.</p>
</div>
<div class="listingblock">
<div class="title">Example with set, v3, safe</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">SetBasedContainer3</span>&lt;T&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;T&gt; data; <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> SetBasedContainer3(<span class="predefined-type">Set</span>&lt;T&gt; ts) {
        <span class="local-variable">this</span>.data = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;(ts); <i class="conum" data-value="2"></i><b>(2)</b>
    }
    <span class="directive">public</span> Stream&lt;T&gt; stream() {
        <span class="keyword">return</span> data.stream();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The set is private, and therefore protected from external modification.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The set has been copied, and therefore is independent of the one passed in the parameter.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, we have a level 2 immutable type.</p>
</div>
<div class="listingblock">
<div class="title">Example with set, v4, safe</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">SetBasedContainer4</span>&lt;T&gt; {
    <span class="directive">public</span> <span class="directive">final</span> ImmutableSet&lt;T&gt; data; <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> SetBasedContainer4(<span class="predefined-type">Set</span>&lt;T&gt; ts) {
        <span class="local-variable">this</span>.data = <span class="predefined-type">Set</span>.copyOf(ts); <i class="conum" data-value="2"></i><b>(2)</b>
    }
    <span class="directive">public</span> Stream&lt;T&gt; stream() {
        <span class="keyword">return</span> data.stream();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the data is public, but the <code>ImmutableSet</code> is  <code>@E2Immutable</code>  itself.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Independence guaranteed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The independence rule 3 is there to ensure that the type does not expose its support data through parameters and return types:</p>
</div>
<div class="listingblock">
<div class="title">Example with set, v5, unsafe</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">SetBasedContainer5</span>&lt;T&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;T&gt; data; <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> SetBasedContainer5(<span class="predefined-type">Set</span>&lt;T&gt; ts) {
        <span class="local-variable">this</span>.data = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;(ts); <i class="conum" data-value="2"></i><b>(2)</b>
    }
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;T&gt; getSet() {
        <span class="keyword">return</span> data; <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>No exposure via the field</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>No exposure via the parameter of the constructor</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>&#8230;&#8203; but exposure via the getter.
We could as well have made the field <code>public final</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that by decomposing all definitions, we observe that requiring all fields to be  <code>@Final</code>  and  <code>@NotModified</code> is equivalent to requiring that all non-private fields have the <code>final</code> modifier, and that methods that are not part of the construction phase, are  <code>@NotModified</code>.</p>
</div>
<div class="paragraph">
<p>The following type is  <code>@Container</code> , the field is  <code>@Final</code> , but it is not  <code>@NotModified</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Example2</span> {
    <span class="annotation">@Final</span>
    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;T&gt; set = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;();

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">void</span> add(T t) { set.add(t); }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> Stream&lt;T&gt; stream() { <span class="keyword">return</span> set.stream(); }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dynamic-type-annotations">8.2. Dynamic type annotations</h3>
<div class="paragraph">
<p>When it is clear a method returns an immutable set, but the formal type is <code>java.util.Set</code>, the  <code>@E2Immutable</code>  annotation can 'travel':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>
<span class="type">class</span> <span class="class">SetBasedContainer6</span>&lt;T&gt; {
    <span class="annotation">@E2Container</span>
    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;T&gt; data;

    <span class="directive">public</span> SetBasedContainer4(<span class="predefined-type">Set</span>&lt;T&gt; ts) {
        <span class="local-variable">this</span>.data = <span class="predefined-type">Set</span>.copyOf(ts);
    }

    <span class="annotation">@E2Container</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;T&gt; getSet() {
        <span class="keyword">return</span> data;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whilst <code>Set</code> in general is not  <code>@E2Immutable</code> , the <code>data</code> field itself is.</p>
</div>
<div class="paragraph">
<p>The computations that the analyser needs to track dynamic type annotations, are similar to those it needs to compute eventual immutability.
We introduce them in the next chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="inheritance">8.3. Inheritance</h3>
<div class="paragraph">
<p>Deriving from a class that is level 2 immutable, is the most normal situation: since <code>java.lang.Object</code> is a level 2 immutable container, every class will do so.
Clearly, the property is not inherited.
Most importantly, the analyser prohibits changing the modification status of methods: once a method is non-modifying, it cannot become modifying in a derived class.
This means, for example, that the analyser will block a modifying <code>equals()</code> method!
Note that this rule applies to implementations of methods of all super-types: no implementation of <code>java.util.Collection.size()</code>
will be allowed to be modifying.</p>
</div>
<div class="paragraph">
<p>The guiding principle here is that of <em>consistency</em> or <em>expectation</em>: software developers are expecting that <code>equals</code> is non-modifying.
They know that a setter will make an assignment, but they&#8217;ll expect a getter to simply return a value.
No getter should ever be modifying.</p>
</div>
<div class="paragraph">
<p>The other direction is more interesting, while equally simple to explain: deriving from a parent class cannot increase the immutability level.
Explicitly changing a modifying method into a non-modifying one is not allowed by the analyser.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="eventual-immutability">9. Eventual immutability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are many constraints on real-world use cases where immutability is not immediate.
The type then follows a life cycle described as create, use, drop.</p>
</div>
<div class="paragraph">
<p>Challenges:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>external frameworks insist on a way of working perpendicular to that of your project</p>
</li>
<li>
<p>some graph-like data structures simply cannot be made immutable using conventional tools</p>
</li>
<li>
<p>once you go eventually immutable, how is the propagation organized?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When possible, use a builder.</p>
</div>
<div class="sect2">
<h3 id="_builders">9.1. Builders</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>
<span class="type">class</span> <span class="class">Point</span> {
    <span class="directive">public</span> <span class="directive">final</span> <span class="type">double</span> x;
    <span class="directive">public</span> <span class="directive">final</span> <span class="type">double</span> y;

    <span class="directive">public</span> <span class="predefined-type">Point</span>(<span class="type">double</span> x, <span class="type">double</span> y) {
        <span class="local-variable">this</span>.x = x;
        <span class="local-variable">this</span>.y = y;
    }
}

<span class="annotation">@E2Container</span>
<span class="type">class</span> <span class="class">Polygon</span> {

    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Point</span>&gt; points;

    <span class="directive">private</span> <span class="predefined-type">Polygon</span>(<span class="predefined-type">List</span>&lt;<span class="predefined-type">Point</span>&gt; points) { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="local-variable">this</span>.points = points;
    }

    <span class="annotation">@Container</span>(builds=<span class="predefined-type">Polygon</span>.class)
    <span class="directive">static</span> <span class="type">class</span> <span class="class">Builder</span> {
        <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Point</span>&gt; points = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

        <span class="directive">public</span> <span class="type">void</span> addPoint(<span class="predefined-type">Point</span> point) {
            points.add(point);
        }

        <span class="directive">public</span> <span class="predefined-type">Polygon</span> build() {
            <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Polygon</span>(<span class="predefined-type">List</span>.copyOf(points));
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The private constructor combined with the construction of an immutable copy in the <code>build</code> method guarantees level 2 immutability.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If your code can live with two different types (<code>Polygon.Builder</code>, <code>Polygon</code>) to represent polygons in their different stages (mutable, immutable), the builder paradigm is great.
If, on the other hand, you want to hold polygons in a type that spans both stages of the polygon lifecycle, it becomes difficult to do this with an eye on immutability.
One solution is the use of an interface that is implemented both by the builder and the immutable type.</p>
</div>
<div class="paragraph">
<p>The <a href="#support-firstthen">FirstThen</a> type can also assist in this situation: it holds an initial object (the <em>first</em>) until a state change occurs, and it is forced to hold a second object (the <em>then</em>).
Once it is in the final state, it cannot change anymore.
It is <em>eventually immutable</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">PolygonManager</span> {
    <span class="comment">// initially, the polygon is in builder phase</span>
    <span class="directive">public</span> <span class="directive">final</span> FirstThen&lt;<span class="predefined-type">Polygon</span>.Builder, <span class="predefined-type">Polygon</span>&gt; polygon =
        <span class="keyword">new</span> FirstThen&lt;&gt;(<span class="keyword">new</span> <span class="predefined-type">Polygon</span>.Builder());

    <span class="comment">// ...</span>

    <span class="directive">public</span> <span class="type">void</span> construct() {
        <span class="comment">// in builder phase ...</span>
        polygon.getFirst().add(point);
        <span class="comment">// transition</span>
        polygon.set(polygon.getFirst().build());
        <span class="comment">// from here on, polygon is immutable!</span>
    }

    <span class="directive">public</span> <span class="predefined-type">Point</span> firstPoint() {
        <span class="keyword">return</span> polygon.get().points.get(<span class="integer">0</span>);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_definition_2">9.2. Definition</h3>
<div class="paragraph">
<p>We propose a system of eventual immutability based on a single transition of state inside an object.</p>
</div>
<div class="listingblock">
<div class="title">First example of frozen class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>(after=<span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">SimpleImmutableSet1</span>&lt;T&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;T&gt; set = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;();
    <span class="directive">private</span> <span class="type">boolean</span> frozen;

    <span class="annotation">@Only</span>(before=<span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">boolean</span> add(T t) {
        <span class="keyword">if</span>(frozen) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        set.add(t);
    }

    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> freeze() {
        <span class="keyword">if</span>(frozen) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        frozen = <span class="predefined-constant">true</span>;
    }

    <span class="annotation">@Only</span>(after=<span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Stream&lt;T&gt; stream() {
        <span class="keyword">if</span>(!frozen) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        <span class="keyword">return</span> set.stream();
    }

    <span class="annotation">@TestMark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">boolean</span> isFrozen() { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="keyword">return</span> frozen;
    }

    <span class="directive">public</span> <span class="type">int</span> size() { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="keyword">return</span> set.size();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>These methods can be called any time.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The analyser has no problem detecting the presence of preconditions, and observing that one method changes its own precondition.
The rules, however, are sufficiently general to support arbitrary preconditions, as shown in the following variant.
This example does not require an additional field, but relies on the empty/not-empty state change:</p>
</div>
<div class="listingblock">
<div class="title">Second example of frozen class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>(after=<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">SimpleImmutableSet2</span>&lt;T&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;T&gt; set = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;();

    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> initialize(<span class="predefined-type">Set</span>&lt;T&gt; data) {
        <span class="keyword">if</span>(!set.isEmpty()) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        <span class="keyword">if</span>(data.isEmpty()) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>();
        set.addAll(data);
    }

    <span class="annotation">@Only</span>(after=<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Stream&lt;T&gt; stream() {
        <span class="keyword">if</span>(set.isEmpty()) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        <span class="keyword">return</span> set.stream();
    }

    <span class="directive">public</span> <span class="type">int</span> size() {
        <span class="keyword">return</span> set.size();
    }

    <span class="annotation">@TestMark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">boolean</span> hasBeenInitialised() {
        <span class="keyword">return</span> !set.isEmpty();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us summarize the annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The  <code>@Mark</code>  annotation marks methods that change the state from <em>before</em> to <em>after</em>.</p>
</li>
<li>
<p>The  <code>@Only</code>  annotation identifies methods that, because of their precondition, can only be executed without raising an exception before (when complemented with a <code>before="&#8230;&#8203;"</code> parameter) or after (with a <code>after="&#8230;&#8203;"</code> parameter) the transition.</p>
</li>
<li>
<p>The analyser computes the  <code>@TestMark</code>  annotation on methods which return the state as a boolean.
There is a parameter to indicate that instead of returning <code>true</code> when the object is <em>after</em>, the method actually returns <code>true</code> on <em>before</em>.</p>
</li>
<li>
<p>Finally, the eventuality of the type shows in the <code>after="&#8230;&#8203;"</code> parameter of  <code>@E1Immutable</code> ,  <code>@E2Immutable</code>  or their container versions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In each of these annotations, the actual value of the <code>&#8230;&#8203;</code> in the <code>after=</code> or <code>before=</code> parameters is the name of the field.</p>
</div>
<div class="paragraph">
<p>In case there are multiple fields involved, their names are represented in a comma-separated fashion.</p>
</div>
<div class="paragraph">
<p>The  <code>@Mark</code>  and  <code>@Only</code>  annotations can also be assigned to parameters, in the event that marked methods are called on a parameter of eventually immutable type.
Consider the following utility method for <a href="#support-eventuallyfinal">EventuallyFinal</a>, frequently used in the analyser:</p>
</div>
<div class="listingblock">
<div class="title">Code fragment from EventuallyFinalExtension</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> &lt;T&gt; <span class="type">void</span> setFinalAllowEquals(<span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">isFinal</span><span class="delimiter">&quot;</span></span>) EventuallyFinal&lt;T&gt; eventuallyFinal, T t) {
    <span class="keyword">if</span> (eventuallyFinal.isVariable() || !Objects.equals(eventuallyFinal.get(), t)) {
        eventuallyFinal.setFinal(t);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the <code>setFinal</code> method&#8217;s  <code>@Mark</code>  annotation travels to the parameter, where it is applied to the argument each time the static method is applied.</p>
</div>
</div>
<div class="sect2">
<h3 id="_propagation">9.3. Propagation</h3>
<div class="paragraph">
<p>The support types detailed in <a href="#support-classes">Support classes</a> can be used as building blocks to make ever more complex eventually immutable classes.
Effectively final fields of eventually immutable type will at some point hold objects that are in their final or <code>after</code> state, in which case they act as level 2 immutable fields.</p>
</div>
<div class="paragraph">
<p>The analyser itself consists of many eventually immutable classes; we show some examples in <a href="#in-the-analyser">Support classes in the analyser</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For everyday use of eventual immutability, this is probably the most important consequence of all definitions up to now.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_before_the_mark">9.4. Before the mark</h3>
<div class="paragraph">
<p>A method can return an eventually immutable object, guaranteed to be in its initial or <code>before</code> state.
This can be annotated with  <code>@BeforeMark</code> .
Employing <code>SimpleImmutableSet1</code> from the example above,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@BeforeMark</span>
<span class="directive">public</span> SimpleImmutableSet1 create() {
    <span class="keyword">return</span> <span class="keyword">new</span> SimpleImmutableSet1();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, the analyser can compute a parameter to be  <code>@BeforeMark</code> , when in the method, at least one before-mark methods is called on the parameter.</p>
</div>
<div class="paragraph">
<p>Finally, a field can even be  <code>@BeforeMark</code> , when it is created or arrives in the type as  <code>@BeforeMark</code> , and stays in this state.
This situation must occur in a type with a  <code>@Finalizer</code> , as explained in <a href="#finalizers">Finalizers</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_extensions_of_annotations">9.5. Extensions of annotations</h3>
<div class="paragraph">
<p>When a type is eventually level 1 immutable, should the field(s) of the state transition be  <code>@Variable</code>  or  <code>@Final</code> ?
Similarly, when a type is eventually level 2 immutable, should the analyser mark the initially mutable or assignable fields  <code>@Modified</code>  or  <code>@NotModified</code>?</p>
</div>
<div class="paragraph">
<p>Basically, we propose to mark with the end state, qualifying with the parameter <code>after</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">property</th>
<th class="tableblock halign-left valign-top">not present</th>
<th class="tableblock halign-left valign-top">eventually</th>
<th class="tableblock halign-left valign-top">effectively</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">finality of field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Variable</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Final(after="mark")</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Final</code> </p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">non-modification of field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@Modified</code> </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@NotModified(after="mark")</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> <code>@NotModified</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Since in an IDE it is not too easy to have multiple visual markers, it seems best to use the same visuals as the end state.</p>
</div>
<div class="paragraph">
<p>When a type is effectively level 1 immutable (not eventually), all fields are effectively final.
The analyser wants to emphasise the rules needed to obtain (eventual) level 2 immutability, by clearly indicating which fields break the level 2 immutability rules.
In the case of eventual level 2 immutability,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>modifications to the support data cease after a given mark</p>
</li>
<li>
<p>the analyser disallows modifications to the other fields.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Eventual finality simply adds a  <code>@Final(after="mark")</code> annotation to each of these situations.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modification-part2">10. Modification, part2</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section goes deeper into modification, linking and independence.
We start with cyclic references.</p>
</div>
<div class="sect2">
<h3 id="_cyclic_references">10.1. Cyclic references</h3>
<div class="paragraph">
<p>We need to study the situation of seemingly non-modifying methods with modifying parameters.
Up to now, a method is only modifying when it assigns to a field, calls a modifying method on one of the fields, or directly calls a modifying method on <code>this</code>.
However, there could be indirect modifications, as in:</p>
</div>
<div class="listingblock">
<div class="title">Indirect modifications</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CyclicReferences</span> {

    <span class="annotation">@MutableModifiesArguments</span>
    <span class="directive">static</span> <span class="type">class</span> <span class="class">C1</span> {

        <span class="annotation">@Variable</span>
        <span class="directive">private</span> <span class="type">int</span> i;

        <span class="annotation">@Modified</span>
        <span class="directive">public</span> <span class="type">int</span> incrementAndGet() {
            <span class="keyword">return</span> ++i;
        }

        <span class="annotation">@Modified</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="directive">public</span> <span class="type">int</span> useC2(<span class="annotation">@Modified</span> C2 c2) {
            <span class="keyword">return</span> i + c2.incrementAndGetWithI();
        }

    }

    <span class="annotation">@E1Immutable</span>
    <span class="directive">static</span> <span class="type">class</span> <span class="class">C2</span> {

        <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> j;

        <span class="annotation">@Modified</span>
        <span class="directive">private</span> <span class="directive">final</span> C1 c1;

        <span class="directive">public</span> C2(<span class="type">int</span> j, <span class="annotation">@Modified</span> C1 c1) {
            <span class="local-variable">this</span>.c1 = c1;
            <span class="local-variable">this</span>.j = j;
        }

        <span class="annotation">@Modified</span>
        <span class="directive">public</span> <span class="type">int</span> incrementAndGetWithI() {
            <span class="keyword">return</span> c1.incrementAndGet() + j;
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>useC2</code> does not directly modify <code>i</code>, but <code>incrementAndGetWithI</code> does so indirectly.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This observation forces us to tighten the definition of a non-modifying method: on top of the definition given above, we have to ensure that none of the modifying methods called on a parameter which is  <code>@Modified</code> , call one of 'our' modifying methods.
These rules are mostly, but not easily, enforceable when all code is visible.</p>
</div>
<div class="paragraph">
<p>An additional interface can help to remove the circular dependency between the types.
This has the advantage of simplicity, both for the programmer and the analyser, which at this point doesn&#8217;t handle circular dependencies too well.
It imposes more annotation work on the programmer, however, because the interface&#8217;s methods need contracting.</p>
</div>
</div>
<div class="sect2">
<h3 id="linking-formally">10.2. Linking, formally</h3>
<div class="paragraph">
<p>To compute linking, the analyser tries to track actual objects, with the aim of knowing if a field links to another field or a parameter.
It computes a dependency graph of variables depending on other variables, with the following four basic rules:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Rule 1: in an assignment <code>v = w</code>, variable <code>v</code> links to variable <code>w</code>.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Rule 2: in an assignment <code>v = a.method(b)</code>,<code>v</code> potentially links to <code>a</code> and <code>b</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that saying <code>v</code> links to <code>a</code> is the same as saying that the return value of <code>method</code> links to some field inside <code>A</code>, the type of <code>a</code>.
This is especially clear when <code>a == this</code>.</p>
</div>
<div class="paragraph">
<p>We discern a number of special cases:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When <code>v</code> is of primitive or  <code>@E2Immutable</code>  type, there cannot be any linking; <code>v</code> does not link to <code>a</code> nor <code>b</code>.</p>
</li>
<li>
<p>If <code>b</code> is of primitive or  <code>@E2Immutable</code>  type, <code>v</code> cannot link to <code>b</code>.</p>
</li>
<li>
<p>When <code>method</code> has the annotation  <code>@Independent</code> , <code>v</code> cannot link to <code>a</code>.</p>
</li>
<li>
<p>If <code>a</code> is of  <code>@Independent</code>  type (which includes all  <code>@E2Immutable</code>  types), all its methods are independent; therefore, <code>v</code> cannot link to <code>a</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It is important to note that the analyser only computes independence for non-modifying methods, so that all methods of implicitly immutable return type are automatically independent.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Rule 3: in an assignment <code>v = new A(b)</code>, <code>v</code> potentially links to <code>b</code>.</p>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When the constructor <code>A</code> is independent, <code>v</code> cannot link to <code>b</code>.</p>
</li>
<li>
<p>When <code>b</code> is of primitive or  <code>@E2Immutable</code>  type, <code>v</code> cannot link to <code>b</code>.</p>
</li>
<li>
<p>If <code>A</code> is  <code>@E2Immutable</code> , then <code>v</code> cannot link to <code>b</code> nor <code>c</code>, because all constructors are independent.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Most of the other linking computations are consequences of the basic rules above.
For example,</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>in an assignment <code>v = condition ? a : b</code>, <code>v</code> links to both <code>a</code> and <code>b</code>.</p>
</li>
<li>
<p>type casting does not prevent linking: in <code>v = (Type)w</code>, <code>v</code> links to <code>w</code></p>
</li>
<li>
<p>Binary operators return primitives or <code>java.lang.String</code>, which prevents linking: in <code>v = a + b</code>, <code>v</code> does not link to <code>a</code> nor <code>b</code>.</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Rule 4: in an array access <code>v = a[index]</code>, <code>v</code> links to <code>a</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Note: links between <code>b</code>, <code>c</code>, and <code>d</code> are possible, but are covered by the  <code>@Modified</code>  annotation:
when a parameter is  <code>@NotModified</code>, no modifications at all are possible, not even indirectly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_abstract_methods_and_functional_interfaces">10.3. Abstract methods and functional interfaces</h3>
<div class="paragraph">
<p>Abstract methods are present in interfaces, and abstract classes.
Their very definition is that no implementation is present at the place of definition: only the ins (parameters) and outs (return type) are pre-defined.</p>
</div>
<div class="paragraph">
<p>Functional interfaces are interfaces with a single abstract method; any other methods in the interface are required to have a <code>default</code> implementation.
The following table lists some frequently used ones:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">single abstract method (SAM)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Consumer&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void accept(T t);</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Function&lt;T,R&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>R apply(T t);</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BiFunction&lt;T, U, R&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>R apply(T t, U u);</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Supplier&lt;R&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>R get();</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Predicate&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean test(T t);</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It is important not to forget that <em>any</em> interface defining a single abstract method can be seen as a functional interface.
While the examples above all employ generics (more specifically, unbound type parameters), generics are not a requirement for functional interfaces.
The Java language offers syntactic sugar for functional programming, but the types remain abstract Java types.</p>
</div>
<div class="paragraph">
<p>We will not make any distinction between a functional interface and an abstract type.
If one were forced to make one, the <em>intention to hold data</em> would be the dividing line between a functional interface, which conveys no such intention, and an abstract type, which does.</p>
</div>
<div class="paragraph">
<p>In this section we want to discuss a limited application of functional interfaces: that where the SAMs have a local implementation.
The general case, where abstract types come in via a parameter, will be taken up in <a href="#higher-level-modifications">Higher-level modifications</a>.
Consider the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">ApplyLocalFunctions</span> {

    <span class="annotation">@Container</span>
    <span class="directive">static</span> <span class="type">class</span> <span class="class">Counter</span> {
        <span class="directive">private</span> <span class="type">int</span> counter;

        <span class="annotation">@Modified</span>
        <span class="directive">public</span> <span class="type">int</span> increment() {
            <span class="keyword">return</span> ++counter;
        }
    }

    <span class="annotation">@Modified</span>
    <span class="directive">private</span> <span class="directive">final</span> Counter myCounter = <span class="keyword">new</span> Counter();

    <span class="annotation">@Modified</span>
    <span class="directive">private</span> <span class="directive">final</span> Supplier&lt;<span class="predefined-type">Integer</span>&gt; getAndIncrement = myCounter::increment;

    <span class="annotation">@Modified</span>
    <span class="directive">private</span> <span class="directive">final</span> Supplier&lt;<span class="predefined-type">Integer</span>&gt; explicitGetAndIncrement = <span class="keyword">new</span> Supplier&lt;<span class="predefined-type">Integer</span>&gt;() {
        <span class="annotation">@Override</span> <span class="annotation">@Modified</span>
        <span class="directive">public</span> <span class="predefined-type">Integer</span> get() {
            <span class="keyword">return</span> myCounter.increment();
        }
    };

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">int</span> myIncrementer() {
        <span class="keyword">return</span> getAndIncrement.get();
    }

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">int</span> myExplicitIncrementer() {
        <span class="keyword">return</span> explicitGetAndIncrement.get();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The fields <code>getAndIncrement</code> and <code>explicitGetAndIncrement</code> hold instances of anonymous <em>inner classes</em> of <code>ApplyLocalFunctions</code>: these inner classes hold data, they have access to the <code>myCounter</code> field.
Their concrete implementations of <code>get</code> each modify <code>myCounter</code>.
A straightforward application of the rules of modification of fields makes  <code>getAndIncrement</code> and <code>explicitGetAndIncrement</code>  <code>@Modified</code> :
in <code>myIncrementer</code>, a modifying method is applied to <code>getAndIncrement</code>, and in <code>myExplicitIncrementer</code>, a modifying method is applied to <code>explicitGetAndIncrement</code>.</p>
</div>
<div class="paragraph">
<p>Given that <code>ApplyLocalFunctions</code> is clearly  <code>@E1Container</code> , and the inner classes hold no other data, the inner classes are  <code>@E1Container</code>  as well.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="higher-level-modifications">11. Higher-level modifications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From a type&#8217;s point of view, fields are either of an explicit type, they are accessible, or they are of implicitly immutable type, in other words, replaceable by <code>Object</code> and inaccessible.
Our focus up to now has been on modification of the explicit types: we have argued that they are the only ones that matter for practical immutability.
Now we will try to characterise modifications that are beyond the scope of the type.</p>
</div>
<div class="paragraph">
<p>Please note that characterising <em>all</em> modifications is a hopelessly complex, and unnecessary, task.
We will, however, need to deal with what can be seen as the first of higher level modifications, if we want to be able to characterise the modifications going on in extremely important constructs such as iterators.</p>
</div>
<div class="sect2">
<h3 id="_propagating_modifications">11.1. Propagating modifications</h3>
<div class="paragraph">
<p>The basis of this section is an example container class called <code>Circular</code>:</p>
</div>
<div class="listingblock">
<div class="title">First methods of Circular</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Container</span>
<span class="type">class</span> <span class="class">Circular</span>&lt;T&gt; {

    <span class="directive">private</span> T x;
    <span class="directive">private</span> T y;
    <span class="directive">private</span> <span class="type">boolean</span> next;

    <span class="directive">public</span> Circular() {
    }

    <span class="annotation">@Independent</span>
    <span class="directive">public</span> Circular(Circular&lt;T&gt; c) {
        x = c.x;
        y = c.y;
        next = c.next;
    }

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">void</span> add(T t) {
        <span class="keyword">if</span> (next) {
            <span class="local-variable">this</span>.y = t;
        } <span class="keyword">else</span> {
            <span class="local-variable">this</span>.x = t;
        }
        next = !next;
    }

    <span class="annotation">@NotModified</span>
    <span class="annotation">@E2Container</span>
    <span class="directive">public</span> Stream&lt;T&gt; stream() {
        <span class="keyword">return</span> Stream.of(x, y);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We also make use of the <code>Consumer</code> functional interface:</p>
</div>
<div class="listingblock">
<div class="title">Consumer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@FunctionalInterface</span>
<span class="type">interface</span> <span class="class">Consumer</span>&lt;T&gt; {
    <span class="type">void</span> accept(T t);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that method and parameter remain unmarked in terms of modification.
Using the <code>Consumer</code> we introduce a <code>forEach</code> method which iterates over the two elements:</p>
</div>
<div class="listingblock">
<div class="title">forEach in Circular</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NotModified</span>
<span class="directive">public</span> <span class="type">void</span> forEach(<span class="annotation">@PropagateModification</span> Consumer&lt;T&gt; consumer) {
    consumer.accept(x);
    consumer.accept(y);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The  <code>@NotModified</code> and  <code>@PropagateModification</code>  annotations are as described in the earlier section: from the point of view of <code>Circular</code>, no modifications occur because <code>accept</code> operates on fields of the implicitly immutable type <code>T</code>.
By convention, the parameter <code>consumer</code> is not modified, so <code>Circular</code> can remain a container.</p>
</div>
<div class="paragraph">
<p>How do we propagate the modification?
In this example we will use <code>StringBuilder</code> as an archetypal modifiable type.</p>
</div>
<div class="listingblock">
<div class="title">Propagating the modification of forEach</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">static</span> <span class="type">void</span> print(<span class="annotation">@NotModified</span> <span class="annotation">@NotModified1</span> Circular&lt;<span class="predefined-type">StringBuilder</span>&gt; c) {
    c.forEach(<span class="predefined-type">System</span>.out::println); <i class="conum" data-value="1"></i><b>(1)</b>
}

<span class="directive">static</span> <span class="type">void</span> addNewLine(<span class="annotation">@NotModified</span> <span class="annotation">@Modified1</span> Circular&lt;<span class="predefined-type">StringBuilder</span>&gt; c) {
    c.forEach(sb -&gt; sb.append(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)); <i class="conum" data-value="2"></i><b>(2)</b>
}

<span class="directive">static</span> <span class="type">void</span> replace(<span class="annotation">@Modified</span> <span class="annotation">@NotModified1</span> Circular&lt;<span class="predefined-type">StringBuilder</span>&gt; c) {
    c.forEach(sb -&gt; c.add(<span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span> + sb))); <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>non-modifying method implies no modification on <code>c</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>parameter-modifying lambda propagates modification to <code>c</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>object-modifying lambda changing <code>c</code> but not its content</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have introduced two new annotations,  <code>@Modified1</code> and  <code>@NotModified1</code>.
Their meaning is intuitively clear from the example:
the method <code>print</code> does not modify the implicitly immutable content of <code>Circular</code>, whereas the <code>addNewLine</code> method will do so.
Conversely, <code>replace</code> modifies the <code>Circular</code> parameter directly, ignoring its content.</p>
</div>
<div class="paragraph">
<p>It is clear that we make a distinction between modifying the <code>Circular</code> instance, and modifying its content, the objects of type <code>StringBuilder</code>.
Does this contradict the initial definition of modification of a parameter?
Yes, but it allows us to be more specific.</p>
</div>
<div class="paragraph">
<p>How can we use this additional firepower?
Consider the following two examples:</p>
</div>
<div class="listingblock">
<div class="title">Using print and addNewLine</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">static</span> <span class="predefined-type">String</span> usePrint(<span class="annotation">@NotModified</span> <span class="predefined-type">StringBuilder</span> sb1,
                       <span class="annotation">@NotModified</span> <span class="predefined-type">StringBuilder</span> sb2,
                       <span class="annotation">@NotModified</span> <span class="predefined-type">StringBuilder</span> sb3) {
    Circular&lt;<span class="predefined-type">StringBuilder</span>&gt; circular = <span class="keyword">new</span> Circular&lt;&gt;();
    circular.add(sb1); <i class="conum" data-value="1"></i><b>(1)</b>
    circular.add(sb2);
    circular.add(sb3);
    print(circular);
    <span class="keyword">return</span> circular.stream().collect(Collectors.joining());
}

<span class="directive">static</span> <span class="predefined-type">String</span> useAddNewLine(<span class="annotation">@Modified</span> <span class="predefined-type">StringBuilder</span> sb1,
                            <span class="annotation">@Modified</span> <span class="predefined-type">StringBuilder</span> sb2,
                            <span class="annotation">@Modified</span> <span class="predefined-type">StringBuilder</span> sb3) {
    Circular&lt;<span class="predefined-type">StringBuilder</span>&gt; circular = <span class="keyword">new</span> Circular&lt;&gt;();
    circular.add(sb1);
    circular.add(sb2);
    circular.add(sb3);
    addNewLine(circular); <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="keyword">return</span> circular.stream().collect(Collectors.joining());
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>circular</code> now holds <code>sb1</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td> <code>@Modified1</code> implies that the elements held by circular are modified (but not circular itself)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Proper propagation of the modifications relies on knowing that <code>circular</code> holds the parameters <code>sb1</code>, <code>sb2</code> and <code>sb3</code>.
(We will assume it is too complicated to assess whether <code>sb1</code> is still held by <code>circular</code> or not.) This will be accomplished by computing 'content links', which give rise to 'content (in)dependence', all in a way very similar to ordinary linking and (in)dependence.</p>
</div>
</div>
<div class="sect2">
<h3 id="content-linking">11.2. Content linking</h3>
<div class="paragraph">
<p>Going back to <code>Circular</code>, we see that the <code>add</code> method binds the parameter <code>t</code> to the instance by means of assignment.
Let us call this binding of parameters of implicitly immutable types <em>content linking</em>, and mark it using  <code>@Dependent1</code> , <em>content dependence</em>:</p>
</div>
<div class="listingblock">
<div class="title">Extra annotation on add</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Modified</span>
<span class="directive">public</span> <span class="type">void</span> add(<span class="annotation">@Dependent1</span> T t) {
    <span class="keyword">if</span> (next) {
        <span class="local-variable">this</span>.y = t;
    } <span class="keyword">else</span> {
        <span class="local-variable">this</span>.x = t;
    }
    next = !next;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that content dependence implies normal independence, exactly because we are dealing with parameters of implicitly immutable type.
Thanks to this annotation, the statement <code>circular.add(sb1)</code> can content link <code>sb1</code> to circular.
When propagating the modification of `addNewLine&#8217;s parameter, all variables content linked to the argument get marked.</p>
</div>
<div class="paragraph">
<p>A second way, next to assignment, of adding to content links is Java&#8217;s for-each loop:</p>
</div>
<div class="listingblock">
<div class="title">For-each loop and content linking</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Collection</span>&lt;<span class="predefined-type">StringBuilder</span>&gt; builders = ...;
<span class="keyword">for</span>(<span class="predefined-type">StringBuilder</span> sb: builders) { circular.add(sb); }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The local loop variable <code>sb</code> gets content linked to <code>circular</code>.
Crucially, however, it is not difficult to see that <code>sb</code> is also content linked to <code>builders</code>!
The <code>Collection</code> API will contain an <code>add</code> method annotated as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Modified</span>
<span class="type">boolean</span> add(<span class="annotation">@NotNull</span> <span class="annotation">@Dependent1</span> E e) { <span class="keyword">return</span> <span class="predefined-constant">true</span>; }</code></pre>
</div>
</div>
<div class="paragraph">
<p>indicating that after calling <code>add</code>, the argument will become part of the implicitly immutable content of the collection.
We need yet another annotation,  <code>@Dependent2</code> , to indicate that the implicitly immutable content of two objects are linked.
Looking at a possible implementation of <code>addAll</code>:</p>
</div>
<div class="listingblock">
<div class="title">addAll</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Modified</span>
<span class="type">boolean</span> addAll(<span class="annotation">@NotNull1</span> <span class="annotation">@Dependent2</span> <span class="predefined-type">Collection</span>&lt;? <span class="directive">extends</span> E&gt; collection) {
    <span class="type">boolean</span> modified = <span class="predefined-constant">false</span>;
    <span class="keyword">for</span> (E e : c) <span class="keyword">if</span> (add(e)) modified = <span class="predefined-constant">true</span>;
    <span class="keyword">return</span> modified;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The call to <code>add</code> content links <code>e</code> to <code>this</code>.
Because <code>e</code> is also content linked to <code>c</code>, the parameter <code>collection</code>
holds implicitly immutable content linked to the implicitly immutable content of the instance.</p>
</div>
<div class="paragraph">
<p>Again, note that  <code>@Dependent2</code>  implies independence, because it deals with the implicitly immutable content:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p> <code>@Dependent1</code>  &#8658;  <code>@Independent</code> </p>
</div>
<div class="paragraph">
<p> <code>@Dependent2</code>  &#8658;  <code>@Independent</code> </p>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re now properly armed to see how a for-each loop can be defined as an iterator whose implicitly immutable content links to that of a container.</p>
</div>
</div>
<div class="sect2">
<h3 id="_iterator_iterable_loops">11.3. Iterator, Iterable, loops</h3>

</div>
<div class="sect2">
<h3 id="_extending_implicitly_immutable_types">11.4. Extending implicitly immutable types</h3>
<div class="paragraph">
<p>With all abstract types on which only abstract methods without modification status are called.
See the <a href="#support-lazy">Lazy</a> example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implications_for_immutability">11.5. Implications for immutability</h3>
<div class="paragraph">
<p>This leads us to the question of determining the static immutability type of abstract types.
We need this information for fields of abstract type, because of the definition of immutability of the <mark>TODO</mark></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="support-classes">12. Support classes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>e2immu-support-1.0.0.jar</code> library (in whichever version it comes) essentially contains the annotations of the analyser, and a small selection of support types.
They are the eventually immutable building blocks that you can use in your project, irrespective of whether you want analyser support or not.</p>
</div>
<div class="paragraph">
<p>We discuss a selection of the building blocks here.</p>
</div>
<div class="sect2">
<h3 id="support-flipswitch">12.1. FlipSwitch</h3>
<div class="paragraph">
<p>Simpler than <code>FlipSwitch</code> is not possible for an eventually immutable type: it consists solely of a single boolean, which is at the same time the data and the guard:</p>
</div>
<div class="listingblock">
<div class="title">Code fragment: most of FlipSwitch</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">FlipSwitch</span> {

    <span class="annotation">@Final</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="directive">volatile</span> <span class="type">boolean</span> t;

    <span class="directive">private</span> <span class="type">boolean</span> set<span class="error">$</span>Precondition() { <span class="keyword">return</span> !t; } <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> set() {
        <span class="keyword">if</span> (t) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Already set</span><span class="delimiter">&quot;</span></span>);
        t = <span class="predefined-constant">true</span>;
    }

    <span class="annotation">@NotModified</span>
    <span class="annotation">@TestMark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">boolean</span> isSet() {
        <span class="keyword">return</span> t;
    }

    <span class="directive">private</span> <span class="type">boolean</span> copy<span class="error">$</span>Precondition() { <span class="keyword">return</span> !t; } <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>) <span class="comment">// but conditionally</span>
    <span class="directive">public</span> <span class="type">void</span> copy(FlipSwitch other) {
        <span class="keyword">if</span> (other.isSet()) set();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This companion method is present in the code to validate the computation of the precondition.
See <a href="#preconditions-and-instance-state">Preconditions and instance state</a> for more details.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that methods which only conditionally change the immutability status of a type, such as <code>copy</code>, also get a  <code>@Mark</code>  annotation.
The analyser is not omniscient, and plays safe.</p>
</div>
<div class="paragraph">
<p>The obvious use case for this helper class is to indicate whether a certain job has been done, or not.</p>
</div>
</div>
<div class="sect2">
<h3 id="support-setonce">12.2. SetOnce</h3>
<div class="paragraph">
<p>One step up from <code>FlipSwitch</code> is <code>SetOnce</code>: a place-holder for one object which can be filled exactly once:</p>
</div>
<div class="listingblock">
<div class="title">Code fragment: parts of SetOnce</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SetOnce</span>&lt;T&gt; {

    <span class="annotation">@Final</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="directive">volatile</span> T t;

    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> set(<span class="annotation">@NotNull</span> T t) {
        <span class="keyword">if</span> (t == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Null not allowed</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span> (<span class="local-variable">this</span>.t != <span class="predefined-constant">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Already set: have </span><span class="delimiter">&quot;</span></span> + <span class="local-variable">this</span>.t + <span class="string"><span class="delimiter">&quot;</span><span class="content">, try to set </span><span class="delimiter">&quot;</span></span> + t);
        }
        <span class="local-variable">this</span>.t = t;
    }

    <span class="annotation">@Only</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@NotNull</span>
    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> T get() {
        <span class="keyword">if</span> (t == <span class="predefined-constant">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Not yet set</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">return</span> t;
    }

    <span class="annotation">@NotModified</span>
    <span class="annotation">@TestMark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">boolean</span> isSet() {
        <span class="keyword">return</span> t != <span class="predefined-constant">null</span>;
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> T getOrElse(T alternative) {
        <span class="keyword">if</span> (isSet()) <span class="keyword">return</span> get();
        <span class="keyword">return</span> alternative;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The analyser relies heavily on this type, with additional support to allow setting multiple times, with exactly the same value.
This can be ascertained with a helper method, which, as noted in the previous section, also gets the  <code>@Mark</code>  annotation.</p>
</div>
</div>
<div class="sect2">
<h3 id="support-eventuallyfinal">12.3. EventuallyFinal</h3>
<div class="paragraph">
<p>Slightly more flexible than <code>SetOnce</code> is <code>EventuallyFinal</code>: the type allows you to keep writing objects using the <code>setVariable</code>
method, until you write using <code>setFinal</code>.
Then, the state changes and the type becomes level 2 immutable:</p>
</div>
<div class="listingblock">
<div class="title">Code fragment: EventuallyFinal</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">isFinal</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">EventuallyFinal</span>&lt;T&gt; {
    <span class="directive">private</span> T value;
    <span class="directive">private</span> <span class="type">boolean</span> isFinal;

    <span class="directive">public</span> T get() {
        <span class="keyword">return</span> value;
    }

    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">isFinal</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> setFinal(T value) {
        <span class="keyword">if</span> (<span class="local-variable">this</span>.isFinal) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Trying to overwrite a final value</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="local-variable">this</span>.isFinal = <span class="predefined-constant">true</span>;
        <span class="local-variable">this</span>.value = value;
    }

    <span class="annotation">@Only</span>(before = <span class="string"><span class="delimiter">&quot;</span><span class="content">isFinal</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> setVariable(T value) {
        <span class="keyword">if</span> (<span class="local-variable">this</span>.isFinal) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Value is already final</span><span class="delimiter">&quot;</span></span>);
        <span class="local-variable">this</span>.value = value;
    }

    <span class="annotation">@TestMark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">isFinal</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">boolean</span> isFinal() {
        <span class="keyword">return</span> isFinal;
    }

    <span class="annotation">@TestMark</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">isFinal</span><span class="delimiter">&quot;</span></span>, before = <span class="predefined-constant">true</span>)
    <span class="directive">public</span> <span class="type">boolean</span> isVariable() {
        <span class="keyword">return</span> !isFinal;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s also an example of a negated  <code>@TestMark</code>  annotation: <code>isVariable</code> return the negation of the normal <code>iFinal</code> mark test.</p>
</div>
</div>
<div class="sect2">
<h3 id="support-freezable">12.4. Freezable</h3>
<div class="paragraph">
<p>The previous support class, <code>EventuallyFinal</code>, forms the template for a more general approach to eventual immutability:
allow free modifications, until the type is <em>frozen</em> and no modifications can be allowed anymore.</p>
</div>
<div class="listingblock">
<div class="title">Code fragment: Freezable</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">Freezable</span> {

    <span class="annotation">@Final</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="directive">volatile</span> <span class="type">boolean</span> frozen;

    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> freeze() {
        ensureNotFrozen();
        frozen = <span class="predefined-constant">true</span>;
    }

    <span class="annotation">@TestMark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">boolean</span> isFrozen() {
        <span class="keyword">return</span> frozen;
    }

    <span class="directive">private</span> <span class="type">boolean</span> ensureNotFrozen<span class="error">$</span>Precondition() { <span class="keyword">return</span> !frozen; } <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> <span class="type">void</span> ensureNotFrozen() {
        <span class="keyword">if</span> (frozen) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Already frozen!</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">private</span> <span class="type">boolean</span> ensureFrozen<span class="error">$</span>Precondition() { <span class="keyword">return</span> frozen; } <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> <span class="type">void</span> ensureFrozen() {
        <span class="keyword">if</span> (!frozen) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Not yet frozen!</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This companion method is present in the code to validate the computation of the precondition.
See <a href="#preconditions-and-instance-state">Preconditions and instance state</a> for more details.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that as discussed in <a href="#inheritance">Inheritance</a>, it is important for <code>Freezable</code>, as an abstract class, to be level 2 immutable:
derived classes can only go <em>down</em> the immutability scale, not up!</p>
</div>
</div>
<div class="sect2">
<h3 id="support-setoncemap">12.5. SetOnceMap</h3>
<div class="paragraph">
<p>We&#8217;ll show one example that depends on <code>Freezable</code>: a freezable map where no objects can be overwritten:</p>
</div>
<div class="listingblock">
<div class="title">Code fragment: part of SetOnceMap</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SetOnceMap</span>&lt;K, V&gt; <span class="directive">extends</span> Freezable {

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Map</span>&lt;K, V&gt; map = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();

    <span class="annotation">@Only</span>(before = <span class="string"><span class="delimiter">&quot;</span><span class="content">frozen</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> put(<span class="annotation">@NotNull</span> K k, <span class="annotation">@NotNull</span> V v) {
        Objects.requireNonNull(k);
        Objects.requireNonNull(v);
        ensureNotFrozen();
        <span class="keyword">if</span> (isSet(k)) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Already decided on </span><span class="delimiter">&quot;</span></span> + k + <span class="string"><span class="delimiter">&quot;</span><span class="content">: have </span><span class="delimiter">&quot;</span></span> +
                get(k) + <span class="string"><span class="delimiter">&quot;</span><span class="content">, want to write </span><span class="delimiter">&quot;</span></span> + v);
        }
        map.put(k, v);
    }

    <span class="annotation">@NotNull</span>
    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> V get(K k) {
        <span class="keyword">if</span> (!isSet(k)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Not yet decided on </span><span class="delimiter">&quot;</span></span> + k);
        <span class="keyword">return</span> Objects.requireNonNull(map.get(k)); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span class="directive">public</span> <span class="type">boolean</span> isSet(K k) {
        <span class="keyword">return</span> map.containsKey(k);
    }

    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The analyser will warn a potential null pointer exception here, not (yet) making the connection between
<code>isSet</code> and <code>containsKey</code>.
This connection can be implemented using the techniques described in <a href="#preconditions-and-instance-state">Preconditions and instance state</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The code analyser makes frequent use of this type, often with an additional guard that allows repeatedly putting the same value to a key.</p>
</div>
</div>
<div class="sect2">
<h3 id="support-lazy">12.6. Lazy</h3>
<div class="paragraph">
<p><code>Lazy</code> implements a lazily-initialized immutable field, of unbound generic type <code>T</code>.
As such, it is eventually a level 2 immutable type.</p>
</div>
<div class="listingblock">
<div class="title">Code fragment: Lazy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.e2immu.analyser.util</span>;

<span class="keyword">import</span> <span class="include">org.e2immu.annotation</span>.*;
<span class="keyword">import</span> <span class="include">java.util.Objects</span>;
<span class="keyword">import</span> <span class="include">java.util.function.Supplier</span>;

<span class="annotation">@E2Container</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Lazy</span>&lt;T&gt; {

    <span class="annotation">@NotNull1</span> <span class="annotation">@PropagateModification</span> <span class="annotation">@Dependent1</span>
    <span class="directive">private</span> <span class="directive">final</span> Supplier&lt;T&gt; supplier;

    <span class="annotation">@Final</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="directive">volatile</span> T t;

    <span class="directive">public</span> Lazy(<span class="annotation">@NotNull1</span> <span class="annotation">@PropagateModification</span> <span class="annotation">@Dependent1</span> Supplier&lt;T&gt; supplier) { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="local-variable">this</span>.supplier = supplier;
    }

    <span class="annotation">@NotNull</span>
    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">public</span> T get() {
        <span class="keyword">if</span> (t != <span class="predefined-constant">null</span>) <span class="keyword">return</span> t;
        t = Objects.requireNonNull(supplier.get()); <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="keyword">return</span> t;
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="type">boolean</span> hasBeenEvaluated() {
        <span class="keyword">return</span> t != <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The  <code>@PropagateModification</code>  annotation has travelled from the field to the parameter;
so has  <code>@Dependent1</code> .</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The  <code>@Mark</code>  annotation is conditional; the transition is triggered by nullity of <code>t</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here <code>t</code> content links to <code>supplier</code>, as explained in <a href="#content-linking">Content linking</a>.
The statement also causes the  <code>@NotNull1</code>  annotation, as defined in <a href="#nullable-section">Nullable, not null</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After calling the marker method <code>get()</code>, <code>t</code> cannot be assigned anymore, and it becomes  <code>@Final</code> .
Because it is of an unbound generic type, it is  <code>@NotModified</code>, as is the field <code>supplier</code>.
Level 2 immutability rules 2 and 3 do not apply for either fields.</p>
</div>
</div>
<div class="sect2">
<h3 id="support-firstthen">12.7. FirstThen</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.e2immu.analyser.util</span>;

<span class="keyword">import</span> <span class="include">org.e2immu.annotation</span>.*;
<span class="keyword">import</span> <span class="include">java.util.Objects</span>;

<span class="annotation">@E2Container</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">mark</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">FirstThen</span>&lt;S, T&gt; {
    <span class="directive">private</span> <span class="directive">volatile</span> S first;
    <span class="directive">private</span> <span class="directive">volatile</span> T then;

    <span class="directive">public</span> FirstThen(<span class="annotation">@NotNull</span> S first) {
        <span class="local-variable">this</span>.first = Objects.requireNonNull(first);
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="type">boolean</span> isFirst() {
        <span class="keyword">return</span> first != <span class="predefined-constant">null</span>;
    }

    <span class="annotation">@NotModified</span>
    <span class="directive">public</span> <span class="type">boolean</span> isSet() {
        <span class="keyword">return</span> first == <span class="predefined-constant">null</span>;
    }

    <span class="annotation">@Mark</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">mark</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> set(<span class="annotation">@NotNull</span> T then) {
        Objects.requireNonNull(then);
        <span class="directive">synchronized</span> (<span class="local-variable">this</span>) {
            <span class="keyword">if</span> (first == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Already set</span><span class="delimiter">&quot;</span></span>);
            <span class="local-variable">this</span>.then = then;
            first = <span class="predefined-constant">null</span>;
        }
    }

    <span class="annotation">@NotNull</span> <span class="annotation">@NotModified</span> <span class="annotation">@Only</span>(before = <span class="string"><span class="delimiter">&quot;</span><span class="content">mark</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> S getFirst() {
        <span class="keyword">if</span> (first == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Then has been set</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
        S s = first;
        <span class="keyword">if</span> (s == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
        <span class="keyword">return</span> s;
    }

    <span class="annotation">@NotNull</span> <span class="annotation">@NotModified</span> <span class="annotation">@Only</span>(after = <span class="string"><span class="delimiter">&quot;</span><span class="content">mark</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> T get() {
        <span class="keyword">if</span> (first != <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Not yet set</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="2"></i><b>(2)</b>
        T t = then;
        <span class="keyword">if</span> (t == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
        <span class="keyword">return</span> t;
    }

    <span class="annotation">@Override</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="annotation">@Nullable</span> <span class="predefined-type">Object</span> o) {
        <span class="keyword">if</span> (<span class="local-variable">this</span> == o) <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        <span class="keyword">if</span> (o == <span class="predefined-constant">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        FirstThen&lt;?, ?&gt; firstThen = (FirstThen&lt;?, ?&gt;) o;
        <span class="keyword">return</span> Objects.equals(first, firstThen.first) &amp;&amp;
                Objects.equals(then, firstThen.then);
    }

    <span class="annotation">@Override</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">public</span> <span class="type">int</span> hashCode() {
        <span class="keyword">return</span> Objects.hash(first, then);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a bit convoluted.
The precondition is on the field <code>first</code>, and the current implementation of the precondition analyser requires an explicit check on the field.
Because this field is not final, we cannot assume that it is still null after the initial check; therefore, we assign it to a local variable, and do another null check to guarantee that the result that we return is <code>@NotNull</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Largely in line with the previous comment: we stick to the precondition on <code>first</code>, and have to check <code>then</code> to guarantee that the result is <code>@NotNull</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>equals</code> and <code>hashCode</code> methods inherit the  <code>@NotModified</code> annotation from <code>java.lang.Object</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that if we were to annotate the methods as contracts, rather than relying on the analyser to detect them, we could have a slightly more efficient implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="in-the-analyser">12.8. Support classes in the analyser</h3>
<div class="paragraph">
<p>Practice what you preach, and all that.
The  <em>e2immu</em>  analyser relies heavily on support classes such as <code>SetOnce</code>, and on the builder pattern described in the previous section.
Almost all public types are containers.
Because we intend to use the analyser&#8217;s code as a showcase for this project, one important class (<code>ExpressionContext</code>) was intentionally kept as a non-container.</p>
</div>
<div class="paragraph">
<p>A good example of our aim for eventual immutability is <code>TypeInfo</code>, the primary container holding a type.
Initially, a type is nothing but a reference, with a fully qualified name.
Source code or byte code inspection augments it with information about its methods and fields.
Whilst during inspection information is writable, after inspection this information becomes immutable.
We use the builder pattern for <code>TypeInspection</code>, using <code>TypeInspectionImpl.Builder</code> first and <code>TypeInspectionImpl</code> later.
The inspection information is stored using <code>SetOnce</code>:</p>
</div>
<div class="listingblock">
<div class="title">Parts of TypeInfo</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">TypeInfo</span> {
    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">String</span> fullyQualifiedName;
    <span class="directive">public</span> <span class="directive">final</span> SetOnce&lt;TypeInspection&gt; typeInspection = <span class="keyword">new</span> SetOnce&lt;&gt;();
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once inspection is over, the code analyser takes over.
Results are temporarily stored in <code>TypeAnalysisImpl.Builder</code>, then copied into the immutable <code>TypeAnalysisImpl</code> class.
Both classes implement the <code>TypeAnalysis</code> interface to shield off the build phase.
Once the immutable type is ready, it is stored in <code>TypeInfo</code>:</p>
</div>
<div class="listingblock">
<div class="title">Parts of TypeInfo, v2</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>(after=<span class="string"><span class="delimiter">&quot;</span><span class="content">typeAnalysis,typeInspection</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">TypeInfo</span> {
    <span class="directive">public</span> <span class="directive">final</span> <span class="predefined-type">String</span> fullyQualifiedName;

    <span class="directive">public</span> <span class="directive">final</span> SetOnce&lt;TypeInspection&gt; typeInspection = <span class="keyword">new</span> SetOnce&lt;&gt;();
    <span class="directive">public</span> <span class="directive">final</span> SetOnce&lt;TypeAnalysis&gt; typeAnalysis = <span class="keyword">new</span> SetOnce&lt;&gt;();

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this way, if we keep playing by the book recursively downward, <code>TypeInfo</code> will become an eventually level 2 immutable type.
Software engineers writing applications which use the  <em>e2immu</em>  analyser as a library, can feel secure that once the analysis phase is over, all the inspected and analysed information remains stable.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_annotations">13. Other annotations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The  <em>e2immu</em>  project defines a whole host of annotations complementary to the ones required for immutability.
We discuss them briefly, and refer to the user manual for an in-depth analysis.</p>
</div>
<div class="sect2">
<h3 id="nullable-section">13.1. Nullable, not null</h3>
<div class="paragraph">
<p>Nullability is a standard static code analyser topic, which we approach from a computational side: the analyser infers where possible, the user adds annotations to abstract methods.
The complement of not-null (marked  <code>@NotNull</code> ) is nullable (marked  <code>@Nullable</code> ).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A method marked  <code>@NotNull</code>  will never return a null result.
This is very standard.</p>
</li>
<li>
<p>Calling a parameter marked  <code>@NotNull</code>  will result in a null pointer exception at some point during the object life-cycle.</p>
</li>
<li>
<p>A  <code>@NotNull</code>  or  <code>@Nullable</code>  annotation on a field is a consequence of nullability computations on the assignments to the field.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To be able to compute the nullability of parameters, we must specify some sort of flow or direction to break chicken-and-egg situations.
We compute in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>context nullability of parameters.</p>
</li>
<li>
<p>field nullability</p>
</li>
<li>
<p>external nullability of parameters linked to fields</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>First, we examine the parameter&#8217;s usage in the method.
Its occurrence in a not-null context directly influences the nullability of the parameter.</p>
</div>
<div class="sect3">
<h4 id="_higher_order_nullability">13.1.1. Higher order nullability</h4>
<div class="paragraph">
<p>We use the annotation  <code>@NotNull1</code>  to indicate that none of the object&#8217;s fields can be null.
This concept is useful when working with collections.</p>
</div>
<div class="paragraph">
<p>Consider the following nullability annotations on the <code>List</code> API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> add(<span class="annotation">@NotNull</span> E e);
<span class="type">boolean</span> addAll(<span class="annotation">@NotNull1</span> <span class="predefined-type">Collection</span>&lt;? <span class="directive">extends</span> E&gt; collection);
<span class="annotation">@NotNull1</span> <span class="directive">static</span> &lt;E&gt; <span class="predefined-type">List</span>&lt;E&gt; copyOf(<span class="annotation">@NotNull1</span> <span class="predefined-type">Collection</span>&lt;? <span class="directive">extends</span> E&gt; collection);
<span class="annotation">@NotNull1</span> <span class="predefined-type">Iterator</span>&lt;E&gt; iterator();</code></pre>
</div>
</div>
<div class="paragraph">
<p>They effectively block the use of null elements in the collection.
As a consequence, looping over the elements will not give potential null pointer warnings.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is purely an opinion: we&#8217;d rather not use null as elements of a collection.
You are free to annotate differently!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Higher orders are possible as well.
A second level is useful when working with entry sets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">V put(<span class="annotation">@NotNull</span> K key, <span class="annotation">@NotNull</span> V value);
<span class="annotation">@NotNull</span> <span class="directive">static</span> &lt;K, V&gt; <span class="predefined-type">Map</span>&lt;K, V&gt; copyOf(<span class="annotation">@NotNull</span> <span class="predefined-type">Map</span>&lt;? <span class="directive">extends</span> K, ? <span class="directive">extends</span> V&gt; map);
<span class="annotation">@NotNull2</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Map</span>.Entry&lt;K, V&gt;&gt; entrySet();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how the map copy is only  <code>@NotNull</code> , while the entry set is not null, the entries in this set are not null, and the keys and values are neither.</p>
</div>
<div class="paragraph">
<p>We do not plan to go beyond  <code>@NotNull2</code> , however.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="identity-and-fluent">13.2. Identity and fluent methods</h3>
<div class="paragraph">
<p>The analyser marks methods which returns their first parameter with <code>@Identity</code>, and methods which return <code>this</code> with <code>@Fluent</code>.
The former are convenient to introduce preconditions, the latter occur frequently when chaining methods in builders.
Here is an integrated example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Container</span>(builds=<span class="predefined-type">Set</span>.class)
<span class="type">class</span> <span class="class">Builder</span> {
    <span class="annotation">@NotNull</span> <span class="annotation">@NotModified</span> <span class="annotation">@Identity</span>
    <span class="directive">private</span> <span class="directive">static</span> &lt;T&gt; T requireNonNull(<span class="annotation">@NotNull</span> T t) {
        <span class="keyword">if</span>(t == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
        <span class="keyword">return</span> t;
    }

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; list = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="annotation">@Fluent</span>
    <span class="directive">public</span> Builder add(<span class="annotation">@NotNull</span> <span class="predefined-type">String</span> s) {
        list.add(requireNonNull(s));
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="annotation">@Fluent</span>
    <span class="directive">public</span> Builder add(<span class="type">int</span> i) {
        list.add(<span class="predefined-type">Integer</span>.toString(i));
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="annotation">@E2Container</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; build() {
        <span class="keyword">return</span> <span class="predefined-type">List</span>.copyOf(list);
    }

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; one23 = <span class="keyword">new</span> Builder().add(<span class="integer">1</span>).add(<span class="integer">2</span>).add(<span class="integer">3</span>).add(<span class="string"><span class="delimiter">&quot;</span><span class="content">go</span><span class="delimiter">&quot;</span></span>).build();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="finalizers">13.3. Finalizers</h3>
<div class="paragraph">
<p>Up to now, we have focused on the distinction between the building phase of an object&#8217;s life-cycle, and its subsequent immutable phase.
We have ignored the destruction of objects: critically important for some applications, but often completely ignored by Java programmers because of the silent background presence of the garbage collector.
In this section we introduce an annotation,  <code>@Finalizer</code> , with the goal of being able to mark that calling a certain method means that the object has reached the end of its life-cycle:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Once a method marked  <code>@Finalizer</code>  has been called, no other methods may be subsequently applied.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Why is this useful?
The most obvious use-case for immutability is the meaning of the <code>build()</code> method in a builder: can you call it once, or is the builder somehow incremental?</p>
</div>
<div class="paragraph">
<p>How can the analyser enforce the sequence of method calling on an object?
The simplest way is by some severe restrictions:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>The following need to be true at all times when using types with finalizer methods:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Any field of a type with finalizers must be effectively final (marked with  <code>@Final</code> ).</p>
</li>
<li>
<p>A finalizer method can only be called on a field inside a method which is marked as a finalizer as well.</p>
</li>
<li>
<p>A finalizer method can never be called on a parameter or any variable linked to it, with linking as defined throughout this document (see <a href="#linking-and-independence">Linking and independence</a>).</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Interestingly, these restrictions are such that they help you control the life-cycle of objects with a  <code>@Finalizer</code> , by not letting them out of sight.</p>
</div>
<div class="paragraph">
<p>Let us start from the following example, using <a href="#support-eventuallyfinal">EventuallyFinal</a>:</p>
</div>
<div class="listingblock">
<div class="title">Example of a type with a finalizer method</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">ExampleWithFinalizer</span> {
    <span class="annotation">@BeforeMark</span>
    <span class="directive">private</span> <span class="directive">final</span> EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; data = <span class="keyword">new</span> EventuallyFinal&lt;&gt;();

    <span class="annotation">@Fluent</span>
    <span class="directive">public</span> ExampleWithFinalizer set(<span class="predefined-type">String</span> string) {
        data.setVariable(string);
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="annotation">@Fluent</span>
    <span class="directive">public</span> ExampleWithFinalizer doSomething() {
        <span class="predefined-type">System</span>.out.println(data.toString());
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="annotation">@Finalizer</span>(contract = <span class="predefined-constant">true</span>)
    <span class="annotation">@BeforeMark</span>
    <span class="directive">public</span> EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; getData() {
        <span class="keyword">return</span> data;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using  <code>@Fluent</code>  methods to go from construction to finalizer is definitely allowed according to the rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>
<span class="directive">public</span> <span class="directive">static</span> EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; fluent() {
    EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; d = <span class="keyword">new</span> ExampleWithFinalizer()
        .set(<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>).doSomething().set(<span class="string"><span class="delimiter">&quot;</span><span class="content">b</span><span class="delimiter">&quot;</span></span>).doSomething().getData();
    d.setFinal(<span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> d;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Passing on these objects as arguments is permitted, but the recipient should not call the finalizer.
Actually, given our strong preference for containers, the recipient should not even modify the object!
Consider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@E2Container</span>
<span class="directive">public</span> <span class="directive">static</span> EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; stepWise() {
    ExampleWithFinalizer ex = <span class="keyword">new</span> ExampleWithFinalizer();
    ex.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>);
    ex.doSomething();
    ex.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">b</span><span class="delimiter">&quot;</span></span>);
    doSthElse(ex); <i class="conum" data-value="1"></i><b>(1)</b>
    EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; d = ex.getData();
    d.setFinal(<span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span> d;
}

<span class="directive">private</span> <span class="directive">static</span> <span class="type">void</span> doSthElse(<span class="annotation">@NotModified</span> ExampleWithFinalizer ex) {
    ex.doSomething(); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>here we pass on the object</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>forbidden to call the finalizer; other methods allowed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Rules 1 and 2 allow you to store a finalizer type inside a field, but only when finalization is attached to the destruction of the holding type.
Examples follow immediately, in the context of the  <code>@BeforeMark</code>  annotation.</p>
</div>
<div class="sect3">
<h4 id="_processors_and_finishers">13.3.1. Processors and finishers</h4>
<div class="paragraph">
<p>It is worth observing that finalizers play well with the  <code>@BeforeMark</code>  annotation.
They allow us to introduce the concepts of <em>processors</em> and <em>finishers</em> for eventually immutable types in their <em>before</em> state.</p>
</div>
<div class="paragraph">
<p>The purpose of a <em>processor</em> is to receive an object in the  <code>@BeforeMark</code>  state, hold it, use a lot of temporary data in the meantime, and then release it again, modified but still in the  <code>@BeforeMark</code>  state.</p>
</div>
<div class="listingblock">
<div class="title">Conceptual example of processor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Processor</span> {
    <span class="directive">private</span> <span class="type">int</span> count; <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@BeforeMark</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> <span class="directive">final</span> EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; eventuallyFinal;

    <span class="directive">public</span> Processor(<span class="annotation">@BeforeMark</span> EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; eventuallyFinal) {
        <span class="local-variable">this</span>.eventuallyFinal = eventuallyFinal;
    }

    <span class="directive">public</span> <span class="type">void</span> set(<span class="predefined-type">String</span> s) { <i class="conum" data-value="3"></i><b>(3)</b>
        eventuallyFinal.setVariable(s);
        count++;
    }

    <span class="annotation">@Finalizer</span>(contract = <span class="predefined-constant">true</span>)
    <span class="annotation">@BeforeMark</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="directive">public</span> EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; done(<span class="predefined-type">String</span> last) {
        eventuallyFinal.setVariable(last + <span class="string"><span class="delimiter">&quot;</span><span class="content">; tried </span><span class="delimiter">&quot;</span></span> + count);
        <span class="keyword">return</span> eventuallyFinal;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>symbolises the temporary data to be destroyed after processing</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the field is private, not passed on, no  <code>@Mark</code>  method is called on it, and it is exposed only in a  <code>@Finalizer</code> </td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>symbolises the modifications that act as processing</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>the result of processing: an eventually immutable object in the same initial state.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The purpose of a <em>finisher</em> is to receive an object in the  <code>@BeforeMark</code>  state, and return it in the final state.
In the meantime, it gets modified (finished), while there is other temporary data around.
Once the final state is reached, the analyser guarantees that the temporary data is destroyed by severely limiting the scope of the finisher object.</p>
</div>
<div class="listingblock">
<div class="title">Conceptual example of finisher</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Finisher</span> {
    <span class="directive">private</span> <span class="type">int</span> count; <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@BeforeMark</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">private</span> <span class="directive">final</span> EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; eventuallyFinal;

    <span class="directive">public</span> Finisher(<span class="annotation">@BeforeMark</span> EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; eventuallyFinal) {
        <span class="local-variable">this</span>.eventuallyFinal = eventuallyFinal;
    }

    <span class="annotation">@Modified</span>
    <span class="directive">public</span> <span class="type">void</span> set(<span class="predefined-type">String</span> s) { <i class="conum" data-value="3"></i><b>(3)</b>
        eventuallyFinal.setVariable(s);
        count++;
    }

    <span class="annotation">@Finalizer</span>(contract = <span class="predefined-constant">true</span>)
    <span class="annotation">@E2Container</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="directive">public</span> EventuallyFinal&lt;<span class="predefined-type">String</span>&gt; done(<span class="predefined-type">String</span> last) {
        eventuallyFinal.setFinal(last + <span class="string"><span class="delimiter">&quot;</span><span class="content">; tried </span><span class="delimiter">&quot;</span></span> + count);
        <span class="keyword">return</span> eventuallyFinal;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>symbolises the temporary data to be destroyed.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>only possible because the transition occurs in a  <code>@Finalizer</code>  method</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>symbolises the modifications that act as finishing</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>the result of finishing: an eventually immutable object in its end-state.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_utility_class_extensions_singleton">13.4. Utility class, extensions, singleton</h3>
<div class="paragraph">
<p>Using the simple and common definition:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition</strong>: a <strong>utility class</strong> is a level 2 immutable class which cannot be instantiated.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>These definitions imply</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a utility class has no non-static fields,</p>
</li>
<li>
<p>it has a single, private, unused constructor,</p>
</li>
<li>
<p>and its static fields (if it has any) are sufficiently immutable.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In Java, many classes cannot easily be extended.
Implementations of extensions typically use a utility class with the convention that the first parameter of the static method is the object of the extended method call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Extension</span>(of=<span class="predefined-type">String</span><span class="type">[]</span>.class)
<span class="type">class</span> <span class="class">ExtendString</span> {
    <span class="directive">private</span> ExtendString() { <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>(); }

    <span class="directive">public</span> <span class="directive">static</span> <span class="predefined-type">String</span> weave(<span class="annotation">@NotModified</span> <span class="predefined-type">String</span><span class="type">[]</span> strings) {
        <span class="comment">// generate a new string by weaving the given strings (concat 1st chars, etc.)</span>
    }

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> appendEach(<span class="annotation">@Modified</span> <span class="predefined-type">String</span><span class="type">[]</span> strings, <span class="predefined-type">String</span> append) {
        <span class="comment">// append the parameter 'append' to each of the strings in the array</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use the following criteria to designate a utility class as an extension:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Definition</strong>:</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Static classes can be used to 'extend' closed types, as promoted by the Xtend project.
Level 2 immutable classes can also play the role of extension facilitators, with the additional benefit of having some immutable data to be used as a context.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preconditions-and-instance-state">14. Preconditions and instance state</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The  <em>e2immu</em>  analyser needs pretty strong support for determining preconditions on methods to be able to compute eventual immutability.
A lot of the mechanics involved can be harnessed in other ways as well, for example, to detect common mistakes in the use of collection classes.</p>
</div>
<div class="paragraph">
<p>We have implemented a system where the value of a variable can be augmented with <em>instance state</em> each time a method operates on the variable.
In the case of Java collections and <code>StringBuilder</code>, size-based instance state is low-hanging fruit.
Let&#8217;s start with an example:</p>
</div>
<div class="listingblock">
<div class="title">Creating an empty list</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; list = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
<span class="keyword">if</span> (list.size() &gt; <span class="integer">0</span>) { <span class="comment">// WARNING: evaluates to constant</span>
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When creating a new <code>ArrayList</code> using the empty constructor, we can store in the variable&#8217;s value that its size is 0.
First, let us look at the annotations for the <code>size</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Annotations of List.size</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> size<span class="error">$</span>Aspect<span class="error">$</span>Size() {}
<span class="type">boolean</span> size<span class="error">$</span>Invariant<span class="error">$</span>Size(<span class="type">int</span> i) { <span class="keyword">return</span> i &gt;= <span class="integer">0</span>; }
<span class="annotation">@NotModified</span>
<span class="type">int</span> size() { <span class="keyword">return</span> <span class="integer">0</span>; }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method has two <em>companion methods</em>.
The first registers <code>Size</code> as a numeric <em>aspect</em> linked to the <code>size</code> method.
The second adds an invariant (an assertion that is always true) in relation to the aspect: the size is never negative.</p>
</div>
<div class="paragraph">
<p>Looking at the annotations for the empty constructor,</p>
</div>
<div class="listingblock">
<div class="title">Annotations of empty ArrayList constructor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> <span class="predefined-type">ArrayList</span><span class="error">$</span>Modification<span class="error">$</span>Size(<span class="type">int</span> post) { <span class="keyword">return</span> post == <span class="integer">0</span>; }
<span class="directive">public</span> <span class="predefined-type">ArrayList</span><span class="error">$</span>() { }</code></pre>
</div>
</div>
<div class="paragraph">
<p>we see another companion method, that expresses the effect of the construction in terms of the <code>Size</code> aspect.
(The dollar sign at the end of the constructor is an artifact of the annotated API system; please refer to the  <em>e2immu</em>  manual.) Internally, we represent the value of <code>list</code> after the assignment as</p>
</div>
<div class="listingblock">
<div class="title">Internal representation of an empty list</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;()<span class="comment">/*0==this.size()*/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression in the companion results in the fact that the <code>Size</code> aspect post-modification is 0.
This then gets added to the evaluation state, which allows the analyser to conclude that the expression in the if-statement is a constant true.</p>
</div>
<div class="paragraph">
<p>This approach is sufficiently strong to catch a number of common problems when working with collections.
After adding one element to the empty list, as in:</p>
</div>
<div class="listingblock">
<div class="title">Adding an element to an empty list</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; list = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
list.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>the value of <code>list</code> becomes</p>
</div>
<div class="listingblock">
<div class="title">Internal representation after adding an element</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">instance type <span class="predefined-type">ArrayList</span>&lt;<span class="predefined-type">String</span>&gt;<span class="comment">/*this.contains(&quot;a&quot;)&amp;&amp;1==this.size()*/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The boolean expression in the comments is added to the evaluation state, so that expressions such as <code>list.isEmpty()</code>, defined as:</p>
</div>
<div class="listingblock">
<div class="title">List.isEmpty and its companion method</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> isEmpty<span class="error">$</span>Value<span class="error">$</span>Size(<span class="type">int</span> i, <span class="type">boolean</span> retVal) { <span class="keyword">return</span> i == <span class="integer">0</span>; }
<span class="annotation">@NotModified</span>
<span class="type">boolean</span> isEmpty() { <span class="keyword">return</span> <span class="predefined-constant">true</span>; }</code></pre>
</div>
</div>
<div class="paragraph">
<p>can be evaluated by the analyser.
We refer to the manual for a more in-depth treatment of companion methods and instance state.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_copyright_and_license">15. Copyright and License</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Copyright &#169; 2020, 2021, Bart Naudts, <a href="https://www.e2immu.org" class="bare">https://www.e2immu.org</a></p>
</div>
<div class="paragraph">
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.
You should have received a copy of the GNU Lesser General Public License along with this program.  If not, see <a href="http://www.gnu.org/licenses/" class="bare">http://www.gnu.org/licenses/</a>.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-04-06 13:42:38 +0200
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</body>
</html>